<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最优化决策实验室</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\(', '\)']],
                displayMath: [['$$', '$$'], ['\[', '\]']],
                processEscapes: true
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax加载完成');
                    });
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --primary-light: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #1f2937;
            --white: #ffffff;
            --border: #e5e7eb;
            --h1-size: 22px;
            --h3-size: 18px;
            --text-size: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }

        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
            font-size: var(--text-size);
            line-height: 1.5;
            background: var(--gray-50);
            color: var(--gray-700);
        }

        .container {
            width: 100%;
            max-width: 1400px;
            height: min(100vh, 700px);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        .header {
            height: 40px;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header h1 {
            font-size: var(--h1-size);
            font-weight: 600;
        }

        .header span {
            font-size: 14px;
            opacity: 0.9;
        }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 120px;
            background: var(--gray-50);
            border-right: 1px solid var(--border);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-btn {
            width: 100%;
            padding: 8px 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--gray-600);
            text-align: left;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .nav-btn:hover {
            background: var(--gray-100);
        }

        .nav-btn.active {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.28);
        }

        .content {
            flex: 1;
            background: var(--white);
        }

        .page-content {
            display: none;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 18px;
            padding: 16px;
            height: 100%;
        }

        .page-content.active {
            display: grid;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.06);
        }

        .card h3 {
            font-size: var(--h3-size);
            color: var(--primary-dark);
        }

        .card p {
            color: var(--gray-600);
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            background: var(--gray-100);
            color: var(--gray-500);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 13px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: var(--gray-50);
            border: 1px dashed var(--gray-200);
            border-radius: 10px;
            padding: 12px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-row label {
            font-weight: 600;
            color: var(--gray-600);
        }

        select {
            flex: 1;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
            font-size: 15px;
            color: var(--gray-700);
            background: var(--white);
        }

        input[type="range"],
        input[type="number"] {
            flex: 1;
        }

        input[type="number"] {
            max-width: 160px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
        }

        .action {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: var(--white);
            cursor: pointer;
            font-size: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .action.secondary {
            background: var(--white);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .action.ghost {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }

        .action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 10px 22px rgba(79, 70, 229, 0.18);
        }

        .status-box {
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            line-height: 1.5;
            background: #eef2ff;
            color: var(--primary-dark);
        }

        .status-box.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid rgba(217, 119, 6, 0.3);
        }

        .status-box.success {
            background: #ecfdf5;
            color: #047857;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .info-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .info-item strong {
            display: block;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }

        .canvas-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        canvas.lab-canvas {
            width: 100%;
            height: 240px;
            border-radius: 10px;
            background: var(--white);
            border: 1px solid var(--gray-200);
        }

        .legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 14px;
            color: var(--gray-500);
        }

        .legend span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .legend i {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th,
        td {
            border: 1px solid var(--gray-200);
            padding: 8px;
            text-align: center;
        }

        thead {
            background: var(--gray-100);
        }

        tbody tr.highlight {
            background: #eef2ff;
        }

        .practice-list {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }

        .practice-item {
            border: 1px dashed var(--gray-200);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 14px;
            background: var(--gray-50);
            color: var(--gray-600);
        }

        .hint-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .flow-step {
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 10px 12px;
            background: var(--gray-50);
            transition: background 0.2s ease, border 0.2s ease;
        }

        .flow-step h4 {
            font-size: 15px;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }

        .flow-step p {
            font-size: 14px;
            color: var(--gray-600);
        }

        .flow-step.active {
            background: #eef2ff;
            border-color: var(--primary);
        }

        .solver-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .solver-card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .solver-card strong {
            color: var(--primary-dark);
        }

        .result-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #dbeafe;
            color: #1d4ed8;
        }

        .case-list {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .case-card {
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 12px;
            background: var(--gray-50);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .case-card h4 {
            font-size: 16px;
            color: var(--primary-dark);
        }

        .case-card p {
            font-size: 14px;
            color: var(--gray-600);
        }

        @media (max-width: 1024px) {
            .page-content {
                grid-template-columns: 1fr;
            }

            .case-list,
            .practice-list,
            .solver-grid,
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>最优化决策实验室</h1>
            <span>利用导数构建模型、求解最优方案</span>
        </header>
        <div class="main">
            <nav class="sidebar">
                <button class="nav-btn active" data-target="section-model">建立模型</button>
                <button class="nav-btn" data-target="section-solve">动手求解</button>
                <button class="nav-btn" data-target="section-cases">应用案例库</button>
            </nav>
            <section class="content">
                <div class="page-content active" id="section-model">
                    <div class="column">
                        <div class="card">
                            <h3>实验导引</h3>
                            <p>最优化问题的核心是找到使目标函数达到最大或最小的决策变量值。本实验通过真实业务场景，展示如何建立模型、分析导数并做出最优决策。</p>
                            <div class="tag-list">
                                <span class="tag">目标函数</span>
                                <span class="tag">一阶导数</span>
                                <span class="tag">二阶判别</span>
                                <span class="tag">图像理解</span>
                            </div>
                            <div class="status-box" id="scenario-status">从左侧选择一个案例，系统会生成对应的函数图像与关键数据。</div>
                        </div>
                        <div class="card">
                            <h3>参数选择与动态观察</h3>
                            <div class="controls">
                                <div class="control-row">
                                    <label for="scenario-select">应用场景：</label>
                                    <select id="scenario-select"></select>
                                </div>
                                <div class="control-row">
                                    <label>决策变量 $x$：</label>
                                    <span class="result-badge">当前值：<span id="slider-value">0.00</span></span>
                                </div>
                                <input type="range" id="model-slider" min="0" max="10" step="0.1" value="0">
                                <div class="control-row">
                                    <button class="action" id="play-flow">按流程演示</button>
                                    <button class="action secondary" id="reset-model">恢复默认</button>
                                </div>
                            </div>
                            <div class="hint-list">
                                <span>• 拖动滑块模拟不同决策，利润/成本随即更新。</span>
                                <span>• 点击“按流程演示”观看从模型建立到最优验证的关键步骤。</span>
                                <span>• 表格自动列出典型取值，方便比较收益或成本。</span>
                            </div>
                        </div>
                        <div class="card">
                            <h3>建模流程记录</h3>
                            <div class="flow-container" id="model-flow"></div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>函数与导数图像</h3>
                            <div class="canvas-wrapper">
                                <canvas class="lab-canvas" id="function-canvas" width="520" height="240"></canvas>
                                <canvas class="lab-canvas" id="derivative-canvas" width="520" height="220"></canvas>
                            </div>
                            <div class="legend">
                                <span><i style="background:#4f46e5"></i> 目标函数 $f(x)$</span>
                                <span><i style="background:#fb923c"></i> 导数 $f'(x)$</span>
                                <span><i style="background:#22c55e"></i> 关键点/最优值</span>
                            </div>
                        </div>
                        <div class="card">
                            <h3>关键数值表</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>$x$</th>
                                        <th>$f(x)$</th>
                                        <th>$f'(x)$</th>
                                        <th>斜率判断</th>
                                    </tr>
                                </thead>
                                <tbody id="value-table"></tbody>
                            </table>
                            <div class="status-box" id="value-status">查看导数符号的变化，判断最优解附近的单调性。</div>
                        </div>
                        <div class="card">
                            <h3>课堂练习</h3>
                            <div class="practice-list" id="practice-list"></div>
                        </div>
                    </div>
                </div>

                <div class="page-content" id="section-solve">
                    <div class="column">
                        <div class="card">
                            <h3>求解策略</h3>
                            <p id="solve-description">请选择案例后查看对应的最优化方程与判别方法。</p>
                            <div class="status-box" id="solve-summary">一阶导数等于零定位候选点，再利用二阶导数或单调区间确认最优性。</div>
                        </div>
                        <div class="card">
                            <h3>一阶/二阶判别</h3>
                            <div class="solver-grid">
                                <div class="solver-card">
                                    <strong>一阶导数方程</strong>
                                    <span id="solve-first">$f'(x)=0$</span>
                                </div>
                                <div class="solver-card">
                                    <strong>二阶导数</strong>
                                    <span id="solve-second">$f''(x)$</span>
                                </div>
                                <div class="solver-card">
                                    <strong>单调性分析</strong>
                                    <span id="solve-intervals">---</span>
                                </div>
                                <div class="solver-card">
                                    <strong>最优值结论</strong>
                                    <span id="solve-conclusion">---</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>自己算一算</h3>
                            <div class="controls">
                                <div class="control-row">
                                    <label for="answer-input">猜测最优 $x$：</label>
                                    <input type="number" id="answer-input" step="0.01" placeholder="请输入">
                                </div>
                                <div class="control-row">
                                    <button class="action" id="check-answer">验证答案</button>
                                    <button class="action ghost" id="show-answer">显示参考</button>
                                </div>
                            </div>
                            <div class="status-box" id="answer-status">试着根据导数符号判断最优点，再输入你的答案。</div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>推导流程复盘</h3>
                            <div class="flow-container" id="solve-flow"></div>
                        </div>
                        <div class="card">
                            <h3>商业解读</h3>
                            <div class="info-grid" id="business-highlights"></div>
                        </div>
                    </div>
                </div>

                <div class="page-content" id="section-cases">
                    <div class="column">
                        <div class="card">
                            <h3>案例概览</h3>
                            <p>这些案例覆盖利润最大化、成本最小化与资源投放规划等典型问题。比较不同模型如何利用导数得到最优策略。</p>
                            <div class="status-box success">善用导数符号与二阶信息，可以更快确认最优解是否合理。</div>
                        </div>
                        <div class="card">
                            <h3>案例学习路径</h3>
                            <div class="flow-container" id="case-flow"></div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>案例详情</h3>
                            <div class="case-list" id="case-list"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const scenarios = [
            {
                id: 'factory',
                name: '工厂产量规划',
                type: 'max',
                units: '万元',
                variableLabel: '产量 x（百件）',
                description: '固定成本 32 万元，每百件产品贡献 24 万元收入，边际成本随产量增加。',
                formula: '$P(x) = -2x^2 + 24x - 32$',
                derivativeLatex: "$P'(x) = -4x + 24$",
                secondLatex: "$P''(x) = -4 < 0$",
                func: x => -2 * x * x + 24 * x - 32,
                derivative: x => -4 * x + 24,
                secondDerivative: () => -4,
                slider: { min: 0, max: 12, step: 0.1, start: 6 },
                domain: [0, 12],
                optimum: 6,
                optimumLabel: '最大利润',
                practices: [
                    '$\displaystyle \max P(x) = -2x^2 + 24x - 32$',
                    '若原料价格上涨使常数项变为 $-36$，最优 $x$ 是否改变？',
                    '利用二阶导数解释为什么 $x=6$ 是极大值。'
                ],
                samples: [0, 2, 4, 6, 8, 10, 12],
                flow: [
                    { title: '建立函数', detail: '将利润写成 $P(x) = 收入 - 成本$ 的形式。' },
                    { title: '求一阶导数', detail: '对 $P(x)$ 求导得到边际利润 $P'(x)$。' },
                    { title: '令导数为零', detail: '解方程 $P'(x)=0$ 得到候选解。' },
                    { title: '二阶导数判别', detail: '$P''(x)=-4<0$，说明出现极大值。', status: 'success' }
                ],
                solution: {
                    goal: '最大化利润 $P(x)$，找出最佳产量。',
                    first: '$P'(x) = -4x + 24 = 0 \Rightarrow x = 6$',
                    second: '$P''(x) = -4 < 0$，故为极大值。',
                    intervals: '$P'(x) > 0$ 当 $x<6$，$P'(x) < 0$ 当 $x>6$。',
                    conclusion: '当 $x=6$（生产 600 件）时利润约为 $40$ 万元，达到最大。',
                    highlights: [
                        { title: '边际利润含义', content: '生产每增加 100 件的额外收益会逐渐下降，导数为零意味着增加和减少都会降低利润。' },
                        { title: '生产约束', content: '若产线最大产能为 8（800 件），最优点仍在能力范围内，可直接执行。' }
                    ]
                }
            },
            {
                id: 'marketing',
                name: '广告投放回报',
                type: 'max',
                units: '万元',
                variableLabel: '投放天数 x',
                description: '广告投放收益呈指数递减，额外投放会带来成本。目标是找到最佳投放天数。',
                formula: '$R(x) = 120(1 - e^{-0.3x}) - 15x$',
                derivativeLatex: "$R'(x) = 36e^{-0.3x} - 15$",
                secondLatex: "$R''(x) = -10.8 e^{-0.3x} < 0$",
                func: x => 120 * (1 - Math.exp(-0.3 * x)) - 15 * x,
                derivative: x => 36 * Math.exp(-0.3 * x) - 15,
                secondDerivative: x => -10.8 * Math.exp(-0.3 * x),
                slider: { min: 0, max: 15, step: 0.1, start: 3 },
                domain: [0, 15],
                optimum: 2.92,
                optimumLabel: '最大回报',
                practices: [
                    '尝试推导 $R'(x) = 0$ 的解析解。',
                    '若每日投放成本上升到 18 万，应如何调整模型？',
                    '说明指数衰减为何导致二阶导数始终小于 0。'
                ],
                samples: [0, 1.5, 3, 4.5, 6, 9, 12],
                flow: [
                    { title: '确定目标', detail: '最大化净收益 $R(x)$，单位为万元。' },
                    { title: '求边际收益', detail: '求导得到 $R'(x)=36e^{-0.3x}-15$。' },
                    { title: '解方程', detail: '解 $R'(x)=0$，得到 $x \approx 2.92$。' },
                    { title: '验证合理性', detail: '二阶导数为负，且超过 3 天后收益下降。', status: 'info' }
                ],
                solution: {
                    goal: '在投放预算内获得最大回报。',
                    first: '$R'(x) = 36e^{-0.3x} - 15 = 0 \Rightarrow x \approx 2.92$',
                    second: '$R''(x) = -10.8 e^{-0.3x} < 0$，说明该点为极大值。',
                    intervals: '当 $x<2.92$ 时 $R'(x) > 0$；当 $x>2.92$ 时 $R'(x) < 0$。',
                    conclusion: '投放约 3 天可以获得最大净收益，收益约为 $R(2.92) \approx 58.2$ 万元。',
                    highlights: [
                        { title: '边际效用递减', content: '投放越久边际收益越低，过度投放会导致成本超过新增收益。' },
                        { title: '动态调整', content: '若市场反馈良好可延长投放，但需实时监控导数的正负变化。' }
                    ]
                }
            },
            {
                id: 'logistics',
                name: '物流配送成本',
                type: 'min',
                units: '万元',
                variableLabel: '配送批次 x',
                description: '批次越多单次运输成本下降，但总调度成本上升；需要找到成本最低的批次数。',
                formula: '$C(x) = 0.3x^2 + \dfrac{120}{x} + 20$',
                derivativeLatex: "$C'(x) = 0.6x - \dfrac{120}{x^2}$",
                secondLatex: "$C''(x) = 0.6 + \dfrac{240}{x^3} > 0$",
                func: x => 0.3 * x * x + 120 / x + 20,
                derivative: x => 0.6 * x - 120 / (x * x),
                secondDerivative: x => 0.6 + 240 / (x * x * x),
                slider: { min: 2, max: 12, step: 0.1, start: 5.8 },
                domain: [2, 12],
                optimum: Math.cbrt(200),
                optimumLabel: '最小成本',
                practices: [
                    '验证 $C'(x) = 0$ 解的立方根形式。',
                    '尝试用单调性而非二阶导数来判断最优性。',
                    '若每批固定成本下降，最优批次数如何变化？'
                ],
                samples: [2, 3.5, 5, 6, 7.5, 9, 11],
                flow: [
                    { title: '构建成本模型', detail: '将批次数与运输、调度成本综合成 $C(x)$。' },
                    { title: '求导数', detail: '得到边际成本 $C'(x) = 0.6x - 120/x^2$。' },
                    { title: '求临界点', detail: '解 $C'(x) = 0$，得到 $x = \sqrt[3]{200} \approx 5.85$。' },
                    { title: '判断极小值', detail: '二阶导数 $>0$，该点为极小值，成本最低。', status: 'success' }
                ],
                solution: {
                    goal: '在满足需求的同时使配送总成本最低。',
                    first: '$C'(x) = 0.6x - \dfrac{120}{x^2} = 0 \Rightarrow x = \sqrt[3]{200} \approx 5.85$',
                    second: '$C''(x) = 0.6 + \dfrac{240}{x^3} > 0$，因此得到极小值。',
                    intervals: '当 $x<5.85$ 时 $C'(x) < 0$；当 $x>5.85$ 时 $C'(x) > 0$。',
                    conclusion: '安排约 6 个批次运输，可将总成本控制在 $C(5.85) \approx 88.7$ 万元。',
                    highlights: [
                        { title: '灵活调度', content: '批次过少导致单次运输量过大、成本上升；过多则调度成本显著增加。' },
                        { title: '敏感性分析', content: '若油价上涨，可在模型中增加变量后再次求导，快速得到新的最优批次数。' }
                    ]
                }
            }
        ];

        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');
        const scenarioSelect = document.getElementById('scenario-select');
        const slider = document.getElementById('model-slider');
        const sliderValue = document.getElementById('slider-value');
        const scenarioStatus = document.getElementById('scenario-status');
        const modelFlow = document.getElementById('model-flow');
        const valueTable = document.getElementById('value-table');
        const valueStatus = document.getElementById('value-status');
        const practiceList = document.getElementById('practice-list');
        const functionCanvas = document.getElementById('function-canvas');
        const derivativeCanvas = document.getElementById('derivative-canvas');
        const playFlowBtn = document.getElementById('play-flow');
        const resetBtn = document.getElementById('reset-model');
        const solveDescription = document.getElementById('solve-description');
        const solveSummary = document.getElementById('solve-summary');
        const solveFirst = document.getElementById('solve-first');
        const solveSecond = document.getElementById('solve-second');
        const solveIntervals = document.getElementById('solve-intervals');
        const solveConclusion = document.getElementById('solve-conclusion');
        const solveFlow = document.getElementById('solve-flow');
        const businessHighlights = document.getElementById('business-highlights');
        const answerInput = document.getElementById('answer-input');
        const checkAnswerBtn = document.getElementById('check-answer');
        const showAnswerBtn = document.getElementById('show-answer');
        const answerStatus = document.getElementById('answer-status');
        const caseFlow = document.getElementById('case-flow');
        const caseList = document.getElementById('case-list');

        let currentScenario = scenarios[0];
        let playTimer = null;

        function formatNumber(value) {
            if (!Number.isFinite(value)) return '—';
            const abs = Math.abs(value);
            if (abs >= 1000) {
                return value.toFixed(0);
            }
            return value.toFixed(2);
        }

        function typeset() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        function populateScenarioOptions() {
            scenarioSelect.innerHTML = scenarios.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
        }

        function setSliderRange(config) {
            slider.min = config.min;
            slider.max = config.max;
            slider.step = config.step;
            slider.value = config.start;
        }

        function evaluateScenario(x) {
            const value = currentScenario.func(x);
            const derivative = currentScenario.derivative(x);
            const secondDerivative = currentScenario.secondDerivative(x);
            return { value, derivative, secondDerivative };
        }

        function buildFlow(container, steps) {
            container.innerHTML = '';
            steps.forEach((step, index) => {
                const element = document.createElement('div');
                element.className = 'flow-step';
                element.dataset.index = index;
                if (step.status === 'success') {
                    element.classList.add('success');
                }
                element.innerHTML = `
                    <h4>${step.title}</h4>
                    <p>${step.detail}</p>
                `;
                container.appendChild(element);
            });
        }

        function updatePractice(items) {
            practiceList.innerHTML = items.map(text => `<div class="practice-item">${text}</div>`).join('');
        }

        function updateValueTable() {
            const rows = currentScenario.samples.map(x => {
                const { value, derivative } = evaluateScenario(x);
                const sign = derivative > 0 ? '上升' : derivative < 0 ? '下降' : '临界';
                const trendIcon = derivative > 0 ? '📈' : derivative < 0 ? '📉' : '⚖️';
                return `
                    <tr data-x="${x}">
                        <td>${formatNumber(x)}</td>
                        <td>${formatNumber(value)}</td>
                        <td>${formatNumber(derivative)}</td>
                        <td>${trendIcon} ${sign}</td>
                    </tr>
                `;
            }).join('');
            valueTable.innerHTML = rows;
        }

        function highlightClosestRow(x) {
            const rows = valueTable.querySelectorAll('tr');
            let closestRow = null;
            let minDiff = Infinity;
            rows.forEach(row => {
                const rowX = parseFloat(row.dataset.x);
                const diff = Math.abs(rowX - x);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestRow = row;
                }
            });
            rows.forEach(row => row.classList.remove('highlight'));
            if (closestRow) {
                closestRow.classList.add('highlight');
            }
        }

        function drawAxes(ctx, domain, range, padding) {
            const { width, height } = ctx.canvas;
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.rect(padding, padding, width - 2 * padding, height - 2 * padding);
            ctx.stroke();

            const zeroY = range.max === range.min ? 0 : (0 - range.min) / (range.max - range.min);
            if (zeroY >= 0 && zeroY <= 1) {
                const y = padding + (1 - zeroY) * (height - 2 * padding);
                ctx.strokeStyle = '#e5e7eb';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            const zeroX = domain.max === domain.min ? 0 : (0 - domain.min) / (domain.max - domain.min);
            if (zeroX >= 0 && zeroX <= 1) {
                const x = padding + zeroX * (width - 2 * padding);
                ctx.strokeStyle = '#e5e7eb';
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();
            }
        }

        function getRange(fn, domain) {
            let min = Infinity;
            let max = -Infinity;
            for (let i = 0; i <= 200; i++) {
                const t = i / 200;
                const x = domain.min + t * (domain.max - domain.min);
                const value = fn(x);
                if (Number.isFinite(value)) {
                    min = Math.min(min, value);
                    max = Math.max(max, value);
                }
            }
            if (min === Infinity || max === -Infinity) {
                min = -1;
                max = 1;
            }
            if (Math.abs(max - min) < 1e-3) {
                max += 1;
                min -= 1;
            }
            const padding = (max - min) * 0.1;
            return { min: min - padding, max: max + padding };
        }

        function drawCurve(ctx, fn, domain, range, color) {
            const { width, height } = ctx.canvas;
            const padding = 40;
            drawAxes(ctx, domain, range, padding);

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            let started = false;
            for (let i = 0; i <= 200; i++) {
                const t = i / 200;
                const x = domain.min + t * (domain.max - domain.min);
                const y = fn(x);
                if (!Number.isFinite(y)) {
                    started = false;
                    continue;
                }
                const px = padding + t * (width - 2 * padding);
                const py = padding + (1 - (y - range.min) / (range.max - range.min)) * (height - 2 * padding);
                if (!started) {
                    ctx.moveTo(px, py);
                    started = true;
                } else {
                    ctx.lineTo(px, py);
                }
            }
            ctx.stroke();

            return padding;
        }

        function drawMarker(ctx, x, y, domain, range, color, padding) {
            const { width, height } = ctx.canvas;
            const px = padding + (x - domain.min) / (domain.max - domain.min) * (width - 2 * padding);
            const py = padding + (1 - (y - range.min) / (range.max - range.min)) * (height - 2 * padding);
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(px, py, 5, 0, Math.PI * 2);
            ctx.fill();
        }

        function updateCanvases() {
            const domain = { min: currentScenario.slider.min, max: currentScenario.slider.max };
            const valueRange = getRange(currentScenario.func, domain);
            const derivativeRange = getRange(currentScenario.derivative, domain);

            const valuePadding = drawCurve(functionCanvas.getContext('2d'), currentScenario.func, domain, valueRange, '#4f46e5');
            const derivativePadding = drawCurve(derivativeCanvas.getContext('2d'), currentScenario.derivative, domain, derivativeRange, '#fb923c');

            const optimumX = currentScenario.optimum;
            if (optimumX >= domain.min && optimumX <= domain.max) {
                const { value } = evaluateScenario(optimumX);
                drawMarker(functionCanvas.getContext('2d'), optimumX, value, domain, valueRange, '#22c55e', valuePadding);
                const derivativeValue = currentScenario.derivative(optimumX);
                drawMarker(derivativeCanvas.getContext('2d'), optimumX, derivativeValue, domain, derivativeRange, '#22c55e', derivativePadding);
            }
        }

        function updateScenarioStatus(x) {
            const { value, derivative } = evaluateScenario(x);
            const trend = derivative > 0 ? '收益正在上升' : derivative < 0 ? '收益正在下降' : '达到极值点';
            const unitText = currentScenario.units ? currentScenario.units : '';
            scenarioStatus.innerHTML = `当 $x=${formatNumber(x)}$ 时，目标函数 $f(x)=${formatNumber(value)}${unitText}$，导数 $f'(x)=${formatNumber(derivative)}$，${trend}。`;
            valueStatus.innerHTML = `${currentScenario.optimumLabel} 位于导数从 ${currentScenario.type === 'max' ? '正变负' : '负变正'} 的位置，观察表格可以验证这一变化。`;
            typeset();
        }

        function updateSolveSection() {
            const info = currentScenario.solution;
            solveDescription.innerHTML = info.goal;
            solveSummary.innerHTML = currentScenario.type === 'max'
                ? '导数从正变负说明达到最大值；若导数始终为负则不存在内部最优点。'
                : '导数从负变正说明达到最小值；若导数始终为正则最小值可能出现在边界。';
            solveFirst.innerHTML = info.first;
            solveSecond.innerHTML = info.second;
            solveIntervals.innerHTML = info.intervals;
            solveConclusion.innerHTML = info.conclusion;

            buildFlow(solveFlow, currentScenario.flow);

            businessHighlights.innerHTML = info.highlights.map(item => `
                <div class="info-item">
                    <strong>${item.title}</strong>
                    <p>${item.content}</p>
                </div>
            `).join('');

            typeset();
        }

        function updateCaseSection() {
            const steps = [
                { title: '识别目标', detail: '确认需要最大化收益还是最小化成本，并写出决策变量。' },
                { title: '函数建模', detail: '将收入、成本或约束统一成一个可导函数。' },
                { title: '导数分析', detail: '求一阶导数定位临界点，再用二阶或单调性检验最优性。' }
            ];
            buildFlow(caseFlow, steps);

            caseList.innerHTML = scenarios.map(item => `
                <div class="case-card">
                    <h4>${item.name}</h4>
                    <p>${item.description}</p>
                    <p>模型：${item.formula}</p>
                    <p>导数：${item.derivativeLatex}</p>
                </div>
            `).join('');
            typeset();
        }

        function updateScenario(id) {
            currentScenario = scenarios.find(item => item.id === id) || scenarios[0];
            setSliderRange(currentScenario.slider);
            sliderValue.textContent = formatNumber(parseFloat(slider.value));
            buildFlow(modelFlow, currentScenario.flow);
            updatePractice(currentScenario.practices);
            updateValueTable();
            updateCanvases();
            updateScenarioStatus(parseFloat(slider.value));
            updateSolveSection();
            highlightClosestRow(parseFloat(slider.value));
            typeset();
        }

        function handleSliderChange() {
            const value = parseFloat(slider.value);
            sliderValue.textContent = formatNumber(value);
            updateScenarioStatus(value);
            highlightClosestRow(value);
        }

        function playFlow() {
            if (playTimer) {
                clearInterval(playTimer);
            }
            const steps = modelFlow.querySelectorAll('.flow-step');
            steps.forEach(step => step.classList.remove('active'));
            let index = 0;
            playTimer = setInterval(() => {
                steps.forEach(step => step.classList.remove('active'));
                if (index < steps.length) {
                    steps[index].classList.add('active');
                    index += 1;
                } else {
                    clearInterval(playTimer);
                }
            }, 900);
        }

        function resetScenario() {
            setSliderRange(currentScenario.slider);
            sliderValue.textContent = formatNumber(parseFloat(slider.value));
            updateScenarioStatus(parseFloat(slider.value));
            highlightClosestRow(parseFloat(slider.value));
            updateCanvases();
        }

        function checkAnswer() {
            const userValue = parseFloat(answerInput.value);
            if (Number.isNaN(userValue)) {
                answerStatus.textContent = '请输入一个数值，再点击验证。';
                return;
            }
            const diff = Math.abs(userValue - currentScenario.optimum);
            const tolerance = Math.max(parseFloat(currentScenario.slider.step) * 1.5, 0.05);
            if (diff <= tolerance) {
                answerStatus.textContent = '✅ 判断正确！该值与系统计算的最优解十分接近。';
            } else if (diff <= tolerance * 3) {
                answerStatus.textContent = '⚠️ 已经接近最优解了，再结合导数符号细调一下。';
            } else {
                answerStatus.textContent = '❌ 结果偏差较大，检查是否正确解方程或考虑了边界。';
            }
        }

        function showAnswer() {
            const optimalValue = formatNumber(currentScenario.optimum);
            const { value } = evaluateScenario(currentScenario.optimum);
            answerStatus.innerHTML = `参考答案：$x \approx ${optimalValue}$，此时 $f(x) \approx ${formatNumber(value)}${currentScenario.units}$.`;
            typeset();
        }

        function bindEvents() {
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const target = button.dataset.target;
                    navButtons.forEach(btn => btn.classList.toggle('active', btn === button));
                    pages.forEach(page => page.classList.toggle('active', page.id === target));
                });
            });

            scenarioSelect.addEventListener('change', event => {
                updateScenario(event.target.value);
            });

            slider.addEventListener('input', handleSliderChange);
            playFlowBtn.addEventListener('click', playFlow);
            resetBtn.addEventListener('click', resetScenario);
            checkAnswerBtn.addEventListener('click', checkAnswer);
            showAnswerBtn.addEventListener('click', showAnswer);
        }

        function init() {
            populateScenarioOptions();
            updateScenario(currentScenario.id);
            updateCaseSection();
            bindEvents();
            handleSliderChange();
        }

        init();
    </script>
</body>
</html>
