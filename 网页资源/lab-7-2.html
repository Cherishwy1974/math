<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 7.2 一阶线性微分方程公式法实验室</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\(', '\)']],
                displayMath: [['$$', '$$'], ['\[', '\]']],
                processEscapes: true
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        if (typeof window.scheduleMathRender === 'function') {
                            window.scheduleMathRender();
                        }
                        console.log('MathJax加载完成');
                    });
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>
    <script defer src="../common-assets/js/lab-math-enhancer.js"></script>
    <style>
        :root {
            --h1-size: 22px;
            --h2-size: 20px;
            --h3-size: 18px;
            --btn-size: 16px;
            --formula-size: 20px;
            --text-size: 16px;
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #3730a3;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --border: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }

        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            font-size: var(--text-size);
            line-height: 1.5;
            background: var(--gray-50);
            color: var(--gray-800);
        }

        .return-home-panel {
            position: fixed;
            top: 12px;
            right: 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            z-index: 40;
        }

        .return-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.95), rgba(99, 102, 241, 0.9));
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 10px 18px rgba(79, 70, 229, 0.28);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .return-toggle:focus-visible {
            outline: 2px solid rgba(129, 140, 248, 0.6);
            outline-offset: 3px;
        }

        .return-toggle:hover {
            transform: translateY(-1px) scale(1.03);
            box-shadow: 0 14px 26px rgba(79, 70, 229, 0.35);
        }

        .return-links {
            display: none;
            flex-direction: column;
            gap: 6px;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(79, 70, 229, 0.15);
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.18);
            backdrop-filter: blur(6px);
        }

        .return-home-panel.open .return-links {
            display: flex;
        }

        .return-link {
            padding: 6px 12px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            color: var(--primary);
            background: rgba(79, 70, 229, 0.12);
            transition: background 0.2s ease, color 0.2s ease;
        }

        .return-link.return-main {
            color: var(--success);
            background: rgba(16, 185, 129, 0.12);
        }

        .return-link:hover {
            background: rgba(79, 70, 229, 0.2);
            color: var(--primary-dark);
        }

        .return-link.return-main:hover {
            background: rgba(16, 185, 129, 0.22);
        }

        .container {
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            max-height: 700px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: var(--light);
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--light);
            padding: 10px 24px;
            height: 48px;
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: var(--h1-size);
            font-weight: 600;
        }

        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 120px;
            background: var(--gray-50);
            border-right: 1px solid var(--border);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-btn {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--gray-600);
            text-align: left;
            font-size: var(--text-size);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: var(--gray-100);
        }

        .nav-btn.active {
            background: var(--primary);
            color: var(--light);
        }

        .content {
            flex: 1;
            display: none;
            padding: 18px;
            overflow-y: auto;
        }

        .content.active {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .card {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05);
        }

        .card h3 {
            font-size: var(--h3-size);
            color: var(--primary);
            margin-bottom: 12px;
        }

        .card p {
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--gray-600);
        }

        .input-group select,
        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: var(--text-size);
            background: var(--gray-50);
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--light);
        }

        .btn,
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            font-size: var(--btn-size);
            border: none;
            border-radius: 6px;
            background: var(--primary);
            color: var(--light);
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 6px;
        }

        .btn.secondary {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .btn:hover,
        .action-btn:hover {
            background: var(--primary-dark);
        }

        .btn.secondary:hover {
            background: var(--gray-400);
            color: var(--light);
        }

        .info-box {
            background: var(--gray-50);
            border-left: 3px solid var(--primary);
            padding: 12px;
            border-radius: 6px;
            font-size: var(--text-size);
            line-height: 1.6;
        }

        .hint-box {
            background: #ecfdf5;
            border-left: 3px solid var(--success);
            padding: 12px;
            border-radius: 6px;
            font-size: var(--text-size);
            color: var(--gray-600);
        }

        .warning-box {
            background: #fef3c7;
            border-left: 3px solid var(--warning);
            padding: 12px;
            border-radius: 6px;
            color: var(--gray-800);
        }

        .result-box {
            background: #eef2ff;
            border-radius: 8px;
            padding: 14px;
            border: 1px solid rgba(79, 70, 229, 0.2);
            min-height: 120px;
        }

        .formula-step {
            padding: 10px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            background: rgba(79, 70, 229, 0.08);
            color: var(--gray-800);
            position: relative;
        }

        .formula-step.active {
            border: 1px solid var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }

        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        canvas {
            width: 100%;
            height: 260px;
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .curve-legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 10px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }

        .steps-list {
            display: grid;
            gap: 10px;
        }

        .step-item {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 10px 12px;
            border: 1px solid var(--border);
        }

        .step-item strong {
            color: var(--primary);
        }

        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .analysis-table th,
        .analysis-table td {
            border: 1px solid var(--border);
            padding: 8px 10px;
            text-align: center;
        }

        .analysis-table th {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        @media (max-width: 1024px) {
            .content.active {
                grid-template-columns: 1fr;
            }

            .container {
                height: auto;
                max-height: none;
            }

            canvas {
                height: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="return-home-panel">
        <button class="return-toggle" type="button" aria-label="打开返回导航" onclick="toggleReturnPanel(event)">⌂</button>
        <div class="return-links">
            <a class="return-link return-sub" href="index.html">← 返回目录</a>
            <a class="return-link return-main" href="../index.html">⌂ 返回主站</a>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1>Lab 7.2 一阶线性微分方程的公式法求解</h1>
        </header>

        <div class="main">
            <nav class="sidebar">
                <button class="nav-btn active"  data-panel="module1"onclick="switchPanel('module1', this)">公式理解</button>
                <button class="nav-btn"  data-panel="module2"onclick="switchPanel('module2', this)">应用计算</button>
            </nav>

            <div class="content active" id="module1">
                <div class="column">
                    <div class="card">
                        <h3>标准形式识别</h3>
                        <p>将方程化为 $y'+P(x)y = Q(x)$ 的标准形式，准确识别 $P(x)$ 与 $Q(x)$。</p>
                        <div class="input-group">
                            <label for="equationSelect">选择预设方程</label>
                            <select id="equationSelect">
                                <option value="eq1">$y' + y = e^x$</option>
                                <option value="eq2">$y' + 2y = \\sin x$</option>
                                <option value="eq3">$y' - xy = x$</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="inputP">请填写 $P(x)$</label>
                            <input type="text" id="inputP" placeholder="例如：1">
                        </div>
                        <div class="input-group">
                            <label for="inputQ">请填写 $Q(x)$</label>
                            <input type="text" id="inputQ" placeholder="例如：e^x">
                        </div>
                        <button class="btn" onclick="checkPQ()">校验识别结果</button>
                        <div id="pqFeedback" class="info-box" style="margin-top:12px;">输入正确的函数形式后即可启动右侧公式构建器。</div>
                    </div>

                    <div class="card">
                        <h3>积分因子公式回顾</h3>
                        <div class="formula-box">$\\mu(x)=e^{\\int P(x)\\,dx}$</div>
                        <div class="steps-list" style="margin-top:12px;">
                            <div class="step-item"><strong>① 构造积分因子：</strong> 计算 $\\mu(x)=e^{\\int P(x)dx}$。</div>
                            <div class="step-item"><strong>② 两侧同乘：</strong> 将原方程乘以 $\\mu(x)$，化为 $\\big(\\mu(x)y\\big)' = Q(x)\\mu(x)$。</div>
                            <div class="step-item"><strong>③ 积分求解：</strong> 对两侧积分得 $\\mu(x)y = \\int Q(x)\\mu(x)\\,dx + C$。</div>
                            <div class="step-item"><strong>④ 还原通解：</strong> 两侧除以 $\\mu(x)$，得到 $y=e^{-\\int P(x)dx}\\Big[\\int Q(x)e^{\\int P(x)dx}dx + C\\Big]$。</div>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>通解公式可视化构建器</h3>
                        <div class="status-tag" id="builderStatus">等待输入</div>
                        <div class="result-box" id="formulaSteps">
                            <p>请在左侧正确填写 $P(x)$ 与 $Q(x)$ 后，系统将自动演示积分因子的构建过程。</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3>通解族曲线展示</h3>
                        <canvas id="solutionCanvas"></canvas>
                        <div class="curve-legend">
                            <div class="legend-item"><span class="legend-color" style="background:#4f46e5"></span> $C=1$</div>
                            <div class="legend-item"><span class="legend-color" style="background:#f59e0b"></span> $C=0$</div>
                            <div class="legend-item"><span class="legend-color" style="background:#10b981"></span> $C=-1$</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content" id="module2">
                <div class="column">
                    <div class="card">
                        <h3>应用案例选择</h3>
                        <p>选择一个应用题目，利用通解公式并结合初始条件确定常数 $C$。</p>
                        <div class="input-group">
                            <label for="applicationSelect">应用场景</label>
                            <select id="applicationSelect">
                                <option value="app1">RC 电路：$y'+2y = 4$, $y(0)=1$</option>
                                <option value="app2">水温变化：$y'+y = 20$, $y(0)=30$</option>
                                <option value="app3">人口增长：$y'-xy = x$, $y(0)=1$</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="initialWork">根据提示填写你的求解思路</label>
                            <textarea id="initialWork" rows="4" placeholder="步骤提示：1. 写出通解 2. 代入初值求 C"></textarea>
                        </div>
                        <button class="btn" onclick="solveApplication()">计算常数 $C$</button>
                        <div id="appFeedback" class="hint-box" style="margin-top:12px;">点击按钮后系统会列出完整的计算步骤，帮助你核对思路。</div>
                    </div>
                </div>
                <div class="column">
                    <div class="card">
                        <h3>初值问题分步解析</h3>
                        <div class="result-box" id="applicationSteps">
                            <p>等待选择应用场景……</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>特定解曲线与积分因子</h3>
                        <canvas id="applicationCanvas"></canvas>
                        <div class="info-box" id="applicationSummary" style="margin-top:12px;">
                            选择场景后，这里将展示积分因子、常数 $C$ 数值以及最终特解的曲线。
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const equationData = {
            eq1: {
                p: '1',
                q: 'e^x',
                integralP: '\\int P(x)dx = x',
                mu: 'e^{x}',
                integralPart: '\\int Q(x)e^{\\int P(x)dx}dx = \\int e^{2x}dx = \\tfrac{1}{2}e^{2x}',
                generalSolution: 'y=e^{-x}\\Big(\\tfrac{1}{2}e^{2x}+C\\Big)=\\tfrac{1}{2}e^{x}+Ce^{-x}',
                solver: (x, C) => 0.5 * Math.exp(x) + C * Math.exp(-x)
            },
            eq2: {
                p: '2',
                q: '\\sin x',
                integralP: '\\int P(x)dx = 2x',
                mu: 'e^{2x}',
                integralPart: '\\int Q(x)e^{\\int P(x)dx}dx = \\int e^{2x}\\sin x\\,dx = \\tfrac{1}{5}e^{2x}(2\\sin x - \\cos x)',
                generalSolution: 'y=e^{-2x}\\Big(\\tfrac{1}{5}e^{2x}(2\\sin x-\\cos x)+C\\Big)=\\tfrac{1}{5}(2\\sin x-\\cos x)+Ce^{-2x}',
                solver: (x, C) => (1/5) * (2 * Math.sin(x) - Math.cos(x)) + C * Math.exp(-2 * x)
            },
            eq3: {
                p: '-x',
                q: 'x',
                integralP: '\\int P(x)dx = -\\tfrac{x^2}{2}',
                mu: 'e^{-x^2/2}',
                integralPart: '\\int Q(x)e^{\\int P(x)dx}dx = \\int xe^{-x^2/2}dx = -e^{-x^2/2}',
                generalSolution: 'y=e^{x^2/2}\\Big(-e^{-x^2/2}+C\\Big) = -1 + Ce^{x^2/2}',
                solver: (x, C) => -1 + C * Math.exp(x * x / 2)
            }
        };

        const applicationData = {
            app1: {
                equation: "y'+2y = 4",
                p: '2',
                q: '4',
                integralP: '\\int 2dx = 2x',
                mu: 'e^{2x}',
                general: 'y=\\tfrac{4}{2}+Ce^{-2x}=2+Ce^{-2x}',
                condition: 'y(0)=1',
                constant: -1,
                solver: x => 2 - Math.exp(-2 * x)
            },
            app2: {
                equation: "y'+y = 20",
                p: '1',
                q: '20',
                integralP: '\\int 1dx = x',
                mu: 'e^{x}',
                general: 'y=20+Ce^{-x}',
                condition: 'y(0)=30',
                constant: 10,
                solver: x => 20 + 10 * Math.exp(-x)
            },
            app3: {
                equation: "y'-xy = x",
                p: '-x',
                q: 'x',
                integralP: '\\int (-x)dx = -\\tfrac{x^2}{2}',
                mu: 'e^{-x^2/2}',
                general: 'y=-1+Ce^{x^2/2}',
                condition: 'y(0)=1',
                constant: 2,
                solver: x => -1 + 2 * Math.exp(x * x / 2)
            }
        };

        const equationSelect = document.getElementById('equationSelect');
        const inputP = document.getElementById('inputP');
        const inputQ = document.getElementById('inputQ');
        const pqFeedback = document.getElementById('pqFeedback');
        const builderStatus = document.getElementById('builderStatus');
        const formulaSteps = document.getElementById('formulaSteps');
        const solutionCanvas = document.getElementById('solutionCanvas');
        const solutionCtx = solutionCanvas.getContext('2d');
        const applicationCanvas = document.getElementById('applicationCanvas');
        const appCtx = applicationCanvas.getContext('2d');

        function switchPanel(id, btn) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMath();
            setTimeout(() => {
                resizeCanvas(solutionCanvas);
                resizeCanvas(applicationCanvas);
                drawSolutionCurves();
                drawApplicationCurve();
            }, 120);
        }

        let mathObserver = null;
        let mathRenderQueued = false;

        function startMathObserver() {
            if (typeof MutationObserver === 'undefined' || !document.body) {
                return;
            }
            if (mathObserver) {
                mathObserver.disconnect();
            }
            mathObserver = new MutationObserver(mutations => {
                for (const mutation of mutations) {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        scheduleMathRender();
                        break;
                    }
                }
            });
            mathObserver.observe(document.body, { childList: true, subtree: true, characterData: true });
        }

        function scheduleMathRender() {
            if (mathRenderQueued) {
                return;
            }
            mathRenderQueued = true;
            requestAnimationFrame(() => {
                mathRenderQueued = false;
                if (window.MathJax && MathJax.typesetPromise) {
                    if (mathObserver) {
                        mathObserver.disconnect();
                    }
                    MathJax.typesetPromise()
                        .catch(err => console.log('渲染错误:', err))
                        .finally(() => {
                            startMathObserver();
                        });
                } else {
                    setTimeout(scheduleMathRender, 160);
                }
            });
        }

        window.scheduleMathRender = scheduleMathRender;

        function renderMath() {
            scheduleMathRender();
        }

        function ensureMathReady() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    startMathObserver();
                    scheduleMathRender();
                });
            } else {
                startMathObserver();
                scheduleMathRender();
            }
        }

        ensureMathReady();

        function toggleReturnPanel(event) {
            event.stopPropagation();
            const panel = document.querySelector('.return-home-panel');
            if (panel) {
                panel.classList.toggle('open');
            }
        }

        document.addEventListener('click', event => {
            const panel = document.querySelector('.return-home-panel');
            if (!panel) {
                return;
            }
            if (panel.classList.contains('open') && !panel.contains(event.target)) {
                panel.classList.remove('open');
            }
        });

        window.addEventListener('pageshow', () => {
            scheduleMathRender();
        });

        function resizeCanvas(canvas) {
            if (!canvas) return;
            const container = canvas.parentElement;
            const width = container.clientWidth - 20;
            const height = 240;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            const ratio = window.devicePixelRatio || 1;
            canvas.width = width * ratio;
            canvas.height = height * ratio;
            const ctx = canvas.getContext('2d');
            ctx.scale(ratio, ratio);
        }

        function drawAxis(ctx, width, height) {
            ctx.clearRect(0, 0, width, height);
            ctx.save();
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(40, height / 2);
            ctx.lineTo(width - 20, height / 2);
            ctx.moveTo(40, 20);
            ctx.lineTo(40, height - 20);
            ctx.stroke();

            ctx.fillStyle = '#374151';
            ctx.font = '12px sans-serif';
            ctx.fillText('x', width - 30, height / 2 - 6);
            ctx.fillText('y', 28, 28);

            for (let i = -4; i <= 4; i++) {
                const x = 40 + (width - 80) * (i + 4) / 8;
                ctx.beginPath();
                ctx.moveTo(x, height / 2 - 4);
                ctx.lineTo(x, height / 2 + 4);
                ctx.stroke();
                if (i !== 0) ctx.fillText(i, x - 4, height / 2 + 16);
            }

            for (let j = -3; j <= 3; j++) {
                const y = height / 2 - (height - 60) * j / 6;
                ctx.beginPath();
                ctx.moveTo(36, y);
                ctx.lineTo(44, y);
                ctx.stroke();
                if (j !== 0) ctx.fillText(j, 16, y + 4);
            }
            ctx.restore();
        }

        function checkPQ() {
            const selected = equationData[equationSelect.value];
            const pValue = inputP.value.trim();
            const qValue = inputQ.value.trim();
            if (!pValue || !qValue) {
                pqFeedback.className = 'warning-box';
                pqFeedback.innerHTML = '请完整填写 $P(x)$ 和 $Q(x)$ 的表达式。';
                renderMath();
                return;
            }

            if (pValue === selected.p && qValue === selected.q) {
                pqFeedback.className = 'hint-box';
                pqFeedback.innerHTML = '识别正确！现在一起套用积分因子公式。';
                startBuilderAnimation(selected);
            } else {
                pqFeedback.className = 'warning-box';
                pqFeedback.innerHTML = '识别不正确，请重新核对。提示：尝试将原方程整理为 $y\'+P(x)y=Q(x)$ 的形式。';
            }
            renderMath();
        }

        function startBuilderAnimation(data) {
            builderStatus.textContent = '构建中…';
            builderStatus.style.background = 'rgba(79,70,229,0.1)';
            builderStatus.style.color = 'var(--primary)';
            formulaSteps.innerHTML = '';

            const steps = [
                `1. 计算积分因子：$${data.integralP} \\Rightarrow \\mu(x)=${data.mu}$`,
                `2. 乘以积分因子：得到 $\\big(\\mu(x)y\\big)' = Q(x)\\mu(x)$。`,
                `3. 两侧积分：$\\mu(x)y = ${data.integralPart} + C$`,
                `4. 除以积分因子：$${data.generalSolution}$`
            ];

            steps.forEach((text, index) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = 'formula-step active';
                    div.innerHTML = text;
                    formulaSteps.appendChild(div);
                    renderMath();
                    if (index === steps.length - 1) {
                        builderStatus.textContent = '构建完成';
                        builderStatus.style.background = 'rgba(16,185,129,0.1)';
                        builderStatus.style.color = 'var(--success)';
                    }
                }, 500 * index);
            });

            drawSolutionCurves();
        }

        function drawSolutionCurves() {
            resizeCanvas(solutionCanvas);
            const width = solutionCanvas.clientWidth;
            const height = solutionCanvas.clientHeight;
            const ctx = solutionCtx;
            drawAxis(ctx, width, height);

            const data = equationData[equationSelect.value];
            if (!data) return;

            const colors = ['#4f46e5', '#f59e0b', '#10b981'];
            const constants = [1, 0, -1];

            constants.forEach((C, idx) => {
                ctx.beginPath();
                ctx.strokeStyle = colors[idx];
                ctx.lineWidth = 2;
                const step = (width - 80) / 100;
                for (let i = 0; i <= 100; i++) {
                    const canvasX = 40 + i * step;
                    const x = -2 + 4 * (i / 100);
                    const y = data.solver(x, C);
                    const canvasY = height / 2 - y * (height - 60) / 6;
                    if (i === 0) ctx.moveTo(canvasX, canvasY);
                    else ctx.lineTo(canvasX, canvasY);
                }
                ctx.stroke();
            });
        }

        function solveApplication() {
            const selection = applicationData[document.getElementById('applicationSelect').value];
            const steps = [
                `原方程：$${selection.equation}$，标准形式中 $P(x)=${selection.p}$，$Q(x)=${selection.q}$。`,
                `积分因子：$\\mu(x)=e^{\\int P(x)dx}=${selection.mu}$。`,
                `通解：$${selection.general}$。`,
                `利用初始条件 ${selection.condition}$，解得 $C=${selection.constant}$。`,
                `最终特解：将 $C$ 代回通解，得到 $y(x)$ 的明确表达式。`
            ];
            applicationSteps.innerHTML = '';
            steps.forEach((text, index) => {
                const div = document.createElement('div');
                div.className = 'formula-step active';
                div.style.marginBottom = '8px';
                div.innerHTML = text;
                applicationSteps.appendChild(div);
            });
            document.getElementById('appFeedback').className = 'hint-box';
            document.getElementById('appFeedback').innerHTML = '已根据积分因子公式完成求解，对照右侧步骤核实你的推理。';
            document.getElementById('applicationSummary').innerHTML = `积分因子 $${selection.mu}$，常数 $C=${selection.constant}$。图中绿色曲线展示满足初始条件的特解。`;
            renderMath();
            drawApplicationCurve();
        }

        function drawApplicationCurve() {
            resizeCanvas(applicationCanvas);
            const width = applicationCanvas.clientWidth;
            const height = applicationCanvas.clientHeight;
            drawAxis(appCtx, width, height);
            const selection = applicationData[document.getElementById('applicationSelect').value];
            if (!selection) return;

            appCtx.beginPath();
            appCtx.strokeStyle = '#10b981';
            appCtx.lineWidth = 2.2;
            const step = (width - 80) / 100;
            for (let i = 0; i <= 100; i++) {
                const canvasX = 40 + i * step;
                const x = 0 + 4 * (i / 100);
                const y = selection.solver(x);
                const canvasY = height / 2 - y * (height - 60) / 6;
                if (i === 0) appCtx.moveTo(canvasX, canvasY);
                else appCtx.lineTo(canvasX, canvasY);
            }
            appCtx.stroke();
        }

        window.addEventListener('resize', () => {
            resizeCanvas(solutionCanvas);
            resizeCanvas(applicationCanvas);
            drawSolutionCurves();
            drawApplicationCurve();
        });

        equationSelect.addEventListener('change', () => {
            inputP.value = equationData[equationSelect.value].p;
            inputQ.value = equationData[equationSelect.value].q;
            pqFeedback.className = 'info-box';
            pqFeedback.innerHTML = '新的方程已经就绪，请重新识别 $P(x)$ 和 $Q(x)$。';
            builderStatus.textContent = '等待输入';
            builderStatus.style.background = 'rgba(79,70,229,0.1)';
            builderStatus.style.color = 'var(--primary)';
            formulaSteps.innerHTML = '<p>填写完成后再次点击“校验识别结果”。</p>';
            renderMath();
            drawSolutionCurves();
        });

        document.getElementById('applicationSelect').addEventListener('change', () => {
            document.getElementById('appFeedback').className = 'hint-box';
            document.getElementById('appFeedback').innerHTML = '提示：先写出通解再代入初值。';
            applicationSteps.innerHTML = '<p>准备好后点击“计算常数 C”。</p>';
            document.getElementById('applicationSummary').innerHTML = '新的应用情境已载入。图中将以绿色曲线显示满足初值的特解。';
            renderMath();
            drawApplicationCurve();
        });

        // 初始化
        inputP.value = equationData[equationSelect.value].p;
        inputQ.value = equationData[equationSelect.value].q;
        resizeCanvas(solutionCanvas);
        resizeCanvas(applicationCanvas);
        drawSolutionCurves();
        drawApplicationCurve();
        renderMath();
    </script>
</body>
</html>
