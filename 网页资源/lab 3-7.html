<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高阶导数实验室</title>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax 初始化完成');
                    }).catch((error) => {
                        console.error('MathJax 初始化错误:', error);
                    });
                }
            }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>

    <style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #3730a3;
        --primary-light: #6366f1;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #1f2937;
        --white: #ffffff;
        --light: #ffffff;
        --border: #e5e7eb;
        --h1-size: 22px;
        --h3-size: 18px;
        --text-size: 16px;
        --formula-size: 20px;
    }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        *::-webkit-scrollbar { width: 0; background: transparent; }
        * { scrollbar-width: none; -ms-overflow-style: none; }

            body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
        font-size: var(--text-size);
        line-height: 1.5;
        background: var(--gray-50);
        color: var(--gray-700);
    }

            .container {
        width: 100%;
        max-width: 1400px;
        height: 100vh;
        max-height: 700px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        background: var(--white);
    }

            .header {
        height: 40px;
        background: var(--primary);
        color: var(--white);
        display: flex;
        align-items: center;
        padding: 0 20px;
    }

            .header h1 { font-size: var(--h1-size); margin: 0; }

            .main { flex: 1; display: flex; overflow: hidden; }

            .sidebar {
        width: 120px;
        background: var(--gray-50);
        border-right: 1px solid var(--border);
        padding: 10px 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

            .nav-btn {
        width: 100%;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: var(--text-size);
        color: var(--gray-600);
        text-align: left;
        transition: background 0.2s ease, color 0.2s ease;
    }

            .nav-btn.active { background: var(--primary); color: var(--white); }

            .nav-btn:hover { background: var(--gray-100); }
        .nav-btn:active { transform: translateY(0); }

            .content { flex: 1; position: relative; overflow: hidden; }

            .page-content { display: none; height: 100%; gap: 18px; padding: 16px; }
        .page-content:not([style*="display: none"]) { display: flex; }

            .column { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; padding-right: 4px; }

            .card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 10px; }

        .card h3 { font-size: var(--h3-size); color: var(--primary-dark); }
        .card p { line-height: 1.5; color: var(--gray-700); }

        .card-scroll { overflow-y: auto; }

        .tag-list { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag {
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 999px;
            background: var(--gray-100);
            color: var(--gray-500);
        }

        table { width: 100%; border-collapse: collapse; font-size: 15px; }
        th, td {
            border: 1px solid var(--gray-200);
            padding: 8px;
            text-align: center;
        }
        thead { background: var(--gray-100); }
        tr.highlight { background: rgba(79, 70, 229, 0.08); }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--gray-50);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid var(--gray-200);
        }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .control-row label { font-weight: 600; color: var(--gray-700); }
        .control-row span { color: var(--primary-dark); font-weight: 600; }

        input[type="range"] { flex: 1; }

        .canvas-container {
            flex: 1;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 280px;
        }

        canvas { width: 100%; height: 100%; border-radius: 10px; }

        .legend { display: flex; gap: 12px; flex-wrap: wrap; }
        .legend span { display: flex; align-items: center; gap: 6px; font-size: 14px; color: var(--gray-600); }
        .legend i { width: 14px; height: 14px; border-radius: 4px; display: inline-block; }

        .btn-group { display: flex; gap: 10px; }
        button.action {
            flex: 1;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: var(--text-size);
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            position: relative;
            z-index: 10;
            pointer-events: auto;
        }
        button.action.secondary {
            background: var(--white);
            color: var(--primary);
            border: 1px solid var(--primary);
        }
        button.action:hover { transform: translateY(-2px); }
        button.action:active { transform: translateY(0); }

        .analysis-box {
            background: #eef2ff;
            border: 1px dashed var(--primary-light);
            padding: 10px;
            border-radius: 10px;
            font-size: 15px;
            line-height: 1.5;
        }

        .info-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
        .info-item {
            padding: 10px;
            border-radius: 10px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
        }
        .info-item strong { color: var(--primary-dark); display: block; margin-bottom: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>高阶导数实验室</h1>
            <div>实时观察 $f^{(n)}(x)$ 的变化</div>
        </header>
        <div class="main">
            <nav class="sidebar">
                <button class="nav-btn active">高阶导数</button>
                <button class="nav-btn">凹凸性与拐点</button>
                <button class="nav-btn">物理含义</button>
                <button class="nav-btn">常见函数</button>
            </nav>
            <section class="content">
                <!-- 高阶导数页面 -->
                <div class="page-content" id="page-高阶导数">
                    <div class="column">
                        <div class="card card-scroll" id="summaryCard">
                            <h3>主题导览</h3>
                            <p>高阶导数刻画了函数变化率的变化率。在实际应用中，$f''(x)$ 判断凹凸性，$f'''(x)$ 反映弯曲速度，高阶导数还能描述振动和控制系统的动态。</p>
                            <div class="tag-list">
                                <span class="tag">多项式</span>
                                <span class="tag">三角函数</span>
                                <span class="tag">指数函数</span>
                                <span class="tag">凹凸性</span>
                                <span class="tag">物理速度</span>
                            </div>
                            <div class="analysis-box" id="derivativeDescription">当 $n = 1$ 时，我们观察函数的瞬时变化率；$n = 2$ 时，描述变化率的变化，即加速度。</div>
                        </div>

                        <div class="card card-scroll">
                            <h3>典型函数与高阶导数表</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>函数 $f(x)$</th>
                                        <th>$f'(x)$</th>
                                        <th>$f''(x)$</th>
                                        <th>$f'''(x)$</th>
                                    </tr>
                                </thead>
                                <tbody id="derivativeTable"></tbody>
                            </table>
                        </div>

                        <div class="card">
                            <h3>重点结论</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>凹凸性判别</strong>
                                    若 $f''(x_0) > 0$，曲线在 $x_0$ 处凹向上；若 $f''(x_0) < 0$，曲线凹向下。
                                </div>
                                <div class="info-item">
                                    <strong>拐点检测</strong>
                                    当 $f''(x_0) = 0$ 且两侧符号变化，则 $(x_0, f(x_0))$ 为拐点。
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="column">
                        <div class="card">
                            <h3>多阶导数图像对照</h3>
                            <div class="canvas-container">
                                <canvas id="derivativeCanvas"></canvas>
                            </div>
                            <div class="legend">
                                <span><i style="background:#2563eb"></i> $f(x)$</span>
                                <span><i style="background:#10b981"></i> $f'(x)$</span>
                                <span><i style="background:#f59e0b"></i> $f''(x)$</span>
                                <span><i style="background:#ef4444"></i> $f'''(x)$</span>
                            </div>
                            <div class="controls">
                                <div class="control-row">
                                    <label>选择函数</label>
                                    <select id="functionSelect">
                                        <option value="poly">$f(x)=x^3-3x$</option>
                                        <option value="exp">$f(x)=e^{0.5x}$</option>
                                        <option value="sin">$f(x)=\\sin x$</option>
                                    </select>
                                </div>
                                <div class="control-row">
                                    <label>高阶阶数 n</label>
                                    <input type="range" min="1" max="3" value="1" id="orderSlider">
                                    <span id="orderValue">1</span>
                                </div>
                                <div class="control-row">
                                    <label>观察位置 x</label>
                                    <input type="range" min="-4" max="4" step="0.1" value="0" id="xSlider">
                                    <span id="xValue">0.0</span>
                                </div>
                                <div class="btn-group">
                                    <button class="action" id="playAnimation">启动动画</button>
                                    <button class="action secondary" id="resetView">重置视角</button>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>数值观察</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>当前位置</strong>
                                    <span id="pointValue">$f(0) = 0$</span>
                                </div>
                                <div class="info-item">
                                    <strong>一阶导数</strong>
                                    <span id="firstDerivative">$f'(0) = 0$</span>
                                </div>
                                <div class="info-item">
                                    <strong>二阶导数</strong>
                                    <span id="secondDerivative">$f''(0) = -6$</span>
                                </div>
                                <div class="info-item">
                                    <strong>三阶导数</strong>
                                    <span id="thirdDerivative">$f^{(3)}(0) = 6$</span>
                                </div>
                            </div>
                            <div class="analysis-box" id="curvatureHint">在 $x=0$ 附近，$f''(x)<0$ 表示曲线向下弯曲，说明是一个局部山顶的趋势。</div>
                        </div>

                        <div class="card">
                            <h3>实际应用案例</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>机械振动</strong>
                                    二阶导数分析弹簧-质量系统的加速度变化
                                </div>
                                <div class="info-item">
                                    <strong>控制系统</strong>
                                    三阶导数用于分析控制系统的稳定性
                                </div>
                                <div class="info-item">
                                    <strong>信号处理</strong>
                                    高阶导数用于边缘检测和特征提取
                                </div>
                                <div class="info-item">
                                    <strong>经济分析</strong>
                                    分析成本函数的高阶导数，优化生产策略
                                </div>
                            </div>
                            <div class="analysis-box">
                                💡 提示：高阶导数在工程和科学中应用广泛，特别是在需要分析系统动态特性的场合。
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 凹凸性与拐点页面 -->
                <div class="page-content" id="page-凹凸性与拐点" style="display: none;">
                    <div class="column">
                        <div class="card card-scroll">
                            <h3>凹凸性理论基础</h3>
                            <p>函数的凹凸性是描述曲线弯曲方向的重要概念。通过二阶导数可以精确判断函数在任意点的凹凸性。</p>
                            <div class="tag-list">
                                <span class="tag">凹向上</span>
                                <span class="tag">凹向下</span>
                                <span class="tag">拐点</span>
                                <span class="tag">二阶导数</span>
                            </div>
                            <div class="analysis-box">
                                <strong>定义：</strong><br>
                                • 若 $f''(x) > 0$，则 $f(x)$ 在 $x$ 处凹向上（碗状）<br>
                                • 若 $f''(x) < 0$，则 $f(x)$ 在 $x$ 处凹向下（拱状）<br>
                                • 若 $f''(x) = 0$ 且两侧符号变化，则 $x$ 为拐点
                            </div>
                        </div>

                        <div class="card card-scroll">
                            <h3>拐点识别方法</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>条件</th>
                                        <th>结论</th>
                                        <th>几何意义</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>$f''(x_0) = 0$ 且符号变化</td>
                                        <td>$(x_0, f(x_0))$ 是拐点</td>
                                        <td>曲线改变弯曲方向</td>
                                    </tr>
                                    <tr>
                                        <td>$f''(x_0) = 0$ 且符号不变</td>
                                        <td>不是拐点</td>
                                        <td>曲线保持同一弯曲方向</td>
                                    </tr>
                                    <tr>
                                        <td>$f''(x_0) \neq 0$</td>
                                        <td>不是拐点</td>
                                        <td>曲线在该点有确定的凹凸性</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="card">
                            <h3>实际应用</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>工程设计</strong>
                                    桥梁、建筑物的弯曲分析需要判断结构的凹凸性，确保安全性。
                                </div>
                                <div class="info-item">
                                    <strong>经济学</strong>
                                    成本函数、收益函数的凹凸性反映边际效应的变化趋势。
                                </div>
                                <div class="info-item">
                                    <strong>物理学</strong>
                                    加速度的变化（三阶导数）与物体运动的平滑性相关。
                                </div>
                                <div class="info-item">
                                    <strong>图像处理</strong>
                                    拐点检测用于边缘识别和特征提取。
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="column">
                        <div class="card">
                            <h3>凹凸性可视化演示</h3>
                            <div class="canvas-container">
                                <canvas id="concavityCanvas"></canvas>
                            </div>
                            <div class="legend">
                                <span><i style="background:#2563eb"></i> 原函数</span>
                                <span><i style="background:#f59e0b"></i> 二阶导数</span>
                                <span><i style="background:#ef4444"></i> 拐点</span>
                            </div>
                        </div>

                        <div class="card">
                            <h3>典型函数凹凸性分析</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>$f(x) = x^3$</strong>
                                    在 $x = 0$ 处有拐点，左侧凹向下，右侧凹向上。
                                </div>
                                <div class="info-item">
                                    <strong>$f(x) = \sin x$</strong>
                                    每 $\pi$ 个单位有一个拐点，凹凸性周期性变化。
                                </div>
                                <div class="info-item">
                                    <strong>$f(x) = e^x$</strong>
                                    处处凹向上，没有拐点。
                                </div>
                                <div class="info-item">
                                    <strong>$f(x) = \ln x$</strong>
                                    处处凹向下，没有拐点。
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 物理含义页面 -->
                <div class="page-content" id="page-物理含义" style="display: none;">
                    <div class="column">
                        <div class="card card-scroll">
                            <h3>运动学中的导数</h3>
                            <p>在物理学中，导数的概念与运动学密切相关。位置、速度、加速度之间的关系体现了导数的物理意义。</p>
                            <div class="tag-list">
                                <span class="tag">位移</span>
                                <span class="tag">速度</span>
                                <span class="tag">加速度</span>
                                <span class="tag">跃度</span>
                            </div>
                            <div class="analysis-box">
                                <strong>基本关系：</strong><br>
                                • 位置函数：$s(t)$<br>
                                • 速度：$v(t) = s'(t)$（位置的一阶导数）<br>
                                • 加速度：$a(t) = s''(t)$（位置的二阶导数）<br>
                                • 跃度：$j(t) = s'''(t)$（位置的三阶导数）
                            </div>
                        </div>

                        <div class="card card-scroll">
                            <h3>工程振动分析</h3>
                            <p>在机械工程中，高阶导数用于分析振动系统的动态特性。</p>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>简谐振动</strong>
                                    $x(t) = A\sin(\omega t + \phi)$ 的二阶导数为 $-A\omega^2\sin(\omega t + \phi)$
                                </div>
                                <div class="info-item">
                                    <strong>阻尼振动</strong>
                                    三阶导数反映阻尼对系统响应的影响
                                </div>
                                <div class="info-item">
                                    <strong>共振分析</strong>
                                    高阶导数帮助识别共振频率和稳定性
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>控制系统应用</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>PID控制</strong>
                                    导数项（D项）基于误差的变化率进行调节
                                </div>
                                <div class="info-item">
                                    <strong>稳定性分析</strong>
                                    通过分析系统的高阶导数判断稳定性
                                </div>
                                <div class="info-item">
                                    <strong>轨迹规划</strong>
                                    机器人路径规划需要考虑加速度的连续性
                                </div>
                                <div class="info-item">
                                    <strong>信号处理</strong>
                                    导数运算用于边缘检测和特征提取
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="column">
                        <div class="card">
                            <h3>物理现象可视化</h3>
                            <div class="canvas-container">
                                <canvas id="physicsCanvas"></canvas>
                            </div>
                            <div class="legend">
                                <span><i style="background:#2563eb"></i> 位移 $s(t)$</span>
                                <span><i style="background:#10b981"></i> 速度 $v(t)$</span>
                                <span><i style="background:#f59e0b"></i> 加速度 $a(t)$</span>
                            </div>
                        </div>

                        <div class="card">
                            <h3>实际案例</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>汽车制动</strong>
                                    制动距离与速度的平方成正比，涉及二阶导数分析
                                </div>
                                <div class="info-item">
                                    <strong>桥梁设计</strong>
                                    载荷作用下桥梁的挠度分析需要高阶导数
                                </div>
                                <div class="info-item">
                                    <strong>电路分析</strong>
                                    RLC电路中电流的变化率分析
                                </div>
                                <div class="info-item">
                                    <strong>流体力学</strong>
                                    流速场的散度和旋度计算
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 常见函数页面 -->
                <div class="page-content" id="page-常见函数" style="display: none;">
                    <div class="column">
                        <div class="card card-scroll">
                            <h3>多项式函数</h3>
                            <p>多项式函数的高阶导数具有明显的规律性，最终会变为常数或零。</p>
                            <div class="tag-list">
                                <span class="tag">幂函数</span>
                                <span class="tag">多项式</span>
                                <span class="tag">阶数</span>
                            </div>
                            <div class="analysis-box">
                                <strong>规律：</strong><br>
                                $f(x) = x^n$ 的 $k$ 阶导数为：<br>
                                $f^{(k)}(x) = n(n-1)(n-2)...(n-k+1)x^{n-k}$<br>
                                当 $k > n$ 时，$f^{(k)}(x) = 0$
                            </div>
                        </div>

                        <div class="card card-scroll">
                            <h3>指数函数和对数函数</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>$f(x) = e^x$</strong>
                                    任意阶导数都是 $e^x$，保持不变
                                </div>
                                <div class="info-item">
                                    <strong>$f(x) = a^x$</strong>
                                    $f^{(n)}(x) = a^x(\ln a)^n$
                                </div>
                                <div class="info-item">
                                    <strong>$f(x) = \ln x$</strong>
                                    $f^{(n)}(x) = (-1)^{n-1}(n-1)!/x^n$
                                </div>
                                <div class="info-item">
                                    <strong>$f(x) = \log_a x$</strong>
                                    与 $\ln x$ 类似，但需要除以 $\ln a$
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>三角函数</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>$\sin x$</strong>
                                    四阶导数后回到原函数，呈现周期性
                                </div>
                                <div class="info-item">
                                    <strong>$\cos x$</strong>
                                    同样具有周期性，与 $\sin x$ 交错
                                </div>
                                <div class="info-item">
                                    <strong>$\tan x$</strong>
                                    高阶导数形式复杂，涉及三角函数组合
                                </div>
                                <div class="info-item">
                                    <strong>反三角函数</strong>
                                    高阶导数通常涉及有理函数
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="column">
                        <div class="card">
                            <h3>函数类型对比</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>函数类型</th>
                                        <th>一阶导数</th>
                                        <th>二阶导数</th>
                                        <th>高阶导数特点</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>$x^n$</td>
                                        <td>$nx^{n-1}$</td>
                                        <td>$n(n-1)x^{n-2}$</td>
                                        <td>最终为0</td>
                                    </tr>
                                    <tr>
                                        <td>$e^x$</td>
                                        <td>$e^x$</td>
                                        <td>$e^x$</td>
                                        <td>保持不变</td>
                                    </tr>
                                    <tr>
                                        <td>$\sin x$</td>
                                        <td>$\cos x$</td>
                                        <td>$-\sin x$</td>
                                        <td>周期性</td>
                                    </tr>
                                    <tr>
                                        <td>$\ln x$</td>
                                        <td>$1/x$</td>
                                        <td>$-1/x^2$</td>
                                        <td>有理函数</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="card">
                            <h3>复合函数求导</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>链式法则</strong>
                                    复合函数的高阶导数需要多次应用链式法则
                                </div>
                                <div class="info-item">
                                    <strong>莱布尼茨公式</strong>
                                    乘积函数的高阶导数公式
                                </div>
                                <div class="info-item">
                                    <strong>隐函数求导</strong>
                                    通过隐式求导得到高阶导数
                                </div>
                                <div class="info-item">
                                    <strong>参数方程</strong>
                                    参数方程的二阶导数公式
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        function renderMath() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise()
                    .then(() => {
                        console.log('MathJax 公式渲染完成');
                    })
                    .catch(err => {
                        console.error('MathJax 渲染错误:', err);
                        setTimeout(() => {
                            MathJax.typesetPromise().catch(e => console.error('重试失败:', e));
                        }, 200);
                    });
            } else if (window.MathJax && window.MathJax.typeset) {
                try {
                    MathJax.typeset();
                } catch (err) {
                    console.error('MathJax 渲染错误:', err);
                    setTimeout(() => {
                        try { MathJax.typeset(); } catch(e) { console.error('重试失败:', e); }
                    }, 200);
                }
            } else {
                setTimeout(renderMath, 100);
            }
        }

        function setupCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            return { ctx, width: rect.width, height: rect.height };
        }

        function drawAxes(ctx, width, height) {
            ctx.save();
            ctx.strokeStyle = '#cbd5f5';
            ctx.lineWidth = 1;
            const padding = 40;
            const xStep = (width - 2 * padding) / 8;
            const yStep = (height - 2 * padding) / 8;
            for (let i = 0; i <= 8; i++) {
                const x = padding + i * xStep;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();

                const y = padding + i * yStep;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }

            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(padding, height / 2);
            ctx.lineTo(width - padding, height / 2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(width / 2, padding);
            ctx.lineTo(width / 2, height - padding);
            ctx.stroke();
            ctx.restore();
        }

        function mathToCanvas(x, y, width, height, xRange, yRange, padding = 40) {
            const plotWidth = width - 2 * padding;
            const plotHeight = height - 2 * padding;
            const canvasX = padding + (x - xRange[0]) / (xRange[1] - xRange[0]) * plotWidth;
            const canvasY = height - padding - (y - yRange[0]) / (yRange[1] - yRange[0]) * plotHeight;
            return { x: canvasX, y: canvasY };
        }

        const functionLibrary = {
            poly: {
                name: '$f(x)=x^3-3x$',
                derivatives: [
                    x => x ** 3 - 3 * x,
                    x => 3 * x ** 2 - 3,
                    x => 6 * x,
                    () => 6
                ],
                description: '三次函数的二阶导数为直线，三阶导数为常数，揭示了多项式最终趋向稳定变化率的特征。'
            },
            exp: {
                name: '$f(x)=e^{0.5x}$',
                derivatives: [
                    x => Math.exp(0.5 * x),
                    x => 0.5 * Math.exp(0.5 * x),
                    x => 0.25 * Math.exp(0.5 * x),
                    x => 0.125 * Math.exp(0.5 * x)
                ],
                description: '指数函数每次求导都会保留原函数形态，但缩放系数依次减半，体现指数增长的稳定性。'
            },
            sin: {
                name: '$f(x)=\\sin x$',
                derivatives: [
                    x => Math.sin(x),
                    x => Math.cos(x),
                    x => -Math.sin(x),
                    x => -Math.cos(x)
                ],
                description: '三角函数的高阶导数呈周期循环，$n$ 次求导后会回到原函数或其相反数。'
            }
        };

        const derivativeTableData = [
            { f: '$x^4$', fp: '$4x^3$', fpp: '$12x^2$', fppp: '$24x$' },
            { f: '$e^{2x}$', fp: '$2e^{2x}$', fpp: '$4e^{2x}$', fppp: '$8e^{2x}$' },
            { f: '$\\sin x$', fp: '$\\cos x$', fpp: '$-\\sin x$', fppp: '$-\\cos x$' },
            { f: '$\\ln x$', fp: '$\\frac{1}{x}$', fpp: '$-\\frac{1}{x^2}$', fppp: '$\\frac{2}{x^3}$' }
        ];

        const derivativeDescriptions = {
            1: '一阶导数 $f\'(x)$ 描述瞬时变化率，是速度、增长率等最常用的量。',
            2: '二阶导数 $f\'\'(x)$ 判断凹凸性与加速度，帮助识别极值与稳定性。',
            3: '三阶导数 $f^{(3)}(x)$ 关注变化率的变化速度，工程中用于判断振动与响应灵敏度。'
        };

        const derivativeCanvas = document.getElementById('derivativeCanvas');
        const functionSelect = document.getElementById('functionSelect');
        const orderSlider = document.getElementById('orderSlider');
        const xSlider = document.getElementById('xSlider');
        const orderValue = document.getElementById('orderValue');
        const xValue = document.getElementById('xValue');
        const playBtn = document.getElementById('playAnimation');
        const resetBtn = document.getElementById('resetView');
        const derivativeDescription = document.getElementById('derivativeDescription');

        const pointValue = document.getElementById('pointValue');
        const firstDerivative = document.getElementById('firstDerivative');
        const secondDerivative = document.getElementById('secondDerivative');
        const thirdDerivative = document.getElementById('thirdDerivative');
        const curvatureHint = document.getElementById('curvatureHint');

        let animationFrame = null;
        let animationActive = false;
        let animationDirection = 1;

        function populateTable() {
            const tbody = document.getElementById('derivativeTable');
            tbody.innerHTML = derivativeTableData.map(row => `
                <tr>
                    <td>${row.f}</td>
                    <td>${row.fp}</td>
                    <td>${row.fpp}</td>
                    <td>${row.fppp}</td>
                </tr>
            `).join('');
            renderMath();
        }

        function drawFunction(ctx, width, height, fn, color, xRange, yRange) {
            ctx.save();
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            const steps = 400;
            for (let i = 0; i <= steps; i++) {
                const x = xRange[0] + (i / steps) * (xRange[1] - xRange[0]);
                const y = fn(x);
                const { x: cx, y: cy } = mathToCanvas(x, y, width, height, xRange, yRange);
                if (i === 0) ctx.moveTo(cx, cy);
                else ctx.lineTo(cx, cy);
            }
            ctx.stroke();
            ctx.restore();
        }

        function updateCanvas() {
            const { ctx, width, height } = setupCanvas(derivativeCanvas);
            ctx.clearRect(0, 0, width, height);
            const xRange = [-4, 4];
            const yRange = [-6, 6];
            drawAxes(ctx, width, height);

            const selected = functionLibrary[functionSelect.value];
            const [f0, f1, f2, f3] = selected.derivatives;
            drawFunction(ctx, width, height, f0, '#2563eb', xRange, yRange);
            drawFunction(ctx, width, height, f1, '#10b981', xRange, yRange);
            drawFunction(ctx, width, height, f2, '#f59e0b', xRange, yRange);
            drawFunction(ctx, width, height, f3, '#ef4444', xRange, yRange);

            const x = parseFloat(xSlider.value);
            const points = [f0(x), f1(x), f2(x), f3(x)];
            const order = parseInt(orderSlider.value);
            
            for (let i = 0; i <= order; i++) {
                const { x: canvasX, y: canvasY } = mathToCanvas(x, points[i], width, height, xRange, yRange);
                ctx.beginPath();
                ctx.arc(canvasX, canvasY, 4, 0, 2 * Math.PI);
                ctx.fillStyle = ['#2563eb', '#10b981', '#f59e0b', '#ef4444'][i];
                ctx.fill();
            }
            
            updateDerivativeInfo(x, points, order);
        }

        function drawConcavity() {
            const canvas = document.getElementById('concavityCanvas');
            if (!canvas) return;
            
            const { ctx, width, height } = setupCanvas(canvas);
            ctx.clearRect(0, 0, width, height);
            const xRange = [-3, 3];
            const yRange = [-2, 2];
            drawAxes(ctx, width, height);

            // 绘制函数 f(x) = x^3 - 3x
            const f = x => x * x * x - 3 * x;
            const f2 = x => 6 * x; // 二阶导数
            
            drawFunction(ctx, width, height, f, '#2563eb', xRange, yRange);
            drawFunction(ctx, width, height, f2, '#f59e0b', xRange, yRange);
            
            // 标记拐点
            const inflectionX = 0;
            const inflectionY = f(inflectionX);
            const { x: canvasX, y: canvasY } = mathToCanvas(inflectionX, inflectionY, width, height, xRange, yRange);
            
            ctx.beginPath();
            ctx.arc(canvasX, canvasY, 6, 0, 2 * Math.PI);
            ctx.fillStyle = '#ef4444';
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // 添加拐点标签
            ctx.fillStyle = '#ef4444';
            ctx.font = '12px Arial';
            ctx.fillText('拐点', canvasX + 10, canvasY - 10);
        }

        function drawPhysics() {
            const canvas = document.getElementById('physicsCanvas');
            if (!canvas) return;
            
            const { ctx, width, height } = setupCanvas(canvas);
            ctx.clearRect(0, 0, width, height);
            const tRange = [0, 4 * Math.PI];
            const yRange = [-2, 2];
            drawAxes(ctx, width, height);

            // 简谐振动: s(t) = sin(t), v(t) = cos(t), a(t) = -sin(t)
            const s = t => Math.sin(t);
            const v = t => Math.cos(t);
            const a = t => -Math.sin(t);
            
            drawFunction(ctx, width, height, s, '#2563eb', tRange, yRange);
            drawFunction(ctx, width, height, v, '#10b981', tRange, yRange);
            drawFunction(ctx, width, height, a, '#f59e0b', tRange, yRange);
            
            // 添加标签
            ctx.fillStyle = '#2563eb';
            ctx.font = '12px Arial';
            ctx.fillText('s(t) = sin(t)', 10, 20);
            
            ctx.fillStyle = '#10b981';
            ctx.fillText('v(t) = cos(t)', 10, 35);
            
            ctx.fillStyle = '#f59e0b';
            ctx.fillText('a(t) = -sin(t)', 10, 50);
        }

        function updateInfoPanel() {
            const x = parseFloat(xSlider.value);
            const selected = functionLibrary[functionSelect.value];
            const values = selected.derivatives.map(fn => fn(x));

            pointValue.innerHTML = `$f(${x.toFixed(1)}) = ${values[0].toFixed(3)}`;
            firstDerivative.innerHTML = `$f'(${x.toFixed(1)}) = ${values[1].toFixed(3)}`;
            secondDerivative.innerHTML = `$f''(${x.toFixed(1)}) = ${values[2].toFixed(3)}`;
            thirdDerivative.innerHTML = `$f^{(3)}(${x.toFixed(1)}) = ${values[3].toFixed(3)}`;

            let hint = '';
            if (values[2] > 0) hint = `在 $x=${x.toFixed(1)}$ 附近，$f''(x) > 0$，曲线呈现碗状向上弯曲。`;
            else if (values[2] < 0) hint = `在 $x=${x.toFixed(1)}$ 附近，$f''(x) < 0$，曲线向下弯曲，提示局部最高点趋势。`;
            else hint = `在 $x=${x.toFixed(1)}$，$f''(x) = 0$，需要检查两侧符号判断是否为拐点。`;
            curvatureHint.innerHTML = hint;
            renderMath();
        }

        function updateSummary() {
            const order = parseInt(orderSlider.value, 10);
            orderValue.textContent = order;
            derivativeDescription.innerHTML = derivativeDescriptions[order];

            const rows = Array.from(document.querySelectorAll('#derivativeTable tr'));
            rows.forEach(row => row.classList.remove('highlight'));
            rows[order].classList.add('highlight');
        }

        function resetAnimation() {
            animationActive = false;
            playBtn.textContent = '启动动画';
            if (animationFrame) cancelAnimationFrame(animationFrame);
        }

        function animate() {
            if (!animationActive) return;
            const min = parseFloat(xSlider.min);
            const max = parseFloat(xSlider.max);
            let current = parseFloat(xSlider.value);
            current += 0.02 * animationDirection;
            if (current >= max || current <= min) {
                animationDirection *= -1;
                current = Math.max(min, Math.min(max, current));
            }
            xSlider.value = current.toFixed(2);
            xValue.textContent = current.toFixed(1);
            updateCanvas();
            updateInfoPanel();
            animationFrame = requestAnimationFrame(animate);
        }

        function resetView() {
            resetAnimation();
            functionSelect.value = 'poly';
            orderSlider.value = 1;
            xSlider.value = 0;
            orderValue.textContent = '1';
            xValue.textContent = '0.0';
            updateSummary();
            updateCanvas();
            updateInfoPanel();
        }

        function switchPage(pageName, clickedButton) {
            console.log('切换到页面:', pageName);
            
            // 隐藏所有页面内容
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            
            // 移除所有按钮的active类
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 显示当前页面内容
            const currentPage = document.getElementById(`page-${pageName}`);
            if (currentPage) {
                currentPage.style.display = 'flex';
            }
            
            // 为当前按钮添加active类
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // 重新渲染数学公式
            setTimeout(() => {
                renderMath();
                if (pageName === '高阶导数') {
                    updateCanvas();
                    updateInfoPanel();
                } else if (pageName === '凹凸性与拐点') {
                    drawConcavity();
                } else if (pageName === '物理含义') {
                    drawPhysics();
                }
            }, 100);
        }

        function initEvents() {
            console.log('初始化事件监听器...');
            
            // 为导航按钮添加事件监听器
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    switchPage(e.target.textContent, e.target);
                });
            });
            
            functionSelect.addEventListener('change', () => {
                console.log('函数选择改变:', functionSelect.value);
                updateCanvas();
                updateInfoPanel();
                resetAnimation();
                derivativeDescription.innerHTML = functionLibrary[functionSelect.value].description;
                renderMath();
            });

            orderSlider.addEventListener('input', () => {
                console.log('阶数滑块改变:', orderSlider.value);
                updateSummary();
                renderMath();
            });

            xSlider.addEventListener('input', () => {
                xValue.textContent = parseFloat(xSlider.value).toFixed(1);
                updateCanvas();
                updateInfoPanel();
            });

            playBtn.addEventListener('click', (e) => {
                console.log('播放按钮被点击');
                animationActive = !animationActive;
                playBtn.textContent = animationActive ? '暂停动画' : '启动动画';
                if (animationActive) animate();
                else resetAnimation();
            });

            resetBtn.addEventListener('click', (e) => {
                console.log('重置按钮被点击');
                resetView();
            });
            
            console.log('事件监听器初始化完成');
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化...');
            populateTable();
            initEvents();
            
            // 确保首页正确显示
            const firstButton = document.querySelector('.nav-btn');
            if (firstButton) {
                switchPage(firstButton.textContent.trim(), firstButton);
            }
            
            updateSummary();
            updateCanvas();
            updateInfoPanel();
            derivativeDescription.innerHTML = functionLibrary[functionSelect.value].description;
            xValue.textContent = parseFloat(xSlider.value).toFixed(1);
            renderMath();
            
            // 测试按钮是否可点击
            setTimeout(() => {
                const playBtn = document.getElementById('playAnimation');
                const resetBtn = document.getElementById('resetView');
                console.log('播放按钮元素:', playBtn);
                console.log('重置按钮元素:', resetBtn);
                if (playBtn) {
                    console.log('播放按钮样式:', window.getComputedStyle(playBtn));
                }
            }, 1000);
        });
    </script>
</body>
</html>








