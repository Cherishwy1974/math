<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>牛顿-莱布尼茨实验室</title>

    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>
    <style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #3730a3;
        --primary-light: #6366f1;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #1f2937;
        --white: #ffffff;
        --light: #ffffff;
        --border: #e5e7eb;
        --h1-size: 22px;
        --h3-size: 18px;
        --text-size: 16px;
        --formula-size: 20px;
    }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        *::-webkit-scrollbar { width: 0; background: transparent; }
        * { scrollbar-width: none; -ms-overflow-style: none; }

            body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
        font-size: var(--text-size);
        line-height: 1.5;
        background: var(--gray-50);
        color: var(--gray-700);
    }

            .container {
        width: 100%;
        max-width: 1400px;
        height: min(100vh, 700px);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        background: var(--white);
    }

            .header {
        height: 40px;
        background: var(--primary);
        color: var(--white);
        display: flex;
        align-items: center;
        padding: 0 20px;
    }

            .main { flex: 1; display: flex; overflow: hidden; }

            .sidebar {
        width: 120px;
        background: var(--gray-50);
        border-right: 1px solid var(--border);
        padding: 10px 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

            .nav-btn {
        width: 100%;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: var(--text-size);
        color: var(--gray-600);
        text-align: left;
        transition: background 0.2s ease, color 0.2s ease;
    }

            .nav-btn.active { background: var(--primary); color: var(--white); }
            .nav-btn:hover { background: var(--gray-100); }

                        .content {
        flex: 1;
        position: relative;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 18px;
        padding: 16px;
        overflow: hidden;
    }
            .column { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; padding-right: 4px; }

            .card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 10px; }

        .card-scroll { overflow-y: auto; }
        .card h3 { font-size: var(--h3-size); color: var(--primary-dark); }
        .card p { line-height: 1.5; }

        .tag-list { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { font-size: 13px; padding: 4px 10px; border-radius: 999px; background: var(--gray-100); color: var(--gray-500); }

        .info-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
        .info-item { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px; padding: 10px; font-size: 15px; }
        .info-item strong { color: var(--primary-dark); display: block; margin-bottom: 6px; }

        .controls { display: flex; flex-direction: column; gap: 10px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px; padding: 10px; }
        .control-row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .control-row label { font-weight: 600; }
        select { flex: 1; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--gray-300); font-size: 15px; }
        button.action { background: var(--primary); color: var(--white); border: none; border-radius: 8px; padding: 8px 12px; font-size: var(--text-size); cursor: pointer; transition: transform 0.2s ease; }
        button.action.secondary { background: var(--white); color: var(--primary); border: 1px solid var(--primary); }
        button.action:hover { transform: translateY(-2px); }

        .canvas-wrapper { border: 1px solid var(--gray-200); border-radius: 12px; background: var(--gray-50); padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        canvas { width: 100%; height: 260px; border-radius: 10px; background: var(--white); }

        .step-panel { border: 1px solid var(--gray-200); border-radius: 12px; background: var(--gray-50); padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        .step-card { border: 1px solid var(--gray-200); border-radius: 10px; padding: 10px; background: var(--white); transition: border 0.2s ease, transform 0.2s ease; }
        .step-card.active { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79,70,229,0.15); transform: translateX(4px); }
        .step-card.success { border-color: var(--success); }
        .step-card.error { border-color: var(--danger); background: rgba(239,68,68,0.07); }

        .input-box { background: var(--white); border: 1px dashed var(--gray-300); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; gap: 6px; }
        .input-box input { border: 1px solid var(--gray-300); border-radius: 8px; padding: 6px 8px; font-size: 15px; }
        .input-box .hint { font-size: 14px; color: var(--gray-500); }
        .hint.success { color: var(--success); }
        .hint.error { color: var(--danger); }

        .status-box { background: #eef2ff; border-radius: 10px; padding: 10px; font-size: 14px; color: var(--primary-dark); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>牛顿-莱布尼茨实验室</h1>
            <div>从原函数到定积分：$\int_a^b f(x)dx = F(b) - F(a)$</div>
        </header>
        <div class="main">
            <nav class="sidebar">
                <button class="nav-btn active">几何理解</button>
                <button class="nav-btn">计算练习</button>
            </nav>
            <section class="content">
                <div class="column">
                    <div class="card card-scroll">
                        <h3>学习指引</h3>
                        <p>微积分基本定理告诉我们：只要找到被积函数的原函数，就能用 $F(b)-F(a)$ 快速求出定积分。本实验通过面积动画与分步校验帮助你理解这一联系。</p>
                        <div class="tag-list">
                            <span class="tag">原函数</span>
                            <span class="tag">面积对比</span>
                            <span class="tag">数值验证</span>
                            <span class="tag">自动检查</span>
                        </div>
                        <div class="status-box" id="summaryBox">当前函数：$f(x)=3x^2$，区间 $[0,2]$。</div>
                    </div>

                    <div class="card">
                        <h3>理解要点</h3>
                        <div class="info-grid">
                            <div class="info-item"><strong>面积差</strong> 面积动画展示 $F(b)-F(a)$ 与阴影面积数值相等。</div>
                            <div class="info-item"><strong>原函数判断</strong> 检查 $F'(x)$ 是否等于 $f(x)$。</div>
                            <div class="info-item"><strong>区间代入</strong> 计算 $F(b)-F(a)$ 时需代入两个端点。</div>
                            <div class="info-item"><strong>常数不影响</strong> 任意常数 $C$ 在差值中抵消。</div>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="card">
                        <h3>面积联动演示</h3>
                        <div class="controls">
                            <div class="control-row">
                                <label>选择练习</label>
                                <select id="caseSelector"></select>
                                <button class="action secondary" id="toggleAnimation">启动动画</button>
                            </div>
                        </div>
                        <div class="canvas-wrapper">
                            <canvas id="areaCanvas"></canvas>
                            <div class="status-box" id="areaInfo">面积对比：$\int_a^b f(x)dx$ 与 $F(b)-F(a)$ 在动画中同步变化。</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3>分步验证</h3>
                        <div class="step-panel" id="stepPanel"></div>
                        <div class="status-box" id="stepStatus">填写原函数与端点代入，系统将自动验证。</div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        function renderMath() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }
        }

        const cases = [
            {
                label: '$f(x)=3x^2$，$[0,2]$，原函数建议 $x^3$。',
                f: x => 3 * x * x,
                F: x => x * x * x,
                interval: [0, 2]
            },
            {
                label: '$f(x)=2x+1$，$[-1,1]$，原函数建议 $x^2 + x$。',
                f: x => 2 * x + 1,
                F: x => x * x + x,
                interval: [-1, 1]
            },
            {
                label: '$f(x)=\cos x$，$[0,\pi/2]$，原函数建议 $\sin x$。',
                f: x => Math.cos(x),
                F: x => Math.sin(x),
                interval: [0, Math.PI / 2]
            }
        ];

        const caseSelector = document.getElementById('caseSelector');
        const areaCanvas = document.getElementById('areaCanvas');
        const areaInfo = document.getElementById('areaInfo');
        const summaryBox = document.getElementById('summaryBox');
        const stepPanel = document.getElementById('stepPanel');
        const stepStatus = document.getElementById('stepStatus');
        const toggleAnimation = document.getElementById('toggleAnimation');

        let currentIndex = 0;
        let animationActive = false;
        let animationFrame = null;
        let animationT = 0;

        function initCaseSelector() {
            cases.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.innerHTML = item.label;
                caseSelector.appendChild(option);
            });
            caseSelector.value = currentIndex;
            summaryBox.innerHTML = `当前函数：${cases[currentIndex].label}`;
            renderMath();
        }

        function setupCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            return { ctx, width: rect.width, height: rect.height };
        }

        function drawArea(t) {
            const data = cases[currentIndex];
            const { ctx, width, height } = setupCanvas(areaCanvas);
            const padding = 40;
            const [a, b] = data.interval;
            const maxX = b;
            const minX = a;
            const sampleValues = [];
            const steps = 200;
            let maxY = -Infinity;
            let minY = Infinity;
            for (let i = 0; i <= steps; i++) {
                const x = minX + (i / steps) * (maxX - minX);
                const y = data.f(x);
                sampleValues.push({ x, y });
                maxY = Math.max(maxY, y);
                minY = Math.min(minY, y);
            }
            minY = Math.min(minY, 0);
            maxY = Math.max(maxY, minY + 1);

            function toCanvasCoord(x, y) {
                const cx = padding + (x - minX) / (maxX - minX) * (width - 2 * padding);
                const cy = height - padding - (y - minY) / (maxY - minY) * (height - 2 * padding);
                return { x: cx, y: cy };
            }

            ctx.save();
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 8; i++) {
                const x = padding + i * (width - 2 * padding) / 8;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();
            }
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.stroke();
            ctx.restore();

            // fill area up to current t
            const currentX = minX + t * (maxX - minX);
            ctx.save();
            ctx.fillStyle = 'rgba(79,70,229,0.2)';
            ctx.beginPath();
            let started = false;
            sampleValues.forEach(({ x, y }) => {
                if (x <= currentX) {
                    const pos = toCanvasCoord(x, y);
                    if (!started) {
                        ctx.moveTo(pos.x, height - padding);
                        ctx.lineTo(pos.x, pos.y);
                        started = true;
                    } else {
                        ctx.lineTo(pos.x, pos.y);
                    }
                }
            });
            const end = toCanvasCoord(currentX, data.f(currentX));
            ctx.lineTo(end.x, end.y);
            ctx.lineTo(end.x, height - padding);
            ctx.closePath();
            ctx.fill();
            ctx.restore();

            // draw function curve
            ctx.save();
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.beginPath();
            sampleValues.forEach(({ x, y }, index) => {
                const pos = toCanvasCoord(x, y);
                if (index === 0) ctx.moveTo(pos.x, pos.y);
                else ctx.lineTo(pos.x, pos.y);
            });
            ctx.stroke();
            ctx.restore();

            const F = data.F;
            const currentArea = definiteIntegral(data.f, a, currentX, 400);
            const FDiff = F(currentX) - F(a);
            areaInfo.textContent = `当前 x = ${currentX.toFixed(3)}，面积近似值 $\int_a^{x} f(t)dt ≈ ${currentArea.toFixed(4)}$，$F(x)-F(a) ≈ ${FDiff.toFixed(4)}$`;
            renderMath();
        }

        function definiteIntegral(fn, start, end, n) {
            const dx = (end - start) / n;
            let sum = 0;
            for (let i = 0; i < n; i++) {
                const x1 = start + i * dx;
                const x2 = x1 + dx;
                sum += 0.5 * (fn(x1) + fn(x2)) * dx;
            }
            return sum;
        }

        function buildSteps() {
            const data = cases[currentIndex];
            stepPanel.innerHTML = '';
            const [a, b] = data.interval;
            const steps = [
                { prompt: '填写原函数 $F(x)$：', answer: data.FText || suggestF(data) },
                { prompt: `计算 $F(${b.toFixed(3)})$：`, answer: evaluateExpression(suggestF(data), b).toFixed(4) },
                { prompt: `计算 $F(${a.toFixed(3)})$：`, answer: evaluateExpression(suggestF(data), a).toFixed(4) },
                { prompt: '写出 $F(b)-F(a)$ 的结果：', answer: (evaluateExpression(suggestF(data), b) - evaluateExpression(suggestF(data), a)).toFixed(4) }
            ];

            steps.forEach((step, index) => {
                const card = document.createElement('div');
                card.className = 'step-card';
                card.dataset.index = index;
                card.innerHTML = `
                    <strong>${index + 1}. ${step.prompt}</strong>
                    <div class="input-box">
                        <input type="text" placeholder="填写结果" data-answer="${step.answer}">
                        <div style="display:flex; gap:8px;">
                            <button class="action secondary check-btn">检查</button>
                            <button class="action secondary hint-btn">提示</button>
                        </div>
                        <span class="hint">支持四舍五入到四位小数。</span>
                    </div>
                `;
                stepPanel.appendChild(card);
            });
            stepStatus.textContent = '按顺序填写原函数与端点值。';
        }

        function suggestF(data) {
            if (data.suggestF) return data.suggestF;
            const text = caseSelector.options[currentIndex].text;
            if (text.includes('3x^2')) return 'x^3';
            if (text.includes('2x+1')) return 'x^2 + x';
            return 'sin(x)';
        }

        function attachEvents() {
            caseSelector.addEventListener('change', () => {
                currentIndex = parseInt(caseSelector.value, 10);
                summaryBox.textContent = `当前函数：${cases[currentIndex].label}`;
                animationT = 0;
                drawArea(animationT);
                buildSteps();
            });

            toggleAnimation.addEventListener('click', () => {
                animationActive = !animationActive;
                toggleAnimation.textContent = animationActive ? '暂停动画' : '启动动画';
                if (animationActive) animate();
                else cancelAnimationFrame(animationFrame);
            });

            stepPanel.addEventListener('click', event => {
                const card = event.target.closest('.step-card');
                if (!card) return;
                const input = card.querySelector('input');
                const hint = card.querySelector('.hint');
                if (event.target.classList.contains('check-btn')) {
                    const answer = card.dataset.index === '0' ? verifyDerivative(input.value) : input.dataset.answer;
                    if (card.dataset.index === '0') {
                        if (answer) {
                            hint.textContent = '原函数正确！';
                            hint.classList.add('success');
                            card.classList.add('success');
                        } else {
                            hint.textContent = '原函数不匹配，被积函数导数不一致。';
                            hint.classList.add('error');
                            card.classList.add('error');
                        }
                    } else {
                        const value = parseFloat(input.value);
                        const target = parseFloat(input.dataset.answer);
                        if (Math.abs(value - target) < 1e-3) {
                            hint.textContent = '数值匹配。';
                            hint.classList.add('success');
                            card.classList.add('success');
                        } else {
                            hint.textContent = `期望约 ${target}`;
                            hint.classList.add('error');
                            card.classList.add('error');
                        }
                    }
                }
                if (event.target.classList.contains('hint-btn')) {
                    hint.textContent = `参考值：${input.dataset.answer}`;
                    hint.classList.add('success');
                }
            });
        }

        function animate() {
            if (!animationActive) return;
            animationT += 0.01;
            if (animationT > 1) animationT = 0;
            drawArea(animationT);
            animationFrame = requestAnimationFrame(animate);
        }

        function evaluateExpression(expr, x) {
            try {
                const sanitized = expr.replace(/\^/g, '**').replace(/ln/g, 'Math.log');
                const fn = new Function('x', `with(Math){ return ${sanitized}; }`);
                return fn(x);
            } catch (e) {
                return NaN;
            }
        }

        function verifyDerivative(Fexpr) {
            const data = cases[currentIndex];
            const samples = 6;
            for (let i = 0; i < samples; i++) {
                const x = data.interval[0] + Math.random() * (data.interval[1] - data.interval[0]);
                const dx = 1e-5;
                const up = evaluateExpression(Fexpr, x + dx);
                const down = evaluateExpression(Fexpr, x - dx);
                if (!isFinite(up) || !isFinite(down)) return false;
                const approx = (up - down) / (2 * dx);
                if (Math.abs(approx - data.f(x)) > 1e-3) return false;
            }
            return true;
        }

        initCaseSelector();
        buildSteps();
        attachEvents();
        drawArea(animationT);
        renderMath();
    </script>
</body>
</html>










