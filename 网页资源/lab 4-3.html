<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单调性与极值分析实验室</title>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax加载完成');
                    });
                }
            }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>

    <style>
    :root {
        --primary: #4f46e5;
        --primary-dark: #3730a3;
        --primary-light: #6366f1;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #1f2937;
        --white: #ffffff;
        --light: #ffffff;
        --border: #e5e7eb;
        --h1-size: 22px;
        --h3-size: 18px;
        --text-size: 16px;
        --formula-size: 20px;
    }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        *::-webkit-scrollbar { width: 0; background: transparent; }
        * { scrollbar-width: none; -ms-overflow-style: none; }

            body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
        font-size: var(--text-size);
        line-height: 1.5;
        background: var(--gray-50);
        color: var(--gray-700);
    }

            .container {
        width: 100%;
        max-width: 1400px;
        height: min(100vh, 700px);
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        background: var(--white);
    }

            .header {
        height: 40px;
        background: var(--primary);
        color: var(--white);
        display: flex;
        align-items: center;
        padding: 0 20px;
    }
            .header h1 { font-size: var(--h1-size); margin: 0; }

            .main { flex: 1; display: flex; overflow: hidden; }

            .sidebar {
        width: 120px;
        background: var(--gray-50);
        border-right: 1px solid var(--border);
        padding: 10px 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

            .nav-btn {
        width: 100%;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: var(--text-size);
        color: var(--gray-600);
        text-align: left;
        transition: background 0.2s ease, color 0.2s ease;
    }
            .nav-btn.active { background: var(--primary); color: var(--white); }
            .nav-btn:hover { background: var(--gray-100); }

            .content {
        flex: 1;
        position: relative;
        overflow: hidden;
        padding: 0;
    }
            .page-content {
        display: none;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 18px;
        height: 100%;
        padding: 16px;
    }

    .page-content.active {
        display: grid;
    }

            .column { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; padding-right: 4px; }

            .card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .card h3 { font-size: var(--h3-size); color: var(--primary-dark); }
        .card p { line-height: 1.5; }
        .card-scroll { overflow-y: auto; }

        .tag-list { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { font-size: 13px; padding: 4px 10px; border-radius: 999px; background: var(--gray-100); color: var(--gray-500); }

        .controls { display: flex; flex-direction: column; gap: 10px; background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px; padding: 10px; }
        .control-row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .control-row label { font-weight: 600; }
        .control-row span { color: var(--primary-dark); font-weight: 600; }
        select, input[type="text"] { flex: 1; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--gray-300); font-size: 15px; }
        input[type="range"] { flex: 1; }

        .btn-group { display: flex; gap: 10px; }
        button.action { flex: 1; background: var(--primary); color: var(--white); border: none; border-radius: 8px; padding: 10px 12px; font-size: var(--text-size); cursor: pointer; transition: transform 0.2s ease; position: relative; z-index: 10; pointer-events: auto; }
        button.action.secondary { background: var(--white); color: var(--primary); border: 1px solid var(--primary); }
        button.action.success { background: var(--success); }
        button.action:hover { transform: translateY(-2px); }

        .canvas-stack { display: flex; flex-direction: column; gap: 12px; }
        canvas { width: 100%; height: 220px; background: var(--white); border-radius: 10px; border: 1px solid var(--gray-200); }

        .info-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }
        .info-item { background: var(--gray-50); border: 1px solid var(--gray-200); border-radius: 10px; padding: 10px; font-size: 15px; }
        .info-item strong { display: block; margin-bottom: 6px; color: var(--primary-dark); }

        table { width: 100%; border-collapse: collapse; font-size: 15px; }
        th, td { border: 1px solid var(--gray-200); padding: 8px; text-align: center; }
        thead { background: var(--gray-100); }
        .interval-btn { padding: 4px 10px; border-radius: 6px; border: 1px solid var(--gray-300); background: var(--white); cursor: pointer; font-size: 14px; }
        .interval-btn.active.increase { background: rgba(16,185,129,0.16); border-color: var(--success); color: var(--success); }
        .interval-btn.active.decrease { background: rgba(239,68,68,0.16); border-color: var(--danger); color: var(--danger); }
        .interval-btn.correct { box-shadow: 0 0 0 2px rgba(16,185,129,0.3); }
        .interval-btn.wrong { box-shadow: 0 0 0 2px rgba(239,68,68,0.3); }

        .status-box { background: #eef2ff; color: var(--primary-dark); border-radius: 10px; padding: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>一阶导数与单调性实验室</h1>
            <div>把 $f'(x)$ 的符号变化转成直观的区间结论</div>
        </header>
        <div class="main">
            <nav class="sidebar">
                <button class="nav-btn active" data-section="analysis">单调性分析</button>
                <button class="nav-btn" data-section="extrema">极值点判断</button>
                <button class="nav-btn" data-section="custom">自定义函数</button>
            </nav>
            <section class="content">
                <!-- 单调性分析页面 -->
                <div class="page-content active" id="analysis">
                    <div class="column">
                        <div class="card card-scroll">
                            <h3>操作指引</h3>
                            <p>选择一个函数后，系统会自动计算驻点与区间，并可视化展示 $f(x)$ 与 $f'(x)$。你可以拖动扫描线观察变化趋势，也可以在下方表格中标记导数符号，验证自己的判断。</p>
                            <div class="tag-list">
                                <span class="tag">导数符号</span>
                                <span class="tag">区间增减</span>
                                <span class="tag">极值判断</span>
                                <span class="tag">交互动画</span>
                            </div>
                            <div class="status-box" id="functionSummary">当前函数：$f(x) = x^3 - 3x$，驻点在 $x=-1,1$，存在极大值与极小值。</div>
                        </div>

                        <div class="card card-scroll">
                            <h3>单调区间判定表</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>区间</th>
                                        <th>导数符号</th>
                                        <th>你的选择</th>
                                    </tr>
                                </thead>
                                <tbody id="intervalTable"></tbody>
                            </table>
                        </div>

                        <div class="card">
                            <h3>结论速记</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>单调性</strong>
                                    $f'(x)>0$ 时函数递增，$f'(x)<0$ 时递减；在区间内符号不需频繁改变。
                                </div>
                                <div class="info-item">
                                    <strong>极值判别</strong>
                                    驻点左右符号变 "+→-" 为极大值，"-→+" 为极小值，符号不变则无极值。
                                </div>
                                <div class="info-item">
                                    <strong>实际意义</strong>
                                    导数符号与经济、工程中的增长/衰减速度密切相关，图像化能更直观。
                                </div>
                                <div class="info-item">
                                    <strong>易错提醒</strong>
                                    注意不可导点也会影响区间划分，表格中会自动提示。
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="column">
                        <div class="card">
                            <h3>函数与导数图像</h3>
                            <div class="controls">
                                <div class="control-row">
                                    <label>选择函数</label>
                                    <select id="presetSelector"></select>
                                </div>
                                <div class="control-row">
                                    <label>自定义表达式</label>
                                    <input type="text" id="customInput" placeholder="例如: Math.sin(x) - x/2">
                                    <button class="action secondary" id="applyCustom">应用</button>
                                </div>
                                <div class="control-row">
                                    <label>扫描速度</label>
                                    <input type="range" id="speedSlider" min="1" max="5" step="1" value="2">
                                    <span id="speedValue">中速</span>
                                    <button class="action" id="toggleScan">启动扫描</button>
                                    <button class="action secondary" id="resetView">重置</button>
                                </div>
                            </div>
                            <div class="canvas-stack">
                                <canvas id="functionCanvas"></canvas>
                                <canvas id="derivativeCanvas"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <h3>关键点与语言解读</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>驻点信息</strong>
                                    <span id="criticalInfo">驻点：$x=-1,1$</span>
                                </div>
                                <div class="info-item">
                                    <strong>区间增减</strong>
                                    <span id="intervalInfo">$(-\\infty,-1)$ 增，$(-1,1)$ 减，$(1,\\infty)$ 增</span>
                                </div>
                                <div class="info-item">
                                    <strong>极值结论</strong>
                                    <span id="extremaInfo">$x=-1$ 处为极大值，$x=1$ 处为极小值</span>
                                </div>
                                <div class="info-item">
                                    <strong>即时提示</strong>
                                    <span id="hintInfo">扫描线位置对应的导数符号将同步高亮。</span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3>实际应用场景</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>经济学应用</strong>
                                    利润最大化：$P(x) = R(x) - C(x)$，令 $P'(x) = 0$ 求最优产量
                                </div>
                                <div class="info-item">
                                    <strong>物理学应用</strong>
                                    运动分析：位移 $s(t)$，速度 $v(t) = s'(t)$，加速度 $a(t) = v'(t)$
                                </div>
                                <div class="info-item">
                                    <strong>工程应用</strong>
                                    材料强度：应力-应变关系，最大应力点对应极值
                                </div>
                                <div class="info-item">
                                    <strong>生物学应用</strong>
                                    种群增长：增长率函数，寻找增长最快点
                                </div>
                            </div>
                            <div class="status-box">
                                💡 提示：单调性和极值分析在优化问题中非常重要，是数学建模的基础工具。
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 极值点判断页面 -->
                <div class="page-content" id="extrema">
                    <div class="column">
                        <div class="card card-scroll">
                            <h3>极值点判断</h3>
                            <p>极值点是函数的重要特征，通过分析导数的符号变化可以准确判断极值点的类型和位置。</p>
                            <div class="tag-list">
                                <span class="tag">一阶导数</span>
                                <span class="tag">二阶导数</span>
                                <span class="tag">符号变化</span>
                                <span class="tag">极值类型</span>
                            </div>
                            <div class="status-box">通过分析 $f'(x)$ 的符号变化来判断极值点的类型。</div>
                        </div>
                        <div class="card">
                            <h3>极值判断方法</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>一阶导数法</strong>
                                    若 $f'(x_0)=0$ 且在 $x_0$ 左右导数符号相反，则 $x_0$ 为极值点。
                                </div>
                                <div class="info-item">
                                    <strong>二阶导数法</strong>
                                    若 $f'(x_0)=0$ 且 $f''(x_0) \neq 0$，则 $x_0$ 为极值点。
                                </div>
                                <div class="info-item">
                                    <strong>极大值</strong>
                                    $f'(x)$ 从正变负，或 $f''(x_0) < 0$。
                                </div>
                                <div class="info-item">
                                    <strong>极小值</strong>
                                    $f'(x)$ 从负变正，或 $f''(x_0) > 0$。
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>极值点可视化</h3>
                            <div class="canvas-stack">
                                <canvas id="extremaCanvas"></canvas>
                                <canvas id="derivativeSignCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 自定义函数页面 -->
                <div class="page-content" id="custom">
                    <div class="column">
                        <div class="card card-scroll">
                            <h3>自定义函数</h3>
                            <p>输入自定义函数表达式，系统将自动分析其单调性和极值特征。</p>
                            <div class="tag-list">
                                <span class="tag">函数输入</span>
                                <span class="tag">自动分析</span>
                                <span class="tag">可视化</span>
                                <span class="tag">错误检查</span>
                            </div>
                            <div class="status-box">支持常见的数学函数和运算符。</div>
                        </div>
                        <div class="card">
                            <h3>函数输入</h3>
                            <div class="controls">
                                <div class="control-row">
                                    <label>函数表达式</label>
                                    <input type="text" id="customFunctionInput" placeholder="例如: Math.sin(x) * x + Math.cos(x)">
                                    <button class="action" id="analyzeCustom">分析函数</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>自定义函数分析结果</h3>
                            <div class="canvas-stack">
                                <canvas id="customCanvas"></canvas>
                                <canvas id="customDerivativeCanvas"></canvas>
                            </div>
                            <div id="customAnalysisResults" class="info-grid">
                                <!-- 分析结果将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        function renderMath() {
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise().catch(err => console.log('渲染错误:', err));
            }
        }

        // 确保页面加载完成后渲染数学公式
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(renderMath, 100);
        });

        function setupCanvas(canvas) {
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            return { ctx, width: rect.width, height: rect.height };
        }

        function drawAxes(ctx, width, height) {
            const padding = 40;
            ctx.save();
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 8; i++) {
                const x = padding + i * (width - 2 * padding) / 8;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, height - padding);
                ctx.stroke();
                const y = padding + i * (height - 2 * padding) / 8;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.moveTo(padding, height / 2); ctx.lineTo(width - padding, height / 2); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(width / 2, padding); ctx.lineTo(width / 2, height - padding); ctx.stroke();
            ctx.restore();
        }

        function mathToCanvas(x, y, width, height, xRange, yRange, padding = 40) {
            const plotWidth = width - 2 * padding;
            const plotHeight = height - 2 * padding;
            const cx = padding + (x - xRange[0]) / (xRange[1] - xRange[0]) * plotWidth;
            const cy = height - padding - (y - yRange[0]) / (yRange[1] - yRange[0]) * plotHeight;
            return { x: cx, y: cy };
        }

        function numericDerivative(fn, x, h = 1e-4) {
            const f1 = fn(x + h);
            const f2 = fn(x - h);
            if (!Number.isFinite(f1) || !Number.isFinite(f2)) return NaN;
            return (f1 - f2) / (2 * h);
        }

        const presets = {
            cubic: { name: '$x^3 - 3x$', expression: 'x*x*x - 3*x', domain: [-4, 4] },
            trig: { name: '$\sin x - \frac{x}{2}$', expression: 'Math.sin(x) - x/2', domain: [-6, 6] },
            rational: { name: '$\frac{x^2}{x^2+1}$', expression: '(x*x)/(x*x+1)', domain: [-6, 6] }
        };

        let currentFn = x => x * x * x - 3 * x;
        let currentExpression = 'x*x*x - 3*x';
        let domain = [-4, 4];
        let scanActive = false;
        let scanX = -4;
        let scanDirection = 1;
        let animationFrame = null;

        const presetSelector = document.getElementById('presetSelector');
        const customInput = document.getElementById('customInput');
        const applyCustomBtn = document.getElementById('applyCustom');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const toggleScanBtn = document.getElementById('toggleScan');
        const resetViewBtn = document.getElementById('resetView');
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');

        const functionCanvas = document.getElementById('functionCanvas');
        const derivativeCanvas = document.getElementById('derivativeCanvas');

        const intervalTable = document.getElementById('intervalTable');
        const functionSummary = document.getElementById('functionSummary');
        const criticalInfo = document.getElementById('criticalInfo');
        const intervalInfo = document.getElementById('intervalInfo');
        const extremaInfo = document.getElementById('extremaInfo');
        const hintInfo = document.getElementById('hintInfo');

        let intervalData = [];

        function populatePresetSelector() {
            Object.entries(presets).forEach(([key, item]) => {
                const option = document.createElement('option');
                option.value = key;
                option.innerHTML = item.name;
                presetSelector.appendChild(option);
            });
            presetSelector.value = 'cubic';
        }

        function parseExpression(expr) {
            try {
                const sanitized = expr.replace(/\^/g, '**');
                return new Function('x', `return ${sanitized};`);
            } catch (e) {
                return null;
            }
        }

        function evaluateSafe(fn, x) {
            try {
                const value = fn(x);
                if (!Number.isFinite(value)) return NaN;
                return value;
            } catch (e) {
                return NaN;
            }
        }

        function findCriticalPoints(fn, domain, samples = 240) {
            const points = [];
            const [minX, maxX] = domain;
            let prevX = minX;
            let prevDeriv = numericDerivative(fn, prevX);
            for (let i = 1; i <= samples; i++) {
                const x = minX + (i / samples) * (maxX - minX);
                const deriv = numericDerivative(fn, x);
                if (!Number.isFinite(deriv) || !Number.isFinite(prevDeriv)) {
                    prevX = x; prevDeriv = deriv; continue;
                }
                if (Math.abs(deriv) < 1e-4) {
                    points.push(x);
                } else if (prevDeriv * deriv < 0) {
                    let left = prevX;
                    let right = x;
                    for (let k = 0; k < 20; k++) {
                        const mid = (left + right) / 2;
                        const midDeriv = numericDerivative(fn, mid);
                        if (!Number.isFinite(midDeriv)) break;
                        if (prevDeriv * midDeriv <= 0) {
                            right = mid;
                        } else {
                            left = mid;
                            prevDeriv = midDeriv;
                        }
                    }
                    points.push((left + right) / 2);
                }
                prevX = x; prevDeriv = deriv;
            }
            return Array.from(new Set(points.map(p => parseFloat(p.toFixed(3))))).sort((a, b) => a - b);
        }

        function buildIntervals(points, domain) {
            const arr = [domain[0], ...points, domain[1]];
            const intervals = [];
            for (let i = 0; i < arr.length - 1; i++) {
                const left = arr[i];
                const right = arr[i + 1];
                const mid = (left + right) / 2;
                const derivativeValue = numericDerivative(currentFn, mid);
                let behavior = 'flat';
                if (Number.isFinite(derivativeValue)) {
                    if (derivativeValue > 0) behavior = 'increase';
                    else if (derivativeValue < 0) behavior = 'decrease';
                }
                intervals.push({ left, right, mid, behavior, userChoice: null, result: null });
            }
            return intervals;
        }

        function updateIntervalTable() {
            intervalTable.innerHTML = '';
            intervalData.forEach((item, index) => {
                const row = document.createElement('tr');
                const intervalCell = document.createElement('td');
                intervalCell.innerHTML = `$(${formatNumber(item.left)}, ${formatNumber(item.right)})$`;
                const expectedCell = document.createElement('td');
                expectedCell.textContent = item.behavior === 'increase' ? '递增' : item.behavior === 'decrease' ? '递减' : '待定';
                const chooseCell = document.createElement('td');
                const plusBtn = document.createElement('button');
                plusBtn.className = 'interval-btn';
                plusBtn.textContent = '递增';
                plusBtn.addEventListener('click', () => setUserChoice(index, 'increase', plusBtn));
                const minusBtn = document.createElement('button');
                minusBtn.className = 'interval-btn';
                minusBtn.textContent = '递减';
                minusBtn.addEventListener('click', () => setUserChoice(index, 'decrease', minusBtn));
                chooseCell.appendChild(plusBtn);
                chooseCell.appendChild(minusBtn);
                row.appendChild(intervalCell);
                row.appendChild(expectedCell);
                row.appendChild(chooseCell);
                intervalTable.appendChild(row);
            });
            renderMath();
        }

        function setUserChoice(index, choice, button) {
            const row = intervalData[index];
            row.userChoice = choice;
            const buttons = button.parentElement.querySelectorAll('.interval-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active', 'increase', 'decrease', 'correct', 'wrong');
            });
            button.classList.add('active', choice === 'increase' ? 'increase' : 'decrease');
            const correct = row.behavior === choice;
            row.result = correct;
            button.classList.add(correct ? 'correct' : 'wrong');
            hintInfo.textContent = correct ? '选择正确：导数符号与预期一致。' : '选择错误：再观察导数图像的符号变化。';
        }

        function formatNumber(value) {
            if (!Number.isFinite(value)) return '∞';
            if (Math.abs(value) >= 1000 || Math.abs(value) < 0.001) return value.toExponential(2);
            return value.toFixed(2);
        }

        function analyzeFunction() {
            const criticalPoints = findCriticalPoints(currentFn, domain);
            intervalData = buildIntervals(criticalPoints, domain);
            updateIntervalTable();
            updateSummary(criticalPoints);
            updateCanvas();
        }

        function updateSummary(criticalPoints) {
            const expressionDisplay = currentExpression.replace(/\*/g, '\\cdot ');
            functionSummary.innerHTML = `当前函数：$f(x) = ${expressionDisplay}$，检测到驻点 ${criticalPoints.length ? criticalPoints.map(c => c.toFixed(2)).join(', ') : '无'}。`;
            criticalInfo.innerHTML = criticalPoints.length ? `驻点：${criticalPoints.map(c => '$x=' + c.toFixed(2) + '$').join('，')}` : '驻点：暂无';
            const intervalDesc = intervalData.map(item => {
                const text = item.behavior === 'increase' ? '增' : item.behavior === 'decrease' ? '减' : '待定';
                return `$(${formatNumber(item.left)}, ${formatNumber(item.right)}) ${text}$`;
            }).join('，');
            intervalInfo.innerHTML = intervalDesc || '待分析';
            const extrema = [];
            for (let i = 1; i < intervalData.length; i++) {
                const prev = intervalData[i - 1];
                const current = intervalData[i];
                const point = intervalData[i - 1].right;
                if (!Number.isFinite(point)) continue;
                if (prev.behavior === 'increase' && current.behavior === 'decrease') extrema.push(`$x=${point.toFixed(2)}$ 为极大值`);
                if (prev.behavior === 'decrease' && current.behavior === 'increase') extrema.push(`$x=${point.toFixed(2)}$ 为极小值`);
            }
            extremaInfo.innerHTML = extrema.length ? extrema.join('，') : '当前函数暂无明显极值变化。';
            renderMath();
        }

        function updateCanvas() {
            drawFunctionCanvas();
            drawDerivativeCanvas();
        }

        function drawFunctionCanvas() {
            const { ctx, width, height } = setupCanvas(functionCanvas);
            ctx.clearRect(0, 0, width, height);
            drawAxes(ctx, width, height);
            const samples = 500;
            const [minX, maxX] = domain;
            let minY = Infinity, maxY = -Infinity;
            const points = [];
            for (let i = 0; i <= samples; i++) {
                const x = minX + (i / samples) * (maxX - minX);
                const y = evaluateSafe(currentFn, x);
                if (!Number.isFinite(y)) continue;
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
                points.push({ x, y });
            }
            const pad = (maxY - minY) * 0.2 || 1;
            const yRange = [minY - pad, maxY + pad];
            ctx.save();
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.beginPath();
            let started = false;
            points.forEach(({ x, y }) => {
                const { x: cx, y: cy } = mathToCanvas(x, y, width, height, domain, yRange);
                if (!started) { ctx.moveTo(cx, cy); started = true; }
                else ctx.lineTo(cx, cy);
            });
            ctx.stroke();
            ctx.restore();
            drawScanLine(ctx, width, height, yRange);
        }

        function drawDerivativeCanvas() {
            const { ctx, width, height } = setupCanvas(derivativeCanvas);
            ctx.clearRect(0, 0, width, height);
            drawAxes(ctx, width, height);
            const samples = 500;
            const [minX, maxX] = domain;
            let minY = Infinity, maxY = -Infinity;
            const points = [];
            for (let i = 0; i <= samples; i++) {
                const x = minX + (i / samples) * (maxX - minX);
                const y = numericDerivative(currentFn, x);
                if (!Number.isFinite(y)) continue;
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
                points.push({ x, y });
            }
            const pad = (maxY - minY) * 0.2 || 1;
            const yRange = [minY - pad, maxY + pad];
            ctx.save();
            ctx.strokeStyle = '#f97316';
            ctx.lineWidth = 2;
            ctx.beginPath();
            let started = false;
            points.forEach(({ x, y }) => {
                const { x: cx, y: cy } = mathToCanvas(x, y, width, height, domain, yRange);
                if (!started) { ctx.moveTo(cx, cy); started = true; }
                else ctx.lineTo(cx, cy);
            });
            ctx.stroke();
            ctx.restore();
            drawScanLine(ctx, width, height, yRange, true);
        }

        function drawScanLine(ctx, width, height, yRange, derivative = false) {
            if (!scanActive) return;
            const { x } = mathToCanvas(scanX, 0, width, height, domain, yRange);
            ctx.save();
            ctx.strokeStyle = derivative ? '#f97316' : '#2563eb';
            ctx.setLineDash([6, 6]);
            ctx.beginPath();
            ctx.moveTo(x, 20);
            ctx.lineTo(x, height - 20);
            ctx.stroke();
            ctx.restore();
        }

        function animateScan() {
            const speed = parseInt(speedSlider.value, 10);
            const delta = (domain[1] - domain[0]) / (speed === 1 ? 600 : speed === 2 ? 400 : speed === 3 ? 300 : speed === 4 ? 200 : 120);
            scanX += scanDirection * delta;
            if (scanX >= domain[1] || scanX <= domain[0]) {
                scanDirection *= -1;
                scanX = Math.max(domain[0], Math.min(domain[1], scanX));
            }
            hintInfo.textContent = `扫描到 $x=${scanX.toFixed(2)}$，此处导数约为 ${numericDerivative(currentFn, scanX).toFixed(3)}`;
            updateCanvas();
            animationFrame = requestAnimationFrame(animateScan);
        }

        function stopScan() {
            scanActive = false;
            toggleScanBtn.textContent = '启动扫描';
            if (animationFrame) cancelAnimationFrame(animationFrame);
            animationFrame = null;
            updateCanvas();
        }

        presetSelector.addEventListener('change', () => {
            const item = presets[presetSelector.value];
            if (!item) return;
            const fn = parseExpression(item.expression);
            if (!fn) return;
            currentFn = fn;
            currentExpression = item.expression;
            domain = item.domain.slice();
            scanX = domain[0];
            scanDirection = 1;
            stopScan();
            analyzeFunction();
        });

        applyCustomBtn.addEventListener('click', () => {
            const expr = customInput.value.trim();
            if (!expr) return;
            const fn = parseExpression(expr);
            if (!fn) {
                hintInfo.textContent = '表达式无法解析，请使用 Math 函数并检查语法。';
                return;
            }
            currentFn = fn;
            currentExpression = expr;
            domain = [-5, 5];
            scanX = domain[0];
            scanDirection = 1;
            stopScan();
            analyzeFunction();
        });

        speedSlider.addEventListener('input', () => {
            const value = parseInt(speedSlider.value, 10);
            speedValue.textContent = value === 1 ? '慢速' : value === 2 ? '中速' : value === 3 ? '偏快' : value === 4 ? '快速' : '极速';
        });

        toggleScanBtn.addEventListener('click', () => {
            scanActive = !scanActive;
            if (scanActive) {
                toggleScanBtn.textContent = '暂停扫描';
                animationFrame = requestAnimationFrame(animateScan);
            } else {
                stopScan();
            }
        });

        resetViewBtn.addEventListener('click', () => {
            presetSelector.value = 'cubic';
            const item = presets['cubic'];
            currentFn = parseExpression(item.expression);
            currentExpression = item.expression;
            domain = item.domain.slice();
            scanX = domain[0];
            scanDirection = 1;
            customInput.value = '';
            stopScan();
            analyzeFunction();
        });

        // 页面切换功能
        function switchPage(section) {
            pages.forEach(page => {
                page.classList.toggle('active', page.id === section);
            });
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.section === section);
            });

            setTimeout(renderMath, 80);

            setTimeout(() => {
                if (section === 'analysis') {
                    updateCanvas();
                } else if (section === 'extrema') {
                    updateExtremaCanvas();
                } else if (section === 'custom') {
                    updateCustomCanvas();
                }
            }, 200);
        }

        // 绑定导航按钮事件
        function initNavigation() {
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;
                    switchPage(section);
                });
            });
        }

        // 添加缺失的Canvas更新函数
        function updateExtremaCanvas() {
            const canvas = document.getElementById('extremaCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width = 400;
            const height = canvas.height = 300;
            ctx.clearRect(0, 0, width, height);
            
            // 绘制坐标轴
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, height - 40);
            ctx.lineTo(width - 40, height - 40);
            ctx.moveTo(40, 40);
            ctx.lineTo(40, height - 40);
            ctx.stroke();
            
            // 绘制函数曲线
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = -3; x <= 3; x += 0.1) {
                const y = x * x * x - 3 * x;
                const canvasX = 40 + ((x + 3) / 6) * (width - 80);
                const canvasY = height - 40 - ((y + 10) / 20) * (height - 80);
                if (x === -3) {
                    ctx.moveTo(canvasX, canvasY);
                } else {
                    ctx.lineTo(canvasX, canvasY);
                }
            }
            ctx.stroke();
            
            // 标记极值点
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(40 + ((1 + 3) / 6) * (width - 80), height - 40 - ((-2 + 10) / 20) * (height - 80), 5, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(40 + ((-1 + 3) / 6) * (width - 80), height - 40 - ((2 + 10) / 20) * (height - 80), 5, 0, 2 * Math.PI);
            ctx.fill();
            
            // 添加标签
            ctx.fillStyle = '#1f2937';
            ctx.font = '14px Arial';
            ctx.fillText('极大值', 40 + ((-1 + 3) / 6) * (width - 80) + 10, height - 40 - ((2 + 10) / 20) * (height - 80) - 10);
            ctx.fillText('极小值', 40 + ((1 + 3) / 6) * (width - 80) + 10, height - 40 - ((-2 + 10) / 20) * (height - 80) + 20);
        }

        function updateCustomCanvas() {
            const canvas = document.getElementById('customCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width = 400;
            const height = canvas.height = 300;
            ctx.clearRect(0, 0, width, height);
            
            // 绘制坐标轴
            ctx.strokeStyle = '#374151';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(40, height - 40);
            ctx.lineTo(width - 40, height - 40);
            ctx.moveTo(40, 40);
            ctx.lineTo(40, height - 40);
            ctx.stroke();
            
            // 绘制默认函数曲线
            ctx.strokeStyle = '#10b981';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let x = -3; x <= 3; x += 0.1) {
                const y = Math.sin(x) - x / 2;
                const canvasX = 40 + ((x + 3) / 6) * (width - 80);
                const canvasY = height - 40 - ((y + 3) / 6) * (height - 80);
                if (x === -3) {
                    ctx.moveTo(canvasX, canvasY);
                } else {
                    ctx.lineTo(canvasX, canvasY);
                }
            }
            ctx.stroke();
            
            // 添加标签
            ctx.fillStyle = '#1f2937';
            ctx.font = '14px Arial';
            ctx.fillText('f(x) = sin(x) - x/2', 50, 60);
        }

        populatePresetSelector();
        analyzeFunction();
        initNavigation();
        const firstNavButton = document.querySelector('.nav-btn[data-section]');
        if (firstNavButton) {
            switchPage(firstNavButton.dataset.section);
        }
        renderMath();
    </script>
</body>
</html>












