<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>优化问题实验室</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            startup: {
                pageReady: () => MathJax.startup.defaultPageReady()
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script defer src="../common-assets/js/mathjax-3.2.2-tex-svg.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --primary-light: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #1f2937;
            --white: #ffffff;
            --border: #e5e7eb;
            --h1-size: 22px;
            --h3-size: 18px;
            --text-size: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }

        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
            font-size: var(--text-size);
            background: var(--gray-50);
            color: var(--gray-700);
        }

        .container {
            width: 100%;
            max-width: 1400px;
            height: min(100vh, 700px);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.12);
            overflow: hidden;
        }

        .header {
            height: 44px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header h1 {
            font-size: var(--h1-size);
            font-weight: 600;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 120px;
            background: var(--gray-50);
            border-right: 1px solid var(--border);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-btn {
            padding: 8px 10px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            cursor: pointer;
            text-align: left;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .nav-btn:hover {
            background: var(--gray-100);
        }

        .nav-btn.active {
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.35);
        }

        .page-content {
            display: none;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 18px;
            padding: 16px;
            height: 100%;
        }

        .page-content.active {
            display: grid;
        }

        .column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.05);
        }

        .card h3 {
            font-size: var(--h3-size);
            color: var(--primary-dark);
        }

        .card p {
            color: var(--gray-600);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .info-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 15px;
        }

        .info-item strong {
            display: block;
            margin-bottom: 6px;
            color: var(--primary);
        }

        .tag-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            background: var(--gray-100);
            color: var(--gray-500);
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 999px;
        }

        .status-box {
            background: #eef2ff;
            border: 1px dashed rgba(79, 70, 229, 0.4);
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
            color: var(--primary-dark);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 12px;
        }

        .control-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-row label {
            font-weight: 600;
            color: var(--gray-600);
        }

        select, input[type="range"] {
            flex: 1;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
            font-size: 15px;
        }

        .action-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: var(--white);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .action-btn.secondary {
            background: var(--white);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.25);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
        }

        .metric {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
        }

        .metric strong {
            display: block;
            font-size: 20px;
            color: var(--primary);
        }

        .chart-wrapper {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 12px;
            background: var(--gray-50);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        canvas {
            width: 100%;
            height: 240px;
            border-radius: 10px;
            background: var(--white);
        }

        .legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 14px;
            color: var(--gray-600);
        }

        .legend span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .legend i {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            display: inline-block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th, td {
            border: 1px solid var(--gray-200);
            padding: 8px 10px;
            text-align: center;
        }

        thead {
            background: var(--gray-100);
            color: var(--primary-dark);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .quiz-option {
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            text-align: left;
            transition: background 0.2s ease, border 0.2s ease;
        }

        .quiz-option.correct {
            border-color: var(--success);
            background: #ecfdf5;
            color: #047857;
        }

        .quiz-option.wrong {
            border-color: var(--danger);
            background: #fee2e2;
            color: #b91c1c;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 14px;
            color: var(--gray-600);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            border: 1px solid var(--gray-200);
            background: var(--gray-50);
            border-radius: 8px;
            padding: 8px 10px;
        }

        @media (max-width: 1200px) {
            .page-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>优化问题实验室</h1>
            <p>从导数出发寻找最优方案</p>
        </header>
        <div class="main">
            <nav class="sidebar">
                <button class="nav-btn active" data-section="model">模型理解</button>
                <button class="nav-btn" data-section="compare">方案比较</button>
                <button class="nav-btn" data-section="practice">案例训练</button>
            </nav>
            <section class="content">
                <div class="page-content active" id="model">
                    <div class="column">
                        <div class="card">
                            <h3>实验导览</h3>
                            <p>优化问题关注“最大”“最小”。通过导数判断趋势，我们可以迅速定位最佳方案，并解释其现实含义。</p>
                            <div class="tag-list">
                                <span class="tag">最值</span>
                                <span class="tag">导数</span>
                                <span class="tag">图像</span>
                                <span class="tag">方案</span>
                            </div>
                            <div class="status-box" id="modelStatus">选择场景后显示最优解。</div>
                        </div>
                        <div class="card">
                            <h3>操作步骤</h3>
                            <div class="info-grid">
                                <div class="info-item"><strong>① 函数建模</strong>把目标量写成变量 $x$ 的函数。</div>
                                <div class="info-item"><strong>② 求导分析</strong>列出 $f'(x)$，解方程或判断符号。</div>
                                <div class="info-item"><strong>③ 比较取值</strong>把端点与临界点代入 $f(x)$。</div>
                                <div class="info-item"><strong>④ 翻译结论</strong>说明“导数为零”对应的现实意义。</div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>进度提示</h3>
                            <div class="info-grid">
                                <div class="info-item" id="stepBadge1"><strong>任务 A</strong>读懂模型与图像。</div>
                                <div class="info-item" id="stepBadge2"><strong>任务 B</strong>比较方案差异。</div>
                                <div class="info-item" id="stepBadge3"><strong>任务 C</strong>解释最优方案。</div>
                                <div class="info-item" id="stepBadge4"><strong>任务 D</strong>独立完成练习。</div>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>优化模型面板</h3>
                            <div class="controls">
                                <div class="control-row">
                                    <label for="scenarioSelect">选择场景</label>
                                    <select id="scenarioSelect"></select>
                                </div>
                                <div class="control-row">
                                    <label for="variableSlider" id="variableLabel">自变量</label>
                                    <input type="range" id="variableSlider" min="0" max="10" step="0.1" value="1">
                                    <span id="variableValue">x = 1.00</span>
                                </div>
                                <div class="control-row">
                                    <button class="action-btn" id="autoScan">自动探索</button>
                                    <button class="action-btn secondary" id="resetScenario">重置</button>
                                </div>
                                <div class="metric-grid">
                                    <div class="metric"><span>目标值</span><strong id="objectiveValue">0.00</strong></div>
                                    <div class="metric"><span>导数</span><strong id="derivativeValue">0.00</strong></div>
                                    <div class="metric"><span>结论</span><strong id="optimalHint">待判断</strong></div>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="objectiveCanvas"></canvas>
                                <div class="legend">
                                    <span><i style="background:#2563eb"></i> 目标函数</span>
                                    <span><i style="background:#10b981"></i> 最优位置</span>
                                    <span><i style="background:#f97316"></i> 当前选择</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>最优方案总结</h3>
                            <p id="scenarioSummary">最优方案将在此展示。</p>
                            <div class="status-box" id="scenarioTips">导数符号说明了目标值随 $x$ 的变化方向。</div>
                        </div>
                    </div>
                </div>
                <div class="page-content" id="compare">
                    <div class="column">
                        <div class="card">
                            <h3>方案评估表</h3>
                            <table>
                                <thead><tr><th>方案</th><th>$x$</th><th>目标值</th><th>评价</th></tr></thead>
                                <tbody id="planTable"></tbody>
                            </table>
                        </div>
                        <div class="card">
                            <h3>关键步骤</h3>
                            <div class="info-grid" id="stepList"></div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>灵敏度分析</h3>
                            <div class="chart-wrapper">
                                <canvas id="sensitivityCanvas"></canvas>
                                <div class="legend">
                                    <span><i style="background:#0ea5e9"></i> $f'(x)$</span>
                                    <span><i style="background:#f59e0b"></i> 临界点</span>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>应用讨论</h3>
                            <p id="applicationNotes">切换场景后会显示行业中的应用解释。</p>
                            <div class="status-box">用“导数为零”“导数改变符号”描述最优方案形成的原因。</div>
                        </div>
                    </div>
                </div>
                <div class="page-content" id="practice">
                    <div class="column">
                        <div class="card">
                            <h3>案例训练</h3>
                            <p>选择正确的方案或结论，说明你的判断依据。</p>
                            <div class="control-row">
                                <button class="action-btn" id="startExercise">开始练习</button>
                                <button class="action-btn secondary" id="nextExercise" disabled>下一题</button>
                            </div>
                            <div id="exercisePanel" style="display:none; flex-direction:column; gap:12px;">
                                <div class="status-box" id="exerciseStem">题目加载中...</div>
                                <div class="quiz-options" id="exerciseOptions"></div>
                                <div class="status-box" id="exerciseFeedback">请选择答案。</div>
                            </div>
                        </div>
                        <div class="card">
                            <h3>练习统计</h3>
                            <div class="metric-grid">
                                <div class="metric"><span>已作答</span><strong id="exerciseTotal">0</strong></div>
                                <div class="metric"><span>正确数</span><strong id="exerciseCorrect">0</strong></div>
                                <div class="metric"><span>平均得分</span><strong id="exerciseScore">0</strong></div>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="card">
                            <h3>复盘记录</h3>
                            <div class="history-list" id="exerciseHistory"></div>
                        </div>
                        <div class="card">
                            <h3>课堂提示</h3>
                            <p>把“导数为正/负”的结论翻译成实际语言，如“切角再增大会让体积下降”。</p>
                            <div class="status-box">请把你的判断写在学习单上，并和同伴说明推理过程。</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <script>
        function renderMath() {
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise().catch(err => console.warn('渲染失败', err));
            }
        }

        const scenarios = {
            box: {
                label: '纸板开口箱体',
                description: '从 $30\\text{cm}\times20\\text{cm}$ 的纸板四角裁去边长 $x$ 的正方形并折起侧面，体积 $V(x)=x(30-2x)(20-2x)$。',
                domain: [0.5, 8.5],
                objective: x => x * (30 - 2 * x) * (20 - 2 * x),
                derivative: x => 12 * x * x - 200 * x + 600,
                unit: 'cm³',
                variableLabel: '切角边长 x (cm)',
                steps: [
                    '建立体积函数 $V(x)=x(30-2x)(20-2x)$。',
                    '求导得到 $V'(x)=12x^2-200x+600$。',
                    '解 $V'(x)=0$ 得 $x\approx3.9$，比较端点确定最大值。',
                    '解释：裁剪约 3.9cm 时体积最大，约 $1485\text{cm}^3$。'
                ],
                plans: [
                    { name: '方案 A', x: 2, note: '体积偏小，材料利用不足。' },
                    { name: '方案 B', x: 3.5, note: '接近最优，可作为备用方案。' },
                    { name: '参考方案', x: 3.9, note: '导数为零且为最大值。' }
                ],
                application: '包装设计：在给定纸板尺寸下获得最大容积。'
            },
            fence: {
                label: '围栏最大面积',
                description: '使用 120m 围栏围成三边矩形，面积 $A(x)=x(120-2x)$。',
                domain: [1, 59],
                objective: x => x * (120 - 2 * x),
                derivative: x => 120 - 4 * x,
                unit: 'm²',
                variableLabel: '垂直墙壁长度 x (m)',
                steps: [
                    '面积函数 $A(x)=x(120-2x)$。',
                    '导数 $A'(x)=120-4x$。',
                    '令导数为零得 $x=30$，端点面积为 0，可判定最大值。',
                    '解释：垂直墙壁 30m 时面积最大，为 1800m²。'
                ],
                plans: [
                    { name: '方案一', x: 20, note: '面积 1600m²，可继续提升。' },
                    { name: '方案二', x: 30, note: '面积 1800m²，导数由正转负。' },
                    { name: '方案三', x: 40, note: '面积回落至 1600m²。' }
                ],
                application: '畜舍和菜地的围栏规划问题。'
            },
            production: {
                label: '生产利润优化',
                description: '利润函数 $P(q)=-0.02q^2+2q-30$（单位：千元），其中 $q$ 为产量。',
                domain: [0, 120],
                objective: q => -0.02 * q * q + 2 * q - 30,
                derivative: q => -0.04 * q + 2,
                unit: '千元',
                variableLabel: '产量 q (件)',
                steps: [
                    '利润函数 $P(q)=-0.02q^2+2q-30$。',
                    '导数 $P'(q)=-0.04q+2$。',
                    '令导数为零得 $q=50$，端点利润更低。',
                    '解释：产量 50 件时利润最大，约 20 千元。'
                ],
                plans: [
                    { name: '试产 30 件', x: 30, note: '利润约 6 千元，尚未最优。' },
                    { name: '推荐产量', x: 50, note: '利润约 20 千元，达到最大。' },
                    { name: '超量 90 件', x: 90, note: '利润下降，导数为负。' }
                ],
                application: '企业生产计划与边际分析。'
            }
        };

        const exercises = [
            {
                stem: "若成本函数 $C(x)=x^3-9x^2+24x$，何处成本最小？",
                options: ['x=0', 'x=2', 'x=3', 'x=6'],
                answer: 1,
                explain: "$C'(x)=3x^2-18x+24=3(x-2)(x-4)$，在 $x=2$ 处导数由负变正，对应极小值。"
            },
            {
                stem: "利润函数 $P(q)=-0.01q^2+1.2q-15$，若导数为 $P'(q)=-0.02q+1.2$，应选择的产量是？",
                options: ['q=0', 'q=20', 'q=40', 'q=60'],
                answer: 3,
                explain: "令 $P'(q)=-0.02q+1.2=0$ 得 $q=60$，此时利润最大。"
            },
            {
                stem: "使用 40m 围栏围成长方形（四边），面积 $A(x)=x(20-x)$。最大面积时边长 $x$ 为？",
                options: ['5m', '10m', '15m', '20m'],
                answer: 1,
                explain: "$A'(x)=20-2x$，令导数为零得 $x=10$，面积最大。"
            },
            {
                stem: "若导数 $f'(x)$ 在 $x=4$ 左侧为正、右侧为负，可得结论？",
                options: ['$x=4$ 为最小值', '$x=4$ 为最大值', '函数无最值', '函数先减后增'],
                answer: 1,
                explain: '导数由正变负说明函数先升后降，$x=4$ 为极大值。'
            }
        ];
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');
        const scenarioSelect = document.getElementById('scenarioSelect');
        const variableSlider = document.getElementById('variableSlider');
        const variableLabel = document.getElementById('variableLabel');
        const variableValue = document.getElementById('variableValue');
        const autoScanBtn = document.getElementById('autoScan');
        const resetBtn = document.getElementById('resetScenario');
        const objectiveValue = document.getElementById('objectiveValue');
        const derivativeValue = document.getElementById('derivativeValue');
        const optimalHint = document.getElementById('optimalHint');
        const modelStatus = document.getElementById('modelStatus');
        const scenarioSummary = document.getElementById('scenarioSummary');
        const scenarioTips = document.getElementById('scenarioTips');
        const planTable = document.getElementById('planTable');
        const stepList = document.getElementById('stepList');
        const applicationNotes = document.getElementById('applicationNotes');
        const exercisePanel = document.getElementById('exercisePanel');
        const exerciseStem = document.getElementById('exerciseStem');
        const exerciseOptions = document.getElementById('exerciseOptions');
        const exerciseFeedback = document.getElementById('exerciseFeedback');
        const startExerciseBtn = document.getElementById('startExercise');
        const nextExerciseBtn = document.getElementById('nextExercise');
        const exerciseTotal = document.getElementById('exerciseTotal');
        const exerciseCorrect = document.getElementById('exerciseCorrect');
        const exerciseScore = document.getElementById('exerciseScore');
        const exerciseHistory = document.getElementById('exerciseHistory');
        const stepBadges = [
            document.getElementById('stepBadge1'),
            document.getElementById('stepBadge2'),
            document.getElementById('stepBadge3'),
            document.getElementById('stepBadge4')
        ];

        const objectiveCanvas = document.getElementById('objectiveCanvas');
        const sensitivityCanvas = document.getElementById('sensitivityCanvas');

        let currentScenarioKey = 'box';
        let activeSection = 'model';
        let scanId = null;
        let scanningForward = true;
        let exerciseIndex = -1;
        let stats = { total: 0, correct: 0 };
        const historyRecords = [];

        function setupCanvas(canvas, fallbackWidth = 420, fallbackHeight = 240) {
            if (!canvas) return null;
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            const width = rect.width || canvas.clientWidth || fallbackWidth;
            const height = rect.height || canvas.clientHeight || fallbackHeight;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;
            const ctx = canvas.getContext('2d');
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);
            return { ctx, width, height };
        }

        function toCanvasX(x, width, domain, padding = 40) {
            return padding + (x - domain[0]) / (domain[1] - domain[0]) * (width - 2 * padding);
        }

        function toCanvasY(y, height, range, padding = 40) {
            return height - (padding + (y - range[0]) / (range[1] - range[0]) * (height - 2 * padding));
        }

        function drawAxes(ctx, width, height, domain, range) {
            const padding = 40;
            ctx.save();
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            const gridCount = 6;
            for (let i = 0; i <= gridCount; i++) {
                const gx = padding + (width - 2 * padding) * (i / gridCount);
                ctx.beginPath();
                ctx.moveTo(gx, padding);
                ctx.lineTo(gx, height - padding);
                ctx.stroke();

                const gy = padding + (height - 2 * padding) * (i / gridCount);
                ctx.beginPath();
                ctx.moveTo(padding, gy);
                ctx.lineTo(width - padding, gy);
                ctx.stroke();
            }
            const zeroX = padding + (-domain[0]) / (domain[1] - domain[0]) * (width - 2 * padding);
            const zeroY = height - (padding + (-range[0]) / (range[1] - range[0]) * (height - 2 * padding));
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 1.4;
            if (zeroY >= padding && zeroY <= height - padding) {
                ctx.beginPath();
                ctx.moveTo(padding, zeroY);
                ctx.lineTo(width - padding, zeroY);
                ctx.stroke();
            }
            if (zeroX >= padding && zeroX <= width - padding) {
                ctx.beginPath();
                ctx.moveTo(zeroX, padding);
                ctx.lineTo(zeroX, height - padding);
                ctx.stroke();
            }
            ctx.restore();
        }

        function formatNumber(value, digits = 2) {
            if (!Number.isFinite(value)) return '∞';
            if (Math.abs(value) >= 1000 || Math.abs(value) < 0.001) return value.toExponential(2);
            return value.toFixed(digits);
        }

        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function sampleScenario(config) {
            const points = [];
            const domain = config.domain;
            const steps = 320;
            let minY = Infinity;
            let maxY = -Infinity;
            for (let i = 0; i <= steps; i++) {
                const x = domain[0] + (i / steps) * (domain[1] - domain[0]);
                const fx = config.objective(x);
                const dx = config.derivative(x);
                if (Number.isFinite(fx)) {
                    minY = Math.min(minY, fx);
                    maxY = Math.max(maxY, fx);
                }
                points.push({ x, fx, dx });
            }
            if (!Number.isFinite(minY) || !Number.isFinite(maxY)) {
                minY = -5;
                maxY = 5;
            }
            if (Math.abs(maxY - minY) < 1e-3) {
                minY -= 1;
                maxY += 1;
            }
            const padding = (maxY - minY) * 0.2 || 1;
            return { points, range: [minY - padding, maxY + padding] };
        }

        function findOptimum(config) {
            const { domain } = config;
            let bestX = domain[0];
            let bestValue = config.objective(bestX);
            const step = (domain[1] - domain[0]) / 500;
            for (let x = domain[0]; x <= domain[1]; x += step) {
                const value = config.objective(x);
                if (value > bestValue) {
                    bestValue = value;
                    bestX = x;
                }
            }
            return { x: bestX, value: bestValue };
        }

        function updateBadges(level) {
            stepBadges.forEach((badge, index) => {
                if (!badge) return;
                if (index <= level) {
                    badge.style.background = '#eef2ff';
                    badge.style.border = '1px solid var(--primary)';
                } else {
                    badge.style.background = 'var(--gray-50)';
                    badge.style.border = '1px solid var(--gray-200)';
                }
            });
        }

        function drawObjectiveCanvas() {
            const setup = setupCanvas(objectiveCanvas);
            if (!setup) return;
            const { ctx, width, height } = setup;
            const config = scenarios[currentScenarioKey];
            const { points, range } = sampleScenario(config);
            const domain = config.domain;
            drawAxes(ctx, width, height, domain, range);
            ctx.save();
            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2.2;
            ctx.beginPath();
            let started = false;
            points.forEach(({ x, fx }) => {
                if (!Number.isFinite(fx)) { started = false; return; }
                const cx = toCanvasX(x, width, domain);
                const cy = toCanvasY(fx, height, range);
                if (!started) { ctx.moveTo(cx, cy); started = true; }
                else ctx.lineTo(cx, cy);
            });
            ctx.stroke();
            ctx.restore();
            const optimum = findOptimum(config);
            const optX = toCanvasX(optimum.x, width, domain);
            const optY = toCanvasY(optimum.value, height, range);
            ctx.save();
            ctx.fillStyle = '#10b981';
            ctx.beginPath();
            ctx.arc(optX, optY, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.font = '13px "Segoe UI", sans-serif';
            ctx.fillText('最优', optX + 6, optY - 6);
            ctx.restore();
            const currentX = parseFloat(variableSlider.value);
            const currentValue = config.objective(currentX);
            ctx.save();
            ctx.fillStyle = '#f97316';
            ctx.beginPath();
            ctx.arc(toCanvasX(currentX, width, domain), toCanvasY(currentValue, height, range), 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function drawSensitivityCanvas() {
            const setup = setupCanvas(sensitivityCanvas, 420, 220);
            if (!setup) return;
            const { ctx, width, height } = setup;
            const config = scenarios[currentScenarioKey];
            const { points } = sampleScenario(config);
            const domain = config.domain;
            let minY = Infinity;
            let maxY = -Infinity;
            points.forEach(({ dx }) => {
                if (Number.isFinite(dx)) {
                    minY = Math.min(minY, dx);
                    maxY = Math.max(maxY, dx);
                }
            });
            if (!Number.isFinite(minY) || !Number.isFinite(maxY)) {
                minY = -5;
                maxY = 5;
            }
            const padding = (maxY - minY) * 0.2 || 1;
            const range = [minY - padding, maxY + padding];
            drawAxes(ctx, width, height, domain, range);
            ctx.save();
            ctx.strokeStyle = '#0ea5e9';
            ctx.lineWidth = 2;
            ctx.beginPath();
            let started = false;
            points.forEach(({ x, dx }) => {
                if (!Number.isFinite(dx)) { started = false; return; }
                const cx = toCanvasX(x, width, domain);
                const cy = toCanvasY(dx, height, range);
                if (!started) { ctx.moveTo(cx, cy); started = true; }
                else ctx.lineTo(cx, cy);
            });
            ctx.stroke();
            ctx.restore();
            const optimum = findOptimum(config);
            ctx.save();
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(toCanvasX(optimum.x, width, domain), toCanvasY(0, height, range), 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function populateScenarioOptions() {
            Object.entries(scenarios).forEach(([key, config]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = config.label;
                scenarioSelect.appendChild(option);
            });
            scenarioSelect.value = currentScenarioKey;
        }

        function updateScenarioInfo() {
            const config = scenarios[currentScenarioKey];
            variableLabel.textContent = config.variableLabel;
            modelStatus.textContent = config.description;
            const optimum = findOptimum(config);
            scenarioSummary.innerHTML = `最优位置约在 $x=${formatNumber(optimum.x, 2)}$，目标值约为 ${formatNumber(optimum.value, 2)} ${config.unit}。`;
            scenarioTips.textContent = '导数为零的位置需要通过比较确认是最大值还是最小值。';
            applicationNotes.textContent = config.application;
            planTable.innerHTML = config.plans.map(plan => {
                const value = config.objective(plan.x);
                return `<tr><td>${plan.name}</td><td>${formatNumber(plan.x, 2)}</td><td>${formatNumber(value, 2)} ${config.unit}</td><td>${plan.note}</td></tr>`;
            }).join('');
            stepList.innerHTML = config.steps.map(step => `<div class="info-item">${step}</div>`).join('');
            renderMath();
        }

        function updateCurrentValues() {
            const config = scenarios[currentScenarioKey];
            const x = parseFloat(variableSlider.value);
            const value = config.objective(x);
            const derivative = config.derivative(x);
            variableValue.textContent = `${config.variableLabel.split(' ')[0]} = ${formatNumber(x, 2)}`;
            objectiveValue.textContent = formatNumber(value, 2);
            derivativeValue.textContent = formatNumber(derivative, 3);
            optimalHint.textContent = derivative > 0 ? '继续增大提高目标值' : derivative < 0 ? '继续增大目标值下降' : '导数为零，检查是否最优';
        }

        function stopScan() {
            if (scanId) {
                cancelAnimationFrame(scanId);
                scanId = null;
            }
            autoScanBtn.textContent = '自动探索';
        }

        function animateSlider() {
            const config = scenarios[currentScenarioKey];
            const step = (config.domain[1] - config.domain[0]) / 240;
            let value = parseFloat(variableSlider.value);
            value += scanningForward ? step : -step;
            if (value >= config.domain[1] || value <= config.domain[0]) {
                scanningForward = !scanningForward;
                value = clamp(value, config.domain[0], config.domain[1]);
            }
            variableSlider.value = value.toFixed(3);
            updateCurrentValues();
            drawObjectiveCanvas();
            scanId = requestAnimationFrame(animateSlider);
        }

        function resetScenario() {
            const config = scenarios[currentScenarioKey];
            const mid = (config.domain[0] + config.domain[1]) / 2;
            variableSlider.min = config.domain[0];
            variableSlider.max = config.domain[1];
            variableSlider.step = (config.domain[1] - config.domain[0]) / 200;
            variableSlider.value = mid.toFixed(2);
            updateCurrentValues();
            drawObjectiveCanvas();
            drawSensitivityCanvas();
            updateScenarioInfo();
            updateBadges(0);
        }

        function switchSection(section) {
            activeSection = section;
            pages.forEach(page => page.classList.toggle('active', page.id === section));
            navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.section === section));
            if (section === 'model') {
                drawObjectiveCanvas();
                updateBadges(0);
            }
            if (section === 'compare') {
                drawSensitivityCanvas();
                updateBadges(1);
            }
            if (section === 'practice') {
                updateBadges(3);
            }
            renderMath();
        }

        function recordHistory(question, answer, correct) {
            historyRecords.unshift({ question, answer, correct });
            if (historyRecords.length > 6) historyRecords.pop();
            exerciseHistory.innerHTML = historyRecords.map(item => {
                const prefix = item.correct ? '✅' : '❌';
                return `<div class="history-item"><span>${prefix} ${item.question}</span><span>${item.answer}</span></div>`;
            }).join('');
        }

        function updateStats() {
            exerciseTotal.textContent = stats.total;
            exerciseCorrect.textContent = stats.correct;
            const score = stats.total === 0 ? 0 : Math.round((stats.correct / stats.total) * 100);
            exerciseScore.textContent = `${score}`;
        }

        function showExercise() {
            if (exerciseIndex < 0 || exerciseIndex >= exercises.length) return;
            const question = exercises[exerciseIndex];
            exerciseStem.innerHTML = question.stem;
            exerciseOptions.innerHTML = '';
            question.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.type = 'button';
                btn.textContent = option;
                btn.addEventListener('click', () => selectExercise(index));
                exerciseOptions.appendChild(btn);
            });
            exerciseFeedback.textContent = '请选择答案。';
            renderMath();
        }

        function selectExercise(index) {
            const question = exercises[exerciseIndex];
            const buttons = exerciseOptions.querySelectorAll('.quiz-option');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                if (i === question.answer) btn.classList.add('correct');
                else if (i === index) btn.classList.add('wrong');
            });
            const isCorrect = index === question.answer;
            stats.total += 1;
            if (isCorrect) stats.correct += 1;
            exerciseFeedback.textContent = isCorrect ? '回答正确！记得说明导数符号。' : `正确答案：${question.options[question.answer]}。${question.explain}`;
            recordHistory(question.stem, question.options[index] || '未选择', isCorrect);
            updateStats();
            nextExerciseBtn.disabled = false;
            renderMath();
        }

        function startExercise() {
            exerciseIndex = Math.floor(Math.random() * exercises.length);
            exercisePanel.style.display = 'flex';
            nextExerciseBtn.disabled = true;
            showExercise();
            updateBadges(2);
        }

        function nextExercise() {
            exerciseIndex = (exerciseIndex + 1) % exercises.length;
            nextExerciseBtn.disabled = true;
            showExercise();
        }

        function initNavigation() {
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.section !== activeSection) {
                        stopScan();
                        switchSection(btn.dataset.section);
                    }
                });
            });
        }

        function initControls() {
            populateScenarioOptions();
            resetScenario();
            updateScenarioInfo();
            drawSensitivityCanvas();
            renderMath();

            scenarioSelect.addEventListener('change', () => {
                currentScenarioKey = scenarioSelect.value;
                stopScan();
                resetScenario();
                updateScenarioInfo();
                drawSensitivityCanvas();
            });

            variableSlider.addEventListener('input', () => {
                updateCurrentValues();
                drawObjectiveCanvas();
            });

            autoScanBtn.addEventListener('click', () => {
                if (scanId) {
                    stopScan();
                } else {
                    autoScanBtn.textContent = '暂停探索';
                    scanId = requestAnimationFrame(animateSlider);
                }
            });

            resetBtn.addEventListener('click', resetScenario);

            startExerciseBtn.addEventListener('click', () => {
                startExercise();
                updateBadges(3);
            });

            nextExerciseBtn.addEventListener('click', nextExercise);

            window.addEventListener('resize', () => {
                if (activeSection === 'model') drawObjectiveCanvas();
                if (activeSection === 'compare') drawSensitivityCanvas();
            });
        }

        initNavigation();
        initControls();
        switchSection('model');
        updateStats();
    </script>
</body>
</html>
