<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>不定积分知识点整理</title>

    <!-- 字体样式 -->
    <link rel="stylesheet" href="../../common-assets/css/fonts.css">

    <!-- 主要样式 -->
    <style>
        :root {
            --primary-color: #2c4cc3;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #9b59b6;
            --bg-color: #f8f9fa;
            --text-color: #2c3e50;
            --light-gray: #f5f7fa;
            --dark-gray: #343a40;
            --border-color: #e2e8f0;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --deepseek-primary: #3498db;
            --deepseek-secondary: #2980b9;
        }

        /* 基础样式 */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
        }

        /* 容器 */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 简化的导航栏 */
        .navbar {
            background: none;
            box-shadow: none;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
        }

        .navbar-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            text-decoration: none;
        }

        .navbar-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 20px;
        }

        .nav-link {
            color: #666;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background-color: var(--light-gray);
            color: var(--primary-color);
        }

        /* 导出PDF按钮 */
        .export-pdf-nav-btn {
            padding: 8px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .export-pdf-nav-btn:hover {
            background-color: #1e3a8a;
            transform: translateY(-2px);
        }

        /* 节段样式 */
        .section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            color: #333;
            font-size: 1.3rem;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title i {
            margin-right: 8px;
            color: #555;
        }

        /* 知识点幻灯片样式 - 简化版 */
        .slides-container {
            position: relative;
            width: 100%;
            min-height: 650px;
            margin-bottom: 20px;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .slide.active {
            opacity: 1;
            pointer-events: auto;
        }

        .slide-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            width: 95%;
            margin: 0 auto;
            max-width: 1000px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .slide-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .slide-number {
            position: absolute;
            top: -15px;
            left: -10px;
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 3px 8px rgba(44, 76, 195, 0.3);
            border: 3px solid white;
        }

        .slide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .slide-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin: 0;
        }

        .slide-content {
            font-size: 1rem;
            line-height: 1.8;
        }

        /* 圆形导航 - 简化版 */
        .circle-nav {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .circle-num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f0f0f0;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .circle-num:hover {
            transform: scale(1.1);
            background: #e0e0e0;
        }

        .circle-num.active {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        /* 筛选器 - 简化版 */
        .filter-section {
            margin-bottom: 20px;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--light-gray);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-btn:hover {
            background: #e0e0e0;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-btn .count {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* 题目定位器 - 简化版 */
        .locator-section {
            margin-bottom: 5px;
            padding: 5px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
        }

        .locator-title {
            display: flex;
            align-items: center;
            margin-bottom: 1px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .locator-title i {
            margin-right: 8px;
        }

        .locator-input-container {
            display: flex;
            gap: 10px;
        }

        .problem-number-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .problem-number-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .locate-problem-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .locate-problem-btn:hover {
            background-color: #1e3a8a;
        }

        /* 习题项目 - 简化版 */
        .exercise-item {
            margin-bottom: 15px;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
            overflow: hidden;
        }

        .exercise-item:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .exercise-item.highlight {
            animation: highlight-pulse 2s;
        }

        @keyframes highlight-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(44, 76, 195, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(44, 76, 195, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(44, 76, 195, 0);
            }
        }

        .exercise-header {
            padding: 15px 20px;
            background: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .exercise-title-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .exercise-number {
            background: var(--primary-color);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .exercise-title {
            font-size: 1.1rem;
            margin: 0;
            color: var(--text-color);
        }

        .exercise-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .exercise-type,
        .exercise-difficulty,
        .exercise-category,
        .exercise-method {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .exercise-type {
            background: var(--secondary-color);
            color: white;
        }

        .exercise-difficulty.easy {
            background: var(--success-color);
            color: white;
        }

        .exercise-difficulty.medium {
            background: var(--warning-color);
            color: white;
        }

        .exercise-difficulty.hard {
            background: var(--accent-color);
            color: white;
        }

        .exercise-category {
            background: var(--info-color);
            color: white;
        }

        .exercise-method {
            background: #34495e;
            color: white;
        }

        .exercise-content {
            padding: 20px;
        }

        .exercise-question {
            line-height: 1.8;
            padding: 15px;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        /* 按钮样式 - 简化版 */
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 8px;
            transition: all 0.3s;
            gap: 6px;
        }

        .solution-toggle {
            background: var(--primary-color);
            color: white;
        }

        .solution-toggle:hover {
            background-color: #1e3a8a;
            transform: translateY(-1px);
        }

        .ai-analysis-btn {
            background: var(--deepseek-primary);
            color: white;
        }

        .ai-analysis-btn:hover {
            background-color: var(--deepseek-secondary);
            transform: translateY(-1px);
        }

        .fullscreen-btn {
            background: #3498db;
            color: white;
        }

        .fullscreen-btn:hover {
            background-color: #2980b9;
            transform: translateY(-1px);
        }

        /* 解析内容 - 简化版 */
        .solution-content {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border-left: 3px solid var(--primary-color);
        }

        .solution-content.show {
            display: block;
        }

        .solution-section {
            margin-top: 20px;
        }

        .explanation,
        .answer {
            margin: 15px 0;
        }

        .explanation h4,
        .answer h4 {
            color: var(--primary-color);
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
        }

        .explanation h4 i,
        .answer h4 i {
            margin-right: 8px;
        }

        .explanation-content {
            line-height: 1.8;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
        }

        /* 全局AI查询 - 简化版 */
        .global-deepseek-container {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .global-deepseek-title {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: var(--deepseek-primary);
            font-size: 1.2rem;
        }

        .global-deepseek-title i {
            margin-right: 10px;
        }

        .api-key-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }

        .api-key-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .deepseek-api-key {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .deepseek-api-key:focus {
            border-color: var(--deepseek-primary);
            outline: none;
        }

        .global-deepseek-btn {
            padding: 10px 20px;
            background: var(--deepseek-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .global-deepseek-btn:hover {
            background-color: var(--deepseek-secondary);
            transform: translateY(-1px);
        }

        .api-key-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
        }

        .text-button {
            background: none;
            border: none;
            color: var(--deepseek-primary);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
        }

        .text-button:hover {
            text-decoration: underline;
        }

        .api-key-valid {
            color: var(--success-color);
        }

        .api-key-invalid {
            color: var(--accent-color);
        }

        .global-deepseek-input-container {
            display: flex;
            gap: 10px;
        }

        .global-deepseek-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .global-deepseek-input:focus {
            border-color: var(--deepseek-primary);
            outline: none;
        }

        /* DeepSeek模态框 - 简化版 */
        .deepseek-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .deepseek-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .deepseek-modal-content {
            background-color: white;
            width: 800px;
            max-width: 90%;
            height: 80vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s;
        }

        .deepseek-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--deepseek-primary);
            color: white;
        }

        .deepseek-modal-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin: 0;
        }

        .deepseek-modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .deepseek-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .deepseek-chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .deepseek-chat-message {
            margin-bottom: 15px;
            max-width: 85%;
            animation: fadeIn 0.3s;
        }

        .deepseek-chat-user {
            margin-left: auto;
            background: #dcf8c6;
            padding: 10px 15px;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .deepseek-chat-ai {
            margin-right: auto;
            background: white;
            padding: 10px 15px;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-left: 3px solid var(--deepseek-primary);
        }

        .deepseek-chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .deepseek-chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .deepseek-chat-input:focus {
            border-color: var(--deepseek-primary);
            outline: none;
        }

        .deepseek-chat-send {
            padding: 10px 20px;
            background: var(--deepseek-primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .deepseek-chat-send:hover {
            background-color: var(--deepseek-secondary);
            transform: scale(1.05);
        }

        /* 全屏模式 - 新增逐行显示功能 */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            overflow: hidden;
            flex-direction: column;
        }

        .fullscreen-overlay.show {
            display: flex;
        }

        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .fullscreen-title {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .fullscreen-controls {
            display: flex;
            gap: 10px;
        }

        .fullscreen-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .fullscreen-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .fullscreen-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            cursor: pointer;
        }

        .fullscreen-exercise {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .fullscreen-exercise .exercise-header {
            background: none;
            padding: 0 0 20px 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .fullscreen-exercise .exercise-question {
            font-size: 1.2rem;
            line-height: 2;
            padding: 20px;
            background: #f8f9fa;
            margin: 20px 0;
        }

        /* 逐行显示解析样式 */
        .fullscreen-solution-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            min-height: 200px;
            user-select: none;
        }

        .fullscreen-solution-container:hover {
            background: #f0f5ff;
        }

        #fullscreen-solution-lines {
            min-height: 100px;
        }

        .fullscreen-solution-line {
            display: none;
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            animation: slideInLeft 0.5s ease-out;
            border-left: 4px solid var(--primary-color);
            line-height: 1.8;
            font-size: 1.05rem;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .fullscreen-click-hint {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 15px 0;
            padding: 12px 20px;
            background: rgba(44, 76, 195, 0.08);
            border-radius: 8px;
            font-size: 0.95rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.8;
            }

            50% {
                opacity: 1;
            }
        }

        .fullscreen-progress {
            display: flex;
            align-items: center;
            margin-top: 25px;
            font-size: 0.9rem;
            color: #666;
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .fullscreen-progress-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            margin: 0 15px;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .fullscreen-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .fullscreen-answer {
            margin-top: 25px;
            padding: 20px;
            background: rgba(46, 204, 113, 0.08);
            border-left: 4px solid var(--success-color);
            border-radius: 8px;
            display: none;
            animation: slideInLeft 0.5s ease-out;
        }

        .fullscreen-answer-title {
            font-weight: bold;
            color: var(--success-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fullscreen-answer-title::before {
            content: '✓';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: var(--success-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
        }

        /* 点击波纹效果 */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(44, 76, 195, 0.3);
            transform: translate(-50%, -50%) scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }

        .fullscreen-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .fullscreen-nav-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4a6bdf, #2c4cc3);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 500;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .fullscreen-nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .fullscreen-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #cccccc;
        }

        .fullscreen-counter {
            font-size: 1rem;
            color: #666;
            font-weight: 500;
        }

        /* 加载动画 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* 返回顶部按钮 */
        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .scroll-to-top.show {
            opacity: 1;
            visibility: visible;
        }

        .scroll-to-top:hover {
            background-color: #1e3a8a;
            transform: translateY(-5px);
        }

        /* 移动端响应式设计 */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
            }

            .container {
                padding: 10px;
            }

            .navbar-container {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }

            .navbar-brand {
                font-size: 1.3rem;
            }

            .navbar-nav {
                display: none;
            }

            .export-pdf-nav-btn {
                width: 100%;
                text-align: center;
            }

            .slides-container {
                height: 650px;
            }

            .slide-card {
                padding: 20px;
                width: 98%;
            }

            .slide-title {
                font-size: 1.2rem;
            }

            .slide-content {
                font-size: 0.95rem;
            }

            .circle-nav {
                padding: 6px 12px;
                gap: 6px;
            }

            .circle-num {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .filter-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .filter-btn {
                padding: 10px 12px;
                font-size: 0.85rem;
                text-align: center;
                justify-content: center;
            }

            .locator-input-container {
                flex-direction: column;
                gap: 8px;
            }

            .problem-number-input,
            .locate-problem-btn {
                width: 100%;
                font-size: 16px;
            }

            .exercise-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .exercise-meta {
                width: 100%;
                justify-content: flex-start;
            }

            .exercise-type,
            .exercise-difficulty,
            .exercise-category,
            .exercise-method {
                padding: 3px 8px;
                font-size: 0.75rem;
            }

            .btn {
                padding: 8px 14px;
                font-size: 13px;
                margin: 5px 5px 5px 0;
            }

            .deepseek-modal-content {
                width: 95%;
                height: 90vh;
                margin: 5vh auto;
            }

            .deepseek-modal-header {
                padding: 12px 15px;
            }

            .deepseek-modal-title {
                font-size: 1rem;
            }

            .deepseek-chat-container {
                padding: 15px;
            }

            .deepseek-chat-message {
                max-width: 90%;
                font-size: 0.95rem;
            }

            .deepseek-chat-input-container {
                flex-direction: column;
                gap: 8px;
                padding: 12px;
            }

            .deepseek-chat-input,
            .deepseek-chat-send {
                width: 100%;
                font-size: 16px;
            }

            .global-deepseek-container {
                padding: 15px;
            }

            .api-key-input-container,
            .global-deepseek-input-container {
                flex-direction: column;
                gap: 8px;
            }

            .deepseek-api-key,
            .global-deepseek-input,
            .global-deepseek-btn {
                width: 100%;
                font-size: 16px;
            }

            .fullscreen-header {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
            }

            .fullscreen-title {
                font-size: 1.1rem;
            }

            .fullscreen-controls {
                width: 100%;
                justify-content: space-around;
            }

            .fullscreen-control-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .fullscreen-content {
                padding: 15px;
            }

            .fullscreen-exercise {
                padding: 20px;
            }

            .fullscreen-exercise .exercise-question {
                font-size: 1rem;
                padding: 15px;
            }

            .fullscreen-nav {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .fullscreen-nav-btn {
                width: 100%;
                justify-content: center;
            }

            .fullscreen-counter {
                text-align: center;
                order: -1;
            }

            .fullscreen-solution-line {
                padding: 12px 15px;
                font-size: 0.95rem;
            }

            .fullscreen-click-hint {
                font-size: 0.85rem;
                padding: 10px 15px;
            }
        }

        /* 更小屏幕优化 */
        @media (max-width: 480px) {
            .slide-card {
                padding: 15px;
            }

            .filter-container {
                grid-template-columns: 1fr;
            }

            .circle-nav {
                gap: 4px;
                padding: 5px 10px;
            }

            .circle-num {
                width: 26px;
                height: 26px;
                font-size: 0.75rem;
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {

            .filter-btn,
            .btn,
            .locate-problem-btn,
            .global-deepseek-btn,
            .circle-num,
            .fullscreen-nav-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .slide-card:hover,
            .exercise-item:hover {
                transform: none;
                box-shadow: inherit;
            }
        }

        /* 防止iOS缩放 */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea {
            font-size: 16px !important;
        }

        /* 打印样式 */
        @media print {
            body>*:not(#print-content) {
                display: none !important;
            }

            #print-content {
                display: block !important;
                padding: 20px;
                font-size: 12pt;
            }

            #print-content h1 {
                font-size: 24pt;
                margin-bottom: 20px;
            }

            #print-content h2 {
                font-size: 18pt;
                margin-top: 30px;
                margin-bottom: 15px;
                page-break-after: avoid;
            }

            #print-content h3 {
                font-size: 14pt;
                margin-top: 20px;
                margin-bottom: 10px;
            }

            #print-content .exercise-print {
                page-break-inside: avoid;
                margin-bottom: 20px;
                border: 1px solid #ddd;
                padding: 15px;
            }

            #print-content .no-print {
                display: none !important;
            }
        }
    </style>

    <!-- MathJax配置 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                processRefs: true,
                tags: 'ams'
            },
            chtml: {
                fontURL: '../../common-assets/fonts'
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                renderActions: {
                    addMenu: [],
                    checkLoading: [200]
                }
            },
            startup: {
                ready: function() {
                    MathJax.startup.defaultReady();
                    MathJax.startup.promise.then(function() {
                        console.log('MathJax 已完全加载');
                    });
                }
            }
        };
    </script>

    <style>
        .return-home-panel {
            position: fixed;
            top: 16px;
            left: 16px;
            display: flex;
            gap: 10px;
            z-index: 9999;
            flex-wrap: wrap;
        }
        .return-home-panel .return-link {
            padding: 8px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            color: #f8fafc;
            font-size: 14px;
            text-decoration: none;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.25);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .return-home-panel .return-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.35);
        }
        .return-home-panel .return-link.return-main {
            background: rgba(79, 70, 229, 0.85);
        }
        @media (max-width: 640px) {
            .return-home-panel {
                top: 12px;
                left: 12px;
                right: 12px;
                justify-content: center;
            }
            .return-home-panel .return-link {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="return-home-panel">
         <a class="return-link return-sub" href="../index.html">← 返回目录</a>
        <a class="return-link return-main" href="../../index.html">⌂ 返回主站</a>    </div>
    <!-- 简化的导航栏 -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="#" class="navbar-brand">不定积分知识点整理</a>
            <button class="export-pdf-nav-btn" onclick="exportPDF()">
                <i class="fas fa-file-pdf"></i> 导出PDF
            </button>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container">
        <!-- 全局 DeepSeek AI 查询 -->
        <section id="global-ai" class="section global-deepseek-container">
            <div class="global-deepseek-title">
                <i class="fas fa-robot"></i>
                <h3>DeepSeek AI 助手</h3>
            </div>

            <!-- API密钥输入区域 -->
            <div id="api-key-section" class="api-key-section">
                <div class="api-key-input-container">
                    <input type="password" id="deepseek-api-key" class="deepseek-api-key"
                        placeholder="请输入您的DeepSeek API密钥...">
                    <button id="save-api-key-btn" class="global-deepseek-btn">
                        <i class="fas fa-key"></i>
                        保存密钥
                    </button>
                </div>
                <div class="api-key-status">
                    <small id="api-key-status-text">API密钥未设置</small>
                    <button id="clear-api-key-btn" class="text-button" style="display:none;">
                        <i class="fas fa-trash-alt"></i> 清除密钥
                    </button>
                </div>
            </div>

            <div class="global-deepseek-input-container">
                <input type="text" id="global-deepseek-input" class="global-deepseek-input"
                    placeholder="输入您的关于不定积分的问题...">
                <button id="global-deepseek-btn" class="global-deepseek-btn">
                    <i class="fas fa-paper-plane"></i>
                    提问
                </button>
            </div>
        </section>

        <!-- 知识点部分 -->
        <section id="knowledge" class="section">
            <h2 class="section-title">
                <div>
                    <i class="fas fa-book"></i> 重要知识点
                    <span style="font-size: 0.7em; color: #999; margin-left: 10px;">
                        <i class="fas fa-hand-pointer"></i> 点击卡片切换
                    </span>
                </div>
                <div class="circle-nav">
                    <span class="circle-num active" data-slide="0">览</span>
                    <span class="circle-num" data-slide="1">概</span>
                    <span class="circle-num" data-slide="2">性</span>
                    <span class="circle-num" data-slide="3">式</span>
                    <span class="circle-num" data-slide="4">式</span>
                    <span class="circle-num" data-slide="5">扩</span>
                    <span class="circle-num" data-slide="6">扩</span>
                    <span class="circle-num" data-slide="7">凑</span>
                    <span class="circle-num" data-slide="8">换</span>
                    <span class="circle-num" data-slide="9">分</span>
                </div>
            </h2>

            <!-- 幻灯片容器 -->
            <div class="slides-container">
                <!-- 幻灯片内容将由JavaScript动态生成 -->
            </div>
        </section>

        <!-- 习题部分 -->
        <section id="exercises" class="section">
            <h2 class="section-title"><i class="fas fa-pencil-alt"></i> 练习题</h2>

            <!-- 分类筛选 -->
            <div class="filter-section">
                <div class="filter-container">
                    <button class="filter-btn active" data-filter="all">
                        <i class="fas fa-list"></i> 全部题目 <span class="count">0</span>
                    </button>
                    <button class="filter-btn" data-filter="formula">
                        <i class="fas fa-calculator"></i> 基本积分 <span class="count">0</span>
                    </button>
                    <button class="filter-btn" data-filter="first-substitution">
                        <i class="fas fa-exchange-alt"></i> 第一类换元 <span class="count">0</span>
                    </button>
                    <button class="filter-btn" data-filter="second-substitution">
                        <i class="fas fa-random"></i> 第二类换元 <span class="count">0</span>
                    </button>
                    <button class="filter-btn" data-filter="parts">
                        <i class="fas fa-project-diagram"></i> 分部积分 <span class="count">0</span>
                    </button>
                    <button class="filter-btn" data-filter="other">
                        <i class="fas fa-infinity"></i> 其他方法 <span class="count">0</span>
                    </button>
                </div>
            </div>

            <!-- 题目定位器 -->
            <div class="locator-section">
                <div class="locator-title">
                    <i class="fas fa-search"></i>
                    <h4>题目定位</h4>
                </div>
                <div class="locator-input-container">
                    <input type="number" id="problem-number-input" min="1" placeholder="输入题号..."
                        class="problem-number-input">
                    <button id="locate-problem-btn" class="locate-problem-btn">
                        <i class="fas fa-arrow-right"></i> 定位
                    </button>
                </div>
            </div>

            <div id="exercise-container">
                <!-- 习题内容将由JavaScript动态生成 -->
            </div>
        </section>
    </div>

    <!-- 返回顶部按钮 -->
    <button class="scroll-to-top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- DeepSeek AI 对话模态框 -->
    <div id="deepseek-modal" class="deepseek-modal">
        <div class="deepseek-modal-content">
            <div class="deepseek-modal-header">
                <h2 class="deepseek-modal-title">DeepSeek AI 分析助手</h2>
                <button id="deepseek-modal-close" class="deepseek-modal-close">×</button>
            </div>
            <div id="deepseek-context" style="display: none;"></div>
            <div id="deepseek-chat-container" class="deepseek-chat-container">
                <!-- 对话内容将被动态添加 -->
            </div>
            <div class="deepseek-chat-input-container">
                <input type="text" id="deepseek-chat-input" class="deepseek-chat-input" placeholder="输入您的问题...">
                <button id="deepseek-chat-send" class="deepseek-chat-send">
                    <i class="fas fa-paper-plane"></i> 发送
                </button>
            </div>
        </div>
    </div>

    <!-- 全屏模式容器 -->
    <div id="fullscreen-overlay" class="fullscreen-overlay">
        <div class="fullscreen-header">
            <div class="fullscreen-title">不定积分习题 - 全屏展示</div>
            <div class="fullscreen-controls">
                <button id="fullscreen-solution-btn" class="fullscreen-control-btn">
                    <i class="fas fa-lightbulb"></i> 显示解析
                </button>
                <button id="fullscreen-close-btn" class="fullscreen-control-btn">
                    <i class="fas fa-times"></i> 关闭全屏
                </button>
            </div>
        </div>
        <div class="fullscreen-content">
            <div id="fullscreen-exercise" class="fullscreen-exercise">
                <!-- 习题内容将动态加载 -->
            </div>
            <div class="fullscreen-nav">
                <button id="fullscreen-prev" class="fullscreen-nav-btn">
                    <i class="fas fa-chevron-left"></i> 上一题
                </button>
                <span class="fullscreen-counter">
                    第 <span id="current-exercise">1</span> 题 / 共 <span id="total-exercises">0</span> 题
                </span>
                <button id="fullscreen-next" class="fullscreen-nav-btn">
                    下一题 <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 引入数据文件 -->
    <script src="js/indefinite-integral-data.js" charset="UTF-8"></script>

    <!-- 延迟加载MathJax -->
    <script src="../../common-assets/js/tex-mml-chtml.js" id="MathJax-script" async></script>

    <!-- 主要JavaScript代码 -->
    <script>
        // DeepSeek API 配置
        const DEEPSEEK_CONFIG = {
            API_KEY: '',
            API_URL: 'https://api.deepseek.com/v1/chat/completions',
            MODEL: 'deepseek-chat'
        };

        // 全局变量
        let currentSlide = 0;
        let totalSlides = 0;
        let fullscreenExercises = [];
        let currentFullscreenIndex = 0;
        let fullscreenState = {
            solutionVisible: false,
            visibleLines: 0,
            totalLines: 0,
            solutionLines: []
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM完全加载');

            // 初始化各个模块
            initializeApiKey();
            initializeKnowledgeSlides();
            initializeExercises();
            initializeDeepSeekModal();
            initializeEventListeners();

            // 添加返回顶部功能
            addScrollToTopButton();

            // 移动端初始化
            initMobile();

            // 延迟初始化触摸支持，确保所有元素都已创建
            setTimeout(() => {
                addTouchSupport();
            }, 500);
        });

        // 初始化API密钥功能
        function initializeApiKey() {
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const clearApiKeyBtn = document.getElementById('clear-api-key-btn');
            const apiKeyInput = document.getElementById('deepseek-api-key');
            const statusText = document.getElementById('api-key-status-text');

            // 从本地存储加载API密钥
            const savedApiKey = localStorage.getItem('deepseek_api_key');
            if (savedApiKey) {
                DEEPSEEK_CONFIG.API_KEY = savedApiKey;
                apiKeyInput.value = '••••••••••••••••••••';
                statusText.textContent = '已保存API密钥';
                statusText.className = 'api-key-valid';
                clearApiKeyBtn.style.display = 'block';
            }

            // 保存API密钥
            saveApiKeyBtn.addEventListener('click', async function () {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    statusText.textContent = '请输入有效的API密钥';
                    statusText.className = 'api-key-invalid';
                    return;
                }

                // 验证API密钥
                const isValid = await validateApiKey(apiKey);
                if (isValid) {
                    DEEPSEEK_CONFIG.API_KEY = apiKey;
                    localStorage.setItem('deepseek_api_key', apiKey);
                    apiKeyInput.value = '••••••••••••••••••••';
                    statusText.textContent = 'API密钥有效并已保存';
                    statusText.className = 'api-key-valid';
                    clearApiKeyBtn.style.display = 'block';
                } else {
                    statusText.textContent = 'API密钥无效，请检查后重试';
                    statusText.className = 'api-key-invalid';
                }
            });

            // 清除API密钥
            clearApiKeyBtn.addEventListener('click', function () {
                DEEPSEEK_CONFIG.API_KEY = '';
                localStorage.removeItem('deepseek_api_key');
                apiKeyInput.value = '';
                statusText.textContent = 'API密钥未设置';
                statusText.className = '';
                clearApiKeyBtn.style.display = 'none';
            });
        }

        // 验证API密钥
        async function validateApiKey(apiKey) {
            try {
                const response = await fetch('https://api.deepseek.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                return response.ok;
            } catch (error) {
                console.error('验证API密钥时出错:', error);
                return false;
            }
        }

        // 初始化知识点幻灯片
        function initializeKnowledgeSlides() {
            const slidesContainer = document.querySelector('.slides-container');
            if (!slidesContainer || !window.exerciseData || !window.exerciseData.knowledgePoints) return;

            totalSlides = window.exerciseData.knowledgePoints.length;

            // 创建幻灯片
            window.exerciseData.knowledgePoints.forEach((point, index) => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.id = `slide-${index}`;

                slide.innerHTML = `
                    <div class="slide-card">
                        <div class="slide-number">${index + 1}</div>
                        <div class="slide-header">
                            <h2 class="slide-title">${point.title}</h2>
                            <button class="ai-analysis-btn btn" data-knowledge-id="${index}">
                                <i class="fas fa-robot"></i> AI分析
                            </button>
                        </div>
                        <div class="slide-content">
                            ${point.content}
                        </div>
                    </div>
                `;

                slidesContainer.appendChild(slide);
            });

            // 设置第一张幻灯片为活动状态
            if (document.getElementById('slide-0')) {
                document.getElementById('slide-0').classList.add('active');
            }

            // 设置导航
            setupSlideNavigation();

            // 添加触摸支持
            if (isMobile()) {
                addTouchSupport();
            }
        }

        // 设置幻灯片导航
        function setupSlideNavigation() {
            // 圆形导航点击事件
            document.querySelectorAll('.circle-num').forEach(nav => {
                nav.addEventListener('click', function () {
                    const slideIndex = parseInt(this.getAttribute('data-slide'));
                    goToSlide(slideIndex);
                });
            });

            // 幻灯片卡片点击事件
            document.querySelectorAll('.slide-card').forEach((card, index) => {
                card.addEventListener('click', function (e) {
                    // 如果点击的是AI分析按钮，不切换幻灯片
                    if (e.target.closest('.ai-analysis-btn')) return;

                    // 切换到下一张幻灯片
                    if (currentSlide === totalSlides - 1) {
                        goToSlide(0);
                    } else {
                        goToSlide(currentSlide + 1);
                    }
                });
            });

            // 键盘事件
            document.addEventListener('keydown', function (event) {
                if (event.key === 'ArrowLeft') {
                    goToSlide(currentSlide - 1);
                } else if (event.key === 'ArrowRight' || event.key === ' ') {
                    goToSlide(currentSlide + 1);
                }
            });
        }

        // 切换到指定幻灯片
        function goToSlide(index) {
            if (index < 0) index = totalSlides - 1;
            if (index >= totalSlides) index = 0;

            // 移除当前活动状态
            document.querySelectorAll('.slide').forEach(slide => {
                slide.classList.remove('active');
            });
            document.querySelectorAll('.circle-num').forEach(nav => {
                nav.classList.remove('active');
            });

            // 设置新的活动状态
            currentSlide = index;
            document.getElementById(`slide-${index}`).classList.add('active');
            document.querySelector(`.circle-num[data-slide="${index}"]`).classList.add('active');

            // 渲染公式
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([document.getElementById(`slide-${index}`)]).catch(err => {
                    console.warn('MathJax渲染错误:', err);
                });
            }
        }

        // 初始化习题
        function initializeExercises() {
            if (!window.exerciseData || !window.exerciseData.exercises) {
                console.error('习题数据未加载');
                return;
            }

            renderExercises('all');
            updateFilterCounts();
        }

        // 渲染习题
        function renderExercises(filter) {
            const container = document.getElementById('exercise-container');
            if (!container) return;

            container.innerHTML = '';

            const filteredExercises = window.exerciseData.exercises.filter(exercise => {
                if (filter === 'all') return true;
                if (filter === 'formula') return exercise.category === '基本积分';
                if (filter === 'first-substitution') return exercise.method && exercise.method.includes('第一类换元');
                if (filter === 'second-substitution') return exercise.method && exercise.method.includes('第二类换元');
                if (filter === 'parts') return exercise.method && exercise.method.includes('分部');
                if (filter === 'other') {
                    const isFormula = exercise.category === '基本积分';
                    const isFirstSub = exercise.method && exercise.method.includes('第一类换元');
                    const isSecondSub = exercise.method && exercise.method.includes('第二类换元');
                    const isParts = exercise.method && exercise.method.includes('分部');
                    return !isFormula && !isFirstSub && !isSecondSub && !isParts;
                }
                return false;
            });

            filteredExercises.forEach(exercise => {
                const exerciseItem = createExerciseItem(exercise);
                container.appendChild(exerciseItem);
            });

            // 渲染公式
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise().catch(err => {
                    console.warn('MathJax渲染错误:', err);
                });
            }
        }

        // 创建习题项目
        function createExerciseItem(exercise) {
            const div = document.createElement('div');
            div.className = 'exercise-item';
            div.setAttribute('data-id', exercise.id);
            div.setAttribute('data-difficulty', exercise.difficulty);
            div.setAttribute('data-category', exercise.category);

            div.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-title-wrapper">
                        <div class="exercise-number">${exercise.id}</div>
                        <h3 class="exercise-title">${exercise.title}</h3>
                    </div>
                    <div class="exercise-meta">
                        <div class="exercise-type"><i class="fas fa-tag"></i> ${exercise.type}</div>
                        <div class="exercise-difficulty ${exercise.difficulty}"><i class="fas fa-signal"></i> ${getDifficultyText(exercise.difficulty)}</div>
                        <div class="exercise-category"><i class="fas fa-folder"></i> ${exercise.category}</div>
                        ${exercise.method ? `<div class="exercise-method"><i class="fas fa-cogs"></i> ${exercise.method}</div>` : ''}
                    </div>
                </div>
                <div class="exercise-content">
                    <div class="exercise-question">${exercise.question}</div>
                    <div class="exercise-actions">
                        <button class="solution-toggle btn" data-exercise-id="${exercise.id}">
                            <i class="fas fa-lightbulb"></i> 查看解析
                        </button>
                        <button class="ai-analysis-btn btn" data-exercise-id="${exercise.id}">
                            <i class="fas fa-robot"></i> AI分析
                        </button>
                        <button class="fullscreen-btn btn" data-exercise-id="${exercise.id}">
                            <i class="fas fa-expand"></i> 全屏模式
                        </button>
                    </div>
                    <div id="solution-${exercise.id}" class="solution-content">
                        <div class="solution-section">
                            <div class="explanation">
                                <h4><i class="fas fa-chalkboard-teacher"></i> 解析</h4>
                                <div class="explanation-content">${exercise.explanation}</div>
                            </div>
                            <div class="answer">
                                <h4><i class="fas fa-check-circle"></i> 答案</h4>
                                <div class="explanation-content">${exercise.answer}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // 获取难度文本
        function getDifficultyText(difficulty) {
            switch (difficulty) {
                case 'easy': return '简单';
                case 'medium': return '中等';
                case 'hard': return '困难';
                default: return '中等';
            }
        }

        // 更新筛选按钮计数
        function updateFilterCounts() {
            const exercises = window.exerciseData.exercises;
            const counts = {
                all: exercises.length,
                formula: exercises.filter(ex => ex.category === '基本积分').length,
                firstSub: exercises.filter(ex => ex.method && ex.method.includes('第一类换元')).length,
                secondSub: exercises.filter(ex => ex.method && ex.method.includes('第二类换元')).length,
                parts: exercises.filter(ex => ex.method && ex.method.includes('分部')).length,
                other: 0
            };

            // 计算其他方法数量
            counts.other = exercises.filter(ex => {
                const isFormula = ex.category === '基本积分';
                const isFirstSub = ex.method && ex.method.includes('第一类换元');
                const isSecondSub = ex.method && ex.method.includes('第二类换元');
                const isParts = ex.method && ex.method.includes('分部');
                return !isFormula && !isFirstSub && !isSecondSub && !isParts;
            }).length;

            // 更新按钮计数
            document.querySelector('.filter-btn[data-filter="all"] .count').textContent = counts.all;
            document.querySelector('.filter-btn[data-filter="formula"] .count').textContent = counts.formula;
            document.querySelector('.filter-btn[data-filter="first-substitution"] .count').textContent = counts.firstSub;
            document.querySelector('.filter-btn[data-filter="second-substitution"] .count').textContent = counts.secondSub;
            document.querySelector('.filter-btn[data-filter="parts"] .count').textContent = counts.parts;
            document.querySelector('.filter-btn[data-filter="other"] .count').textContent = counts.other;
        }

        // 初始化DeepSeek模态框
        function initializeDeepSeekModal() {
            const modal = document.getElementById('deepseek-modal');
            const closeBtn = document.getElementById('deepseek-modal-close');
            const chatInput = document.getElementById('deepseek-chat-input');
            const sendBtn = document.getElementById('deepseek-chat-send');

            // 关闭模态框
            closeBtn.addEventListener('click', function () {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            });

            // 点击模态框外部关闭
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });

            // 发送消息
            sendBtn.addEventListener('click', handleSendMessage);
            chatInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });
        }

        // 处理发送消息
        function handleSendMessage() {
            const chatInput = document.getElementById('deepseek-chat-input');
            const message = chatInput.value.trim();
            if (!message) return;

            const chatContainer = document.getElementById('deepseek-chat-container');
            const contextDiv = document.getElementById('deepseek-context');
            const context = contextDiv.textContent;

            // 添加用户消息
            const userMsg = document.createElement('div');
            userMsg.className = 'deepseek-chat-message deepseek-chat-user';
            userMsg.textContent = message;
            chatContainer.appendChild(userMsg);

            // 清空输入框
            chatInput.value = '';

            // 添加AI回复占位
            const aiMsg = document.createElement('div');
            aiMsg.className = 'deepseek-chat-message deepseek-chat-ai';
            aiMsg.innerHTML = '<div class="loading-spinner"></div> AI思考中...';
            chatContainer.appendChild(aiMsg);

            // 滚动到底部
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // 发送请求到AI
            askDeepSeek(message, context).then(response => {
                aiMsg.innerHTML = formatMarkdown(response);

                // 渲染公式
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([aiMsg]).catch(err => {
                        console.warn('MathJax渲染错误:', err);
                    });
                }

                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // 向DeepSeek API发送请求
        async function askDeepSeek(question, context = '') {
            try {
                if (!DEEPSEEK_CONFIG.API_KEY) {
                    return '请先设置您的DeepSeek API密钥再使用AI功能。';
                }

                const prompt = context ? `参考以下内容：\n${context}\n\n问题：${question}` : question;

                const response = await fetch(DEEPSEEK_CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: DEEPSEEK_CONFIG.MODEL,
                        messages: [{
                            role: "user",
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('DeepSeek API错误:', error);
                return `很抱歉，发生了错误：${error.message}`;
            }
        }

        // 格式化Markdown
        function formatMarkdown(text) {
            if (!text) return text;

            // 保护公式
            const formulas = [];
            text = text.replace(/(\$\$[\s\S]*?\$\$|\$[^\$\n]+\$)/g, function (match) {
                const placeholder = `__FORMULA_${formulas.length}__`;
                formulas.push(match);
                return placeholder;
            });

            // 处理Markdown格式
            text = text
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^\*]+)\*/g, '<em>$1</em>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');

            // 恢复公式
            formulas.forEach((formula, i) => {
                text = text.replace(`__FORMULA_${i}__`, formula);
            });

            return text;
        }

        // 打开DeepSeek模态框
        function openDeepSeekModal(content, title) {
            const modal = document.getElementById('deepseek-modal');
            const titleElement = document.querySelector('.deepseek-modal-title');
            const contextDiv = document.getElementById('deepseek-context');
            const chatContainer = document.getElementById('deepseek-chat-container');

            titleElement.textContent = title;
            contextDiv.textContent = content;
            chatContainer.innerHTML = '';

            // 添加欢迎消息
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'deepseek-chat-message deepseek-chat-ai';
            welcomeMsg.textContent = `我已经了解了"${title}"的内容。请问有什么可以帮助您的吗？`;
            chatContainer.appendChild(welcomeMsg);

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // 聚焦输入框
            setTimeout(() => {
                document.getElementById('deepseek-chat-input').focus();
            }, 300);
        }

        // 初始化事件监听器
        function initializeEventListeners() {
            // 筛选按钮
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function () {
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    const filter = this.getAttribute('data-filter');
                    renderExercises(filter);
                });
            });

            // 题目定位
            const locateBtn = document.getElementById('locate-problem-btn');
            const problemInput = document.getElementById('problem-number-input');

            locateBtn.addEventListener('click', locateProblem);
            problemInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    locateProblem();
                }
            });

            // 全局AI查询
            const globalQueryBtn = document.getElementById('global-deepseek-btn');
            const globalInput = document.getElementById('global-deepseek-input');

            globalQueryBtn.addEventListener('click', handleGlobalQuery);
            globalInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    handleGlobalQuery();
                }
            });

            // 动态事件委托
            document.addEventListener('click', function (e) {
                // 解析按钮
                if (e.target.closest('.solution-toggle')) {
                    const button = e.target.closest('.solution-toggle');
                    const exerciseId = button.getAttribute('data-exercise-id');
                    toggleSolution(exerciseId, button);
                }

                // AI分析按钮
                if (e.target.closest('.ai-analysis-btn')) {
                    const button = e.target.closest('.ai-analysis-btn');
                    const exerciseId = button.getAttribute('data-exercise-id');
                    const knowledgeId = button.getAttribute('data-knowledge-id');

                    if (exerciseId) {
                        const exercise = window.exerciseData.exercises.find(ex => ex.id == exerciseId);
                        if (exercise) {
                            const content = `题目：${exercise.question}\n\n解析：${stripHTML(exercise.explanation)}\n\n答案：${exercise.answer}`;
                            openDeepSeekModal(content, `习题${exercise.id}: ${exercise.title}`);
                        }
                    } else if (knowledgeId) {
                        const point = window.exerciseData.knowledgePoints[knowledgeId];
                        if (point) {
                            openDeepSeekModal(stripHTML(point.content), point.title);
                        }
                    }
                }

                // 全屏按钮
                if (e.target.closest('.fullscreen-btn')) {
                    const button = e.target.closest('.fullscreen-btn');
                    const exerciseId = button.getAttribute('data-exercise-id');
                    enterFullscreen(exerciseId);
                }
            });
        }

        // 切换解析显示
        function toggleSolution(exerciseId, button) {
            const solution = document.getElementById('solution-' + exerciseId);
            if (!solution) return;

            if (solution.classList.contains('show')) {
                solution.classList.remove('show');
                button.innerHTML = '<i class="fas fa-lightbulb"></i> 查看解析';
            } else {
                solution.classList.add('show');
                button.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏解析';

                // 渲染公式
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([solution]).catch(err => {
                        console.warn('MathJax渲染错误:', err);
                    });
                }
            }
        }

        // 定位题目
        function locateProblem() {
            const problemNumber = document.getElementById('problem-number-input').value.trim();
            if (!problemNumber) return;

            const problemElement = document.querySelector(`.exercise-item[data-id="${problemNumber}"]`);
            if (!problemElement) {
                alert(`未找到题号为 ${problemNumber} 的习题`);
                return;
            }

            // 显示所有题目
            document.querySelector('.filter-btn[data-filter="all"]').click();

            // 滚动到目标题目
            problemElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // 添加高亮效果
            problemElement.classList.add('highlight');
            setTimeout(() => {
                problemElement.classList.remove('highlight');
            }, 2000);
        }

        // 处理全局查询
        function handleGlobalQuery() {
            const input = document.getElementById('global-deepseek-input');
            const question = input.value.trim();
            if (!question) return;

            if (!DEEPSEEK_CONFIG.API_KEY) {
                alert('请先设置您的DeepSeek API密钥');
                return;
            }

            // 打开模态框并发送查询
            openDeepSeekModal('不定积分知识全局查询', 'DeepSeek AI 助手');

            // 设置问题并发送
            document.getElementById('deepseek-chat-input').value = question;
            document.getElementById('deepseek-chat-send').click();

            // 清空输入
            input.value = '';
        }

        // 去除HTML标签
        function stripHTML(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        // 添加返回顶部功能
        function addScrollToTopButton() {
            const button = document.querySelector('.scroll-to-top');
            if (!button) return;

            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    button.classList.add('show');
                } else {
                    button.classList.remove('show');
                }
            });

            button.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

        // 进入全屏模式
        function enterFullscreen(exerciseId) {
            const overlay = document.getElementById('fullscreen-overlay');
            const currentFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');

            // 获取当前筛选的习题列表
            fullscreenExercises = window.exerciseData.exercises.filter(exercise => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'formula') return exercise.category === '基本积分';
                if (currentFilter === 'first-substitution') return exercise.method && exercise.method.includes('第一类换元');
                if (currentFilter === 'second-substitution') return exercise.method && exercise.method.includes('第二类换元');
                if (currentFilter === 'parts') return exercise.method && exercise.method.includes('分部');
                if (currentFilter === 'other') {
                    const isFormula = exercise.category === '基本积分';
                    const isFirstSub = exercise.method && exercise.method.includes('第一类换元');
                    const isSecondSub = exercise.method && exercise.method.includes('第二类换元');
                    const isParts = exercise.method && exercise.method.includes('分部');
                    return !isFormula && !isFirstSub && !isSecondSub && !isParts;
                }
                return false;
            });

            // 找到当前习题的索引
            currentFullscreenIndex = fullscreenExercises.findIndex(ex => ex.id == exerciseId);
            if (currentFullscreenIndex === -1) currentFullscreenIndex = 0;

            // 显示全屏模式
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';

            // 更新全屏内容
            updateFullscreenContent();

            // 设置全屏控制按钮事件
            setupFullscreenControls();
        }

        // 更新全屏内容
        function updateFullscreenContent() {
            const exercise = fullscreenExercises[currentFullscreenIndex];
            const container = document.getElementById('fullscreen-exercise');

            if (!exercise) return;

            container.innerHTML = `
                <div class="exercise-header">
                    <div class="exercise-title-wrapper">
                        <div class="exercise-number">${exercise.id}</div>
                        <h3 class="exercise-title">${exercise.title}</h3>
                    </div>
                    <div class="exercise-meta">
                        <div class="exercise-type"><i class="fas fa-tag"></i> ${exercise.type}</div>
                        <div class="exercise-difficulty ${exercise.difficulty}"><i class="fas fa-signal"></i> ${getDifficultyText(exercise.difficulty)}</div>
                        <div class="exercise-category"><i class="fas fa-folder"></i> ${exercise.category}</div>
                        ${exercise.method ? `<div class="exercise-method"><i class="fas fa-cogs"></i> ${exercise.method}</div>` : ''}
                    </div>
                </div>
                <div class="exercise-question">${exercise.question}</div>
                <div id="fullscreen-solution-container" class="fullscreen-solution-container">
                    <div class="fullscreen-click-hint">点击此区域或按下方向键逐行显示解析内容</div>
                    <div id="fullscreen-solution-lines"></div>
                    <div class="fullscreen-progress">
                        <span>解析进度</span>
                        <div class="fullscreen-progress-bar">
                            <div id="fullscreen-progress-fill" class="fullscreen-progress-fill"></div>
                        </div>
                        <span id="fullscreen-progress-text">0/0</span>
                    </div>
                    <div id="fullscreen-answer" class="fullscreen-answer">
                        <div class="fullscreen-answer-title">答案</div>
                        <div>${exercise.answer}</div>
                    </div>
                </div>
            `;

            // 更新计数器
            document.getElementById('current-exercise').textContent = currentFullscreenIndex + 1;
            document.getElementById('total-exercises').textContent = fullscreenExercises.length;

            // 更新导航按钮状态
            document.getElementById('fullscreen-prev').disabled = currentFullscreenIndex === 0;
            document.getElementById('fullscreen-next').disabled = currentFullscreenIndex === fullscreenExercises.length - 1;

            // 重置状态
            fullscreenState.solutionVisible = false;
            fullscreenState.visibleLines = 0;
            fullscreenState.totalLines = 0;
            fullscreenState.solutionLines = [];

            // 准备解析内容
            prepareFullscreenSolution(exercise.explanation);

            // 渲染公式
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).catch(err => {
                    console.warn('MathJax渲染错误:', err);
                });
            }

            // 滚动到顶部
            document.querySelector('.fullscreen-content').scrollTop = 0;
        }

        // 准备全屏解析内容
        function prepareFullscreenSolution(solutionHtml) {
            // 按句号、问号、感叹号或换行符分割解析内容
            const sentences = solutionHtml
                .replace(/<\/p>/g, '</p>\n')
                .replace(/<br\s*\/?>/g, '\n')
                .split(/(?<=[。.!?])\s*|\n+/)
                .filter(sentence => {
                    const text = sentence.replace(/<[^>]*>/g, '').trim();
                    return text.length > 0;
                })
                .map(sentence => sentence.trim());

            if (sentences.length === 0 && solutionHtml.trim()) {
                sentences.push(solutionHtml);
            }

            fullscreenState.solutionLines = sentences;
            fullscreenState.totalLines = sentences.length;

            // 创建解析行元素
            const linesContainer = document.getElementById('fullscreen-solution-lines');
            if (!linesContainer) return;

            linesContainer.innerHTML = '';
            sentences.forEach((sentence, index) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'fullscreen-solution-line';
                lineDiv.innerHTML = sentence;
                lineDiv.setAttribute('data-line', index);
                lineDiv.style.display = 'none';
                linesContainer.appendChild(lineDiv);
            });

            updateFullscreenProgress();
        }

        // 显示下一行解析
        function showNextFullscreenLine(event) {
            if (!fullscreenState.solutionVisible) return;

            if (fullscreenState.visibleLines >= fullscreenState.totalLines) {
                const answerDiv = document.getElementById('fullscreen-answer');
                if (answerDiv && answerDiv.style.display === 'none') {
                    answerDiv.style.display = 'block';
                    answerDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    updateFullscreenClickHint('解析和答案已全部显示');
                }
                return;
            }

            const line = document.querySelector(`.fullscreen-solution-line[data-line="${fullscreenState.visibleLines}"]`);
            if (line) {
                line.style.display = 'block';
                fullscreenState.visibleLines++;
                updateFullscreenProgress();

                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([line]).catch(err => {
                        console.warn('MathJax渲染错误:', err);
                    });
                }

                setTimeout(() => {
                    line.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);

                if (event && event.clientX && event.clientY) {
                    addRippleEffect(event);
                }
            }
        }

        // 更新全屏进度
        function updateFullscreenProgress() {
            const progressText = document.getElementById('fullscreen-progress-text');
            const progressFill = document.getElementById('fullscreen-progress-fill');

            if (progressText) {
                progressText.textContent = `${fullscreenState.visibleLines}/${fullscreenState.totalLines}`;
            }

            if (progressFill) {
                const percent = fullscreenState.totalLines > 0
                    ? (fullscreenState.visibleLines / fullscreenState.totalLines) * 100
                    : 0;
                progressFill.style.width = `${percent}%`;
            }

            updateFullscreenClickHint();
        }

        // 更新点击提示
        function updateFullscreenClickHint(customText) {
            const hint = document.querySelector('.fullscreen-click-hint');
            if (!hint) return;

            if (customText) {
                hint.textContent = customText;
            } else if (fullscreenState.visibleLines === 0) {
                hint.textContent = '点击此区域或按下方向键显示第一行';
            } else if (fullscreenState.visibleLines >= fullscreenState.totalLines) {
                hint.textContent = '点击继续显示答案';
            } else {
                hint.textContent = `点击此区域或按下方向键显示下一行 (${fullscreenState.visibleLines}/${fullscreenState.totalLines})`;
            }
        }

        // 添加波纹效果
        function addRippleEffect(event) {
            if (!event || !event.clientX || !event.clientY) return;

            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.left = event.clientX + 'px';
            ripple.style.top = event.clientY + 'px';
            document.body.appendChild(ripple);

            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // 设置全屏控制
        function setupFullscreenControls() {
            // 关闭按钮
            const closeBtn = document.getElementById('fullscreen-close-btn');
            closeBtn.onclick = function () {
                document.getElementById('fullscreen-overlay').classList.remove('show');
                document.body.style.overflow = '';
            };

            // 解析按钮
            const solutionBtn = document.getElementById('fullscreen-solution-btn');
            solutionBtn.onclick = function () {
                const container = document.getElementById('fullscreen-solution-container');
                if (!fullscreenState.solutionVisible) {
                    container.style.display = 'block';
                    this.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏解析';
                    fullscreenState.solutionVisible = true;

                    fullscreenState.visibleLines = 0;
                    document.querySelectorAll('.fullscreen-solution-line').forEach(line => {
                        line.style.display = 'none';
                    });
                    document.getElementById('fullscreen-answer').style.display = 'none';

                    updateFullscreenProgress();
                    updateFullscreenClickHint('点击此区域或按下方向键显示第一行');
                } else {
                    container.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-lightbulb"></i> 显示解析';
                    fullscreenState.solutionVisible = false;
                }
            };

            // 点击容器显示下一行
            const solutionContainer = document.getElementById('fullscreen-solution-container');
            if (solutionContainer) {
                solutionContainer.addEventListener('click', function (e) {
                    if (e.target.closest('.fullscreen-progress') ||
                        e.target.closest('#fullscreen-solution-btn')) return;

                    if (fullscreenState.solutionVisible) {
                        showNextFullscreenLine(e);
                    }
                });
            }

            // 全屏内容区域点击事件
            const fullscreenContent = document.querySelector('.fullscreen-content');
            if (fullscreenContent) {
                fullscreenContent.addEventListener('click', function (e) {
                    if (e.target === this) {
                        if (!fullscreenState.solutionVisible) {
                            document.getElementById('fullscreen-solution-btn').click();
                            setTimeout(() => {
                                showNextFullscreenLine(e);
                            }, 100);
                        } else {
                            showNextFullscreenLine(e);
                        }
                    }
                });
            }

            // 上一题按钮
            const prevBtn = document.getElementById('fullscreen-prev');
            prevBtn.onclick = function () {
                if (currentFullscreenIndex > 0) {
                    currentFullscreenIndex--;
                    updateFullscreenContent();
                }
            };

            // 下一题按钮
            const nextBtn = document.getElementById('fullscreen-next');
            nextBtn.onclick = function () {
                if (currentFullscreenIndex < fullscreenExercises.length - 1) {
                    currentFullscreenIndex++;
                    updateFullscreenContent();
                }
            };

            // 键盘控制
            document.addEventListener('keydown', handleFullscreenKeyboard);
        }

        // 处理全屏模式键盘事件
        function handleFullscreenKeyboard(e) {
            const overlay = document.getElementById('fullscreen-overlay');
            if (!overlay.classList.contains('show')) return;

            if (e.key === 'Escape') {
                overlay.classList.remove('show');
                document.body.style.overflow = '';
                document.removeEventListener('keydown', handleFullscreenKeyboard);
            } else if (e.key === 'ArrowLeft') {
                if (currentFullscreenIndex > 0) {
                    currentFullscreenIndex--;
                    updateFullscreenContent();
                }
            } else if (e.key === 'ArrowRight') {
                if (currentFullscreenIndex < fullscreenExercises.length - 1) {
                    currentFullscreenIndex++;
                    updateFullscreenContent();
                }
            } else if (e.key === ' ' || e.key === 'ArrowDown') {
                e.preventDefault();

                if (!fullscreenState.solutionVisible) {
                    document.getElementById('fullscreen-solution-btn').click();
                    setTimeout(() => {
                        showNextFullscreenLine();
                    }, 100);
                } else {
                    showNextFullscreenLine();
                }
            }
        }

        // 移动端检测
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                || window.innerWidth <= 768;
        }

        // 移动端初始化
        function initMobile() {
            if (!isMobile()) return;

            document.body.classList.add('mobile');

            const touchTargets = document.querySelectorAll('button, .filter-btn, .circle-num');
            touchTargets.forEach(target => {
                target.style.minHeight = '44px';
                target.style.minWidth = '44px';
            });
        }

        // 添加触摸支持
        function addTouchSupport() {
            const slidesContainer = document.querySelector('.slides-container');
            if (!slidesContainer) return;

            let startX = 0;
            let startY = 0;
            let distX = 0;
            let distY = 0;

            slidesContainer.addEventListener('touchstart', function (e) {
                startX = e.touches[0].pageX;
                startY = e.touches[0].pageY;
            }, { passive: true });

            slidesContainer.addEventListener('touchmove', function (e) {
                distX = e.touches[0].pageX - startX;
                distY = e.touches[0].pageY - startY;
            }, { passive: true });

            slidesContainer.addEventListener('touchend', function (e) {
                if (Math.abs(distX) > Math.abs(distY) && Math.abs(distX) > 50) {
                    if (distX > 0) {
                        goToSlide(currentSlide - 1);
                    } else {
                        goToSlide(currentSlide + 1);
                    }
                }

                startX = 0;
                startY = 0;
                distX = 0;
                distY = 0;
            }, { passive: true });

            // 为全屏模式添加触摸支持
            const fullscreenContent = document.querySelector('.fullscreen-content');
            if (fullscreenContent) {
                let fsStartY = 0;
                let fsDistY = 0;

                fullscreenContent.addEventListener('touchstart', function (e) {
                    fsStartY = e.touches[0].pageY;
                }, { passive: true });

                fullscreenContent.addEventListener('touchmove', function (e) {
                    fsDistY = e.touches[0].pageY - fsStartY;
                }, { passive: true });

                fullscreenContent.addEventListener('touchend', function (e) {
                    if (fsDistY < -50 && fullscreenState.solutionVisible) {
                        showNextFullscreenLine();
                    }

                    fsStartY = 0;
                    fsDistY = 0;
                }, { passive: true });
            }
        }

        // PDF导出功能
        function exportPDF() {
            console.log('开始导出PDF');

            if (!window.exerciseData) {
                alert('数据未加载完成，请稍后再试');
                return;
            }

            // 创建打印内容容器
            const printDiv = document.createElement('div');
            printDiv.id = 'print-content';
            printDiv.style.display = 'none';
            document.body.appendChild(printDiv);

            // 构建标题
            const title = document.createElement('h1');
            title.textContent = '不定积分知识点整理';
            title.style.textAlign = 'center';
            printDiv.appendChild(title);

            // 添加日期
            const date = document.createElement('p');
            date.textContent = '生成日期：' + new Date().toLocaleDateString('zh-CN');
            date.style.textAlign = 'center';
            printDiv.appendChild(date);

            // 添加知识点
            const knowledgeTitle = document.createElement('h2');
            knowledgeTitle.textContent = '知识点总结';
            printDiv.appendChild(knowledgeTitle);

            window.exerciseData.knowledgePoints.forEach((point, index) => {
                const pointDiv = document.createElement('div');
                pointDiv.className = 'exercise-print';
                pointDiv.innerHTML = `
                    <h3>${index + 1}. ${point.title}</h3>
                    <div>${point.content}</div>
                `;
                printDiv.appendChild(pointDiv);
            });

            // 添加习题
            const exerciseTitle = document.createElement('h2');
            exerciseTitle.textContent = '习题与解析';
            printDiv.appendChild(exerciseTitle);

            window.exerciseData.exercises.forEach(exercise => {
                const exDiv = document.createElement('div');
                exDiv.className = 'exercise-print';
                exDiv.innerHTML = `
                    <h3>题目 ${exercise.id}：${exercise.title}</h3>
                    <p><strong>类型：</strong>${exercise.type} | ${getDifficultyText(exercise.difficulty)} | ${exercise.category}</p>
                    <p><strong>题目：</strong>${exercise.question}</p>
                    <p><strong>解析：</strong>${exercise.explanation}</p>
                    <p><strong>答案：</strong>${exercise.answer}</p>
                `;
                printDiv.appendChild(exDiv);
            });

            // 显示打印内容并打印
            printDiv.style.display = 'block';

            // 渲染数学公式后打印
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([printDiv]).then(() => {
                    window.print();
                    setTimeout(() => printDiv.remove(), 1000);
                });
            } else {
                window.print();
                setTimeout(() => printDiv.remove(), 1000);
            }
        }

        // 确保函数在全局作用域
        window.exportPDF = exportPDF;
        window.goToSlide = goToSlide;
    </script>
</body>

</html>
